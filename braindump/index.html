<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brain-Dump â€“ Uni Hyper Notes</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #161821;
  --surface:   #1e2135;
  --surface2:  #252840;
  --border:    rgba(255,255,255,0.07);
  --border-h:  rgba(255,255,255,0.14);
  --text:      #f0f0ff;
  --muted:     rgba(240,240,255,0.45);
  --dim:       rgba(240,240,255,0.22);
  --accent:    #7b8cff;
  --accent-s:  rgba(123,140,255,0.18);
  --success:   #34d399;
  --release:   #a78bfa;
  --radius:    18px;
  --radius-s:  12px;
  --bg-tint:   transparent;
  --c-idee:       #a78bfa;
  --c-stress:     #fb7185;
  --c-frage:      #fbbf24;
  --c-todo:       #34d399;
  --c-erkenntnis: #38bdf8;
}
body.light {
  --bg: #f0f1fa; --surface: #ffffff; --surface2: #f5f5fc;
  --border: rgba(0,0,0,0.08); --border-h: rgba(0,0,0,0.15);
  --text: #1a1c2e; --muted: rgba(26,28,46,0.5); --dim: rgba(26,28,46,0.28);
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
body.light ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 14px;
  overflow-x: hidden;
  position: relative;
}
/* mood tint overlay */
body::before {
  content: "";
  position: fixed; inset: 0;
  background: var(--bg-tint);
  pointer-events: none; z-index: 0;
  transition: background 1.4s ease;
}

/* â”€â”€ Orbs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orb {
  position: fixed; border-radius: 50%;
  pointer-events: none; z-index: 0;
  filter: blur(80px); opacity: 0.08; will-change: transform;
}
body.light .orb { opacity: 0.055; }
.orb-1 { width: 560px; height: 560px; top: -180px; right: -180px; }
.orb-2 { width: 420px; height: 420px; bottom: -100px; left: -140px; }
.orb-3 { width: 280px; height: 280px; top: 40%; left: 30%; }

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page { position: relative; z-index: 1; max-width: 680px; margin: 0 auto; padding: 28px 20px 100px; }

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; margin-bottom: 16px; transition: border-color 0.35s, box-shadow 0.5s; }

/* â”€â”€ Memory card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.memory-card {
  background: linear-gradient(135deg, var(--surface), rgba(167,139,250,0.07));
  border: 1px solid rgba(167,139,250,0.22);
  border-radius: var(--radius);
  padding: 18px 20px;
  margin-bottom: 16px;
  animation: memoryIn 0.55s cubic-bezier(.34,1.56,.64,1);
  position: relative; overflow: hidden;
}
.memory-card::before {
  content: "";
  position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
  background: var(--release); border-radius: 4px 0 0 4px;
}
@keyframes memoryIn {
  from { opacity: 0; transform: translateY(-16px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.memory-card.leaving { animation: memoryOut 0.4s ease forwards; }
@keyframes memoryOut {
  to { opacity: 0; transform: translateY(-12px) scale(0.97); max-height: 0; padding: 0; margin: 0; }
}
.memory-label { font-size: 11.5px; color: var(--release); font-weight: 600; letter-spacing: 0.3px; margin-bottom: 6px; }
.memory-ago   { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
.memory-text  { font-size: 13.5px; line-height: 1.6; color: var(--text); white-space: pre-wrap; word-break: break-word; margin-bottom: 12px; }
.memory-footer { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.memory-mood  { font-size: 16px; }
.memory-chips { display: flex; gap: 5px; flex: 1; flex-wrap: wrap; }
.memory-chip  { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(167,139,250,0.3); color: var(--release); background: rgba(167,139,250,0.08); }
.memory-dismiss {
  padding: 6px 14px; border-radius: 999px; border: 1px solid var(--border);
  background: transparent; color: var(--muted); font-size: 12px; cursor: pointer;
  transition: all 0.18s ease; outline: none; margin-left: auto;
}
.memory-dismiss:hover { background: rgba(255,255,255,0.08); color: var(--text); transform: translateY(-1px); }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.brain-header { display: flex; align-items: center; gap: 14px; margin-bottom: 20px; }
.brain-icon-wrap {
  width: 48px; height: 48px; border-radius: 14px; flex-shrink: 0;
  background: linear-gradient(135deg, rgba(123,140,255,0.28), rgba(167,139,250,0.16));
  border: 1px solid rgba(123,140,255,0.28);
  display: flex; align-items: center; justify-content: center; font-size: 22px;
  animation: iconBreathe 5s ease-in-out infinite;
}
@keyframes iconBreathe {
  0%,100% { box-shadow: 0 0 0 rgba(123,140,255,0); transform: scale(1); }
  50%      { box-shadow: 0 0 22px rgba(123,140,255,0.22); transform: scale(1.04); }
}
.brain-title    { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; }
.brain-subtitle { font-size: 12.5px; color: var(--muted); margin-top: 3px; }
.streak-badge {
  margin-left: auto; display: flex; align-items: center; gap: 5px;
  font-size: 12px; font-weight: 600; padding: 5px 11px; border-radius: 999px;
  background: rgba(251,191,36,0.12); border: 1px solid rgba(251,191,36,0.3); color: #fbbf24;
  cursor: default; animation: streakPulse 4s ease-in-out infinite;
}
.streak-badge:hover { transform: scale(1.08); }
@keyframes streakPulse {
  0%,100% { box-shadow: 0 0 0 rgba(251,191,36,0); }
  50%      { box-shadow: 0 0 12px rgba(251,191,36,0.22); }
}

/* â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tags-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.tag-btn {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 12.5px; font-weight: 500; padding: 6px 14px; border-radius: 999px;
  border: 1px solid var(--border); background: transparent; color: var(--muted);
  cursor: pointer; transition: all 0.18s ease; user-select: none; outline: none;
}
.tag-btn:hover { border-color: var(--border-h); color: var(--text); transform: translateY(-1px); }
.tag-btn.active { animation: tagBounce 0.3s cubic-bezier(.34,1.56,.64,1); }
.tag-btn[data-tag="Idee"].active       { border-color: var(--c-idee);       color: var(--c-idee);       background: rgba(167,139,250,0.12); }
.tag-btn[data-tag="Stress"].active     { border-color: var(--c-stress);     color: var(--c-stress);     background: rgba(251,113,133,0.12); }
.tag-btn[data-tag="Frage"].active      { border-color: var(--c-frage);      color: var(--c-frage);      background: rgba(251,191,36,0.12);  }
.tag-btn[data-tag="To-do"].active      { border-color: var(--c-todo);       color: var(--c-todo);       background: rgba(52,211,153,0.12);  }
.tag-btn[data-tag="Erkenntnis"].active { border-color: var(--c-erkenntnis); color: var(--c-erkenntnis); background: rgba(56,189,248,0.12);  }
@keyframes tagBounce {
  0% { transform: scale(1); } 40% { transform: scale(1.18) translateY(-3px); }
  70% { transform: scale(0.96); } 100% { transform: scale(1) translateY(-1px); }
}

/* â”€â”€ Textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.textarea-wrap { position: relative; }
#brainText {
  width: 100%; min-height: 118px; max-height: 440px;
  resize: none; overflow: hidden;
  background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-s);
  padding: 14px 16px 30px; color: var(--text); font-family: inherit; font-size: 14px; line-height: 1.7;
  box-sizing: border-box; outline: none; transition: border-color 0.25s, box-shadow 0.25s;
}
#brainText::placeholder { color: var(--dim); }
#brainText:focus { border-color: rgba(123,140,255,0.5); box-shadow: 0 0 0 3px rgba(123,140,255,0.1); }
#brainText.shake { animation: shake 0.42s ease; }
@keyframes shake {
  0%,100% { transform: translateX(0); }
  18%,54% { transform: translateX(-7px); }
  36%,72% { transform: translateX(7px); }
  90%     { transform: translateX(-3px); }
}
.word-counter { position: absolute; bottom: 10px; right: 13px; font-size: 11px; color: var(--dim); pointer-events: none; opacity: 0; transition: opacity 0.25s; }
.word-counter.visible { opacity: 1; }

/* dissolve overlay - exact same padding/font as textarea */
#dissolveOverlay {
  display: none; position: absolute; inset: 0;
  padding: 14px 16px 30px;
  font-size: 14px; line-height: 1.7; color: var(--text);
  pointer-events: none; z-index: 10;
  white-space: pre-wrap; word-break: break-word;
  border-radius: var(--radius-s);
}
@keyframes charDissolve {
  0%   { opacity: 1; transform: translate(0,0) rotate(0deg) scale(1); }
  100% { opacity: 0; transform: translate(var(--tx),var(--ty)) rotate(var(--rot)) scale(0.2); }
}

/* â”€â”€ Mood â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mood-row { display: flex; align-items: center; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
.mood-label { font-size: 12.5px; color: var(--muted); flex-shrink: 0; }
.mood-btns { display: flex; gap: 4px; }
.mood-btn {
  font-size: 22px; width: 44px; height: 44px; border-radius: 50%;
  border: 2px solid transparent; background: transparent; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s cubic-bezier(.34,1.56,.64,1), opacity 0.2s, border-color 0.2s, background 0.2s;
  opacity: 0.45; outline: none; padding: 0;
}
.mood-btn:hover { opacity: 0.8; transform: scale(1.25) translateY(-4px); }
.mood-btn.active { opacity: 1; border-color: rgba(255,255,255,0.22); background: rgba(255,255,255,0.09); transform: scale(1.18) translateY(-2px); animation: moodPop 0.32s cubic-bezier(.34,1.56,.64,1); }
@keyframes moodPop { 0% { transform: scale(1); } 55% { transform: scale(1.38) translateY(-5px); } 100% { transform: scale(1.18) translateY(-2px); } }
body.light .mood-btn.active { background: rgba(0,0,0,0.07); border-color: rgba(0,0,0,0.18); }
/* Mood-specific glow when active */
.mood-btn[data-mood="1"].active { box-shadow: 0 0 18px rgba(74,111,175,0.55); }
.mood-btn[data-mood="2"].active { box-shadow: 0 0 18px rgba(139,92,246,0.55); }
.mood-btn[data-mood="3"].active { box-shadow: 0 0 18px rgba(123,140,255,0.5); }
.mood-btn[data-mood="4"].active { box-shadow: 0 0 18px rgba(245,158,11,0.6); }
.mood-btn[data-mood="5"].active { box-shadow: 0 0 22px rgba(6,182,212,0.6); }

/* â”€â”€ Save row â€” two buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.save-row { display: flex; align-items: center; gap: 10px; margin-top: 18px; flex-wrap: wrap; }
.btn-keep {
  padding: 10px 22px; border-radius: 999px;
  border: 1px solid rgba(123,140,255,0.32);
  background: rgba(123,140,255,0.1);
  color: var(--accent); font-size: 13px; font-weight: 600; cursor: pointer;
  transition: all 0.2s ease; outline: none; position: relative; overflow: hidden;
}
.btn-keep:hover { background: rgba(123,140,255,0.2); box-shadow: 0 4px 18px rgba(123,140,255,0.22); color: var(--text); transform: translateY(-1px); }
.btn-keep:active { transform: scale(0.97); }
.btn-release {
  padding: 10px 22px; border-radius: 999px;
  border: 1px solid rgba(167,139,250,0.4);
  background: linear-gradient(135deg, rgba(123,140,255,0.22), rgba(167,139,250,0.14));
  color: var(--release); font-size: 14px; font-weight: 600; cursor: pointer;
  transition: all 0.22s ease; outline: none; position: relative; overflow: hidden;
}
.btn-release:hover { background: linear-gradient(135deg, rgba(123,140,255,0.36), rgba(167,139,250,0.26)); box-shadow: 0 5px 22px rgba(167,139,250,0.3); transform: translateY(-2px); }
.btn-release:active { transform: scale(0.96); }
.btn-release.glowing { animation: releaseGlow 2.4s ease-in-out infinite; }
@keyframes releaseGlow { 0%,100% { box-shadow: 0 0 0 rgba(167,139,250,0); } 50% { box-shadow: 0 0 26px rgba(167,139,250,0.4); } }
.save-hints { margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap; }
.hint-tag { font-size: 11px; color: var(--dim); }
.hint-tag.release-hint { color: rgba(167,139,250,0.55); }
.ripple { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.3); transform: scale(0); pointer-events: none; animation: rippleGrow 0.55s ease-out forwards; }
@keyframes rippleGrow { to { transform: scale(5); opacity: 0; } }
.affirm-msg { font-size: 13px; color: var(--success); font-weight: 500; opacity: 0; margin-top: 10px; display: block; }
.affirm-msg.show { animation: affirmPop 2.8s ease forwards; }
@keyframes affirmPop {
  0% { opacity:0; transform: translateY(6px) scale(0.9); }
  12% { opacity:1; transform: translateY(0) scale(1.05); }
  20% { transform: scale(1); } 75% { opacity:1; } 100% { opacity:0; }
}

/* â”€â”€ Triage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.triage-panel { display:none; border: 1px solid rgba(123,140,255,0.22); background: linear-gradient(135deg,var(--surface),rgba(123,140,255,0.05)); border-radius: var(--radius); padding: 20px 22px; margin-bottom: 16px; }
.triage-panel.visible { display:block; animation: triageIn 0.38s cubic-bezier(.34,1.56,.64,1); }
@keyframes triageIn { from{opacity:0;transform:translateY(-14px) scale(0.96);}to{opacity:1;transform:translateY(0) scale(1);} }
.triage-title { font-size: 15px; font-weight: 700; margin-bottom: 5px; }
.triage-sub   { font-size: 12.5px; color: var(--muted); margin-bottom: 16px; }
.triage-btns  { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; }
.triage-btn {
  padding: 12px 18px; border-radius: var(--radius-s);
  border: 1px solid var(--border); background: rgba(255,255,255,0.04);
  color: var(--text); font-size: 13px; font-weight: 500; cursor: pointer;
  transition: all 0.18s; outline: none; min-height: 48px;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.triage-btn:hover { background:rgba(255,255,255,0.1); transform:translateY(-2px); border-color: var(--border-h); }
.triage-btn:active { transform: scale(0.97); }
.triage-release {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, rgba(52,211,153,0.12), rgba(52,211,153,0.07));
  border-color: rgba(52,211,153,0.4); color: var(--success);
  font-size: 14px; font-weight: 600;
  animation: triageRelGlow 2.8s ease-in-out infinite;
}
.triage-release:hover { background: linear-gradient(135deg, rgba(52,211,153,0.22), rgba(52,211,153,0.14)); transform: translateY(-2px); box-shadow: 0 6px 22px rgba(52,211,153,0.18); }
@keyframes triageRelGlow { 0%,100%{box-shadow:0 0 0 rgba(52,211,153,0);}50%{box-shadow:0 0 18px rgba(52,211,153,0.2);} }

/* â”€â”€ History toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.history-toolbar { display:flex; gap:10px; align-items:center; margin-bottom:18px; flex-wrap:wrap; }
.history-title { font-size:16px; font-weight:700; flex:1; min-width:100px; }
.search-wrap { position:relative; flex:1; min-width:140px; max-width:200px; }
.search-ico { position:absolute; left:11px; top:50%; transform:translateY(-50%); font-size:13px; pointer-events:none; opacity:0.4; }
.search-input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:999px; padding:7px 12px 7px 32px; color:var(--text); font-family:inherit; font-size:12.5px; outline:none; transition:border-color 0.2s,box-shadow 0.2s; }
.search-input:focus { border-color:rgba(123,140,255,0.4); box-shadow:0 0 0 3px rgba(123,140,255,0.08); }
.filter-pills { display:flex; gap:5px; flex-wrap:wrap; }
.filter-pill { padding:5px 11px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted); font-size:12px; cursor:pointer; transition:all 0.18s; outline:none; }
.filter-pill:hover { border-color:var(--border-h); color:var(--text); transform:translateY(-1px); }
.filter-pill.active { background:var(--accent-s); border-color:var(--accent); color:var(--accent); }
.view-toggle { padding:5px 11px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted); font-size:12px; cursor:pointer; transition:all 0.18s; outline:none; flex-shrink:0; }
.view-toggle:hover { border-color:var(--border-h); color:var(--text); }
.view-toggle.active { background:var(--accent-s); border-color:var(--accent); color:var(--accent); }

/* hidden-count banner */
.hidden-banner {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; border-radius: 10px; margin-bottom: 12px;
  background: rgba(167,139,250,0.08); border: 1px solid rgba(167,139,250,0.18);
  font-size: 12.5px; color: rgba(167,139,250,0.85);
  animation: entryIn 0.4s ease;
}
.hidden-banner span { flex: 1; }

/* â”€â”€ Entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.entry {
  border-radius: var(--radius-s); border: 1px solid var(--border);
  padding: 13px 14px 13px 20px; margin-bottom: 10px;
  background: var(--surface2); position: relative; overflow: hidden;
  transition: border-color 0.25s, box-shadow 0.35s, transform 0.2s; will-change: transform;
  animation: entryIn 0.38s ease both;
  box-shadow: 0 2px 10px rgba(0,0,0,0.18), 0 1px 3px rgba(0,0,0,0.12);
}
.entry::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--accent); border-radius:4px 0 0 4px; opacity:0.55; transition:opacity 0.2s,width 0.2s; }
.entry:hover { border-color:var(--border-h); box-shadow:0 10px 36px rgba(0,0,0,0.28), 0 2px 8px rgba(0,0,0,0.16); }
.entry:hover::before { opacity:1; width:5px; }

/* Ambient tag glow â€” subtle background tint per tag */
.entry[data-primary="Idee"]       { background: linear-gradient(150deg, rgba(167,139,250,0.09) 0%, var(--surface2) 45%); }
.entry[data-primary="Stress"]     { background: linear-gradient(150deg, rgba(251,113,133,0.09) 0%, var(--surface2) 45%); }
.entry[data-primary="Frage"]      { background: linear-gradient(150deg, rgba(251,191,36, 0.08) 0%, var(--surface2) 45%); }
.entry[data-primary="To-do"]      { background: linear-gradient(150deg, rgba(52,211,153, 0.08) 0%, var(--surface2) 45%); }
.entry[data-primary="Erkenntnis"] { background: linear-gradient(150deg, rgba(56,189,248, 0.09) 0%, var(--surface2) 45%); }
.entry[data-primary="Idee"]::before       { background:var(--c-idee); }
.entry[data-primary="Stress"]::before     { background:var(--c-stress); }
.entry[data-primary="Frage"]::before      { background:var(--c-frage); }
.entry[data-primary="To-do"]::before      { background:var(--c-todo); }
.entry[data-primary="Erkenntnis"]::before { background:var(--c-erkenntnis); }

/* unlocked / released entries */
.entry.unlocked {
  background: linear-gradient(135deg, var(--surface2), rgba(167,139,250,0.06));
  border-color: rgba(167,139,250,0.2);
  animation: unlockReveal 0.7s cubic-bezier(.34,1.56,.64,1) both;
}
.entry.unlocked::before { background: var(--release); }
@keyframes unlockReveal {
  from { opacity:0; transform:translateY(20px) scale(0.95); box-shadow:0 0 30px rgba(167,139,250,0.3); }
  to   { opacity:1; transform:translateY(0) scale(1); box-shadow:none; }
}
.unlock-label { font-size:11px; color:var(--release); margin-top:9px; opacity:0.75; display:flex; align-items:center; gap:5px; }

@keyframes entryIn { from{opacity:0;transform:translateY(16px) scale(0.98);}to{opacity:1;transform:translateY(0) scale(1);} }
.entry.removing { animation: entryOut 0.32s ease forwards; }
@keyframes entryOut { to{opacity:0;transform:translateX(20px) scale(0.95);max-height:0;padding:0;margin:0;border-width:0;} }
.entry-meta { display:flex; align-items:center; gap:7px; flex-wrap:wrap; margin-bottom:8px; }
.entry-date  { font-size:11px; color:var(--dim); cursor:default; }
.entry-date:hover { color:var(--muted); }
.entry-mood  { font-size:16px; line-height:1; }
.entry-chip  { font-size:11px; font-weight:500; padding:2px 9px; border-radius:999px; border:1px solid rgba(255,255,255,0.1); color:var(--muted); }
.entry-chip[data-tag="Idee"]       { border-color:rgba(167,139,250,0.4);color:var(--c-idee);      background:rgba(167,139,250,0.09);}
.entry-chip[data-tag="Stress"]     { border-color:rgba(251,113,133,0.4);color:var(--c-stress);    background:rgba(251,113,133,0.09);}
.entry-chip[data-tag="Frage"]      { border-color:rgba(251,191,36,0.4); color:var(--c-frage);     background:rgba(251,191,36,0.09);}
.entry-chip[data-tag="To-do"]      { border-color:rgba(52,211,153,0.4); color:var(--c-todo);      background:rgba(52,211,153,0.09);}
.entry-chip[data-tag="Erkenntnis"] { border-color:rgba(56,189,248,0.4); color:var(--c-erkenntnis);background:rgba(56,189,248,0.09);}
.entry-text { font-size:14px; line-height:1.68; white-space:pre-wrap; word-break:break-word; color:var(--text); font-weight:400; }
.entry-del { position:absolute; right:10px; top:50%; transform:translateY(-50%); width:28px; height:28px; border-radius:50%; border:1px solid transparent; background:transparent; color:var(--muted); font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.18s,background 0.18s,color 0.18s,transform 0.18s; outline:none; }
.entry:hover .entry-del { opacity:0.5; }
.entry-del:hover { opacity:1 !important; background:rgba(251,113,133,0.15); color:var(--c-stress); border-color:rgba(251,113,133,0.3); transform:translateY(-50%) scale(1.1); }

/* â”€â”€ History scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#historyCard { position: relative; }
#historyListWrap {
  position: relative;
  max-height: 560px;
  overflow: hidden;
}
#historyList {
  max-height: 560px;
  overflow-y: auto;
  padding-right: 2px;
  scroll-behavior: smooth;
}
#historyList::-webkit-scrollbar { width: 4px; }
#historyList::-webkit-scrollbar-track { background: transparent; }
#historyList::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.13); border-radius: 4px; }
body.light #historyList::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); }
#historyListWrap::after {
  content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 56px;
  background: linear-gradient(to bottom, transparent, var(--surface));
  pointer-events: none; border-radius: 0 0 var(--radius) var(--radius);
  z-index: 2;
}
body.light #historyListWrap::after { background: linear-gradient(to bottom, transparent, #ffffff); }

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state { text-align:center; padding:44px 20px; animation:entryIn 0.5s ease; }
.empty-icon  { font-size:42px; margin-bottom:14px; display:block; opacity:0.5; animation:emptyFloat 4s ease-in-out infinite; }
@keyframes emptyFloat { 0%,100%{transform:translateY(0);}50%{transform:translateY(-7px);} }
.empty-title { font-size:14px; font-weight:600; color:var(--muted); margin-bottom:6px; }
.empty-sub   { font-size:12.5px; color:var(--dim); line-height:1.6; }

/* â”€â”€ Galaxy canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#galaxyWrap { display:none; position:relative; border-radius:var(--radius-s); overflow:hidden; background:var(--surface2); border:1px solid var(--border); }
#galaxyCanvas { display:block; width:100%; cursor:crosshair; }
.galaxy-tooltip {
  display:none; position:absolute; z-index:20;
  background:var(--surface); border:1px solid var(--border-h);
  border-radius:10px; padding:10px 13px; max-width:220px; pointer-events:none;
  box-shadow:0 8px 24px rgba(0,0,0,0.25);
}
.gt-date  { font-size:11px; color:var(--muted); margin-bottom:5px; }
.gt-text  { font-size:12.5px; line-height:1.55; color:var(--text); }
.gt-mood  { font-size:15px; margin-top:5px; }

/* â”€â”€ Breath widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.breath-btn {
  position: fixed; bottom: 24px; right: 24px; z-index: 100;
  width: 46px; height: 46px; border-radius: 50%;
  border: 1px solid rgba(123,140,255,0.3);
  background: rgba(30,33,53,0.9); backdrop-filter: blur(8px);
  color: var(--muted); font-size: 20px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.22s ease; outline: none;
  animation: breathBtnPulse 5s ease-in-out infinite;
}
.breath-btn:hover { border-color: rgba(123,140,255,0.6); color: var(--text); transform: scale(1.08); }
@keyframes breathBtnPulse { 0%,100%{box-shadow:0 0 0 rgba(123,140,255,0);}50%{box-shadow:0 0 14px rgba(123,140,255,0.18);} }
body.light .breath-btn { background: rgba(255,255,255,0.9); }

.breath-overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(10,11,20,0.88); backdrop-filter: blur(12px);
  align-items: center; justify-content: center; flex-direction: column; gap: 24px;
}
.breath-overlay.visible { display: flex; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from{opacity:0;}to{opacity:1;} }
.breath-close { position:absolute; top:24px; right:28px; font-size:22px; cursor:pointer; color:var(--muted); background:none; border:none; outline:none; transition:color 0.18s; }
.breath-close:hover { color:var(--text); }
.breath-instruction { font-size:18px; font-weight:600; color:var(--text); text-align:center; min-height:28px; transition:opacity 0.5s; }
.breath-ring-wrap { position:relative; width:180px; height:180px; display:flex; align-items:center; justify-content:center; }
.breath-ring-outer {
  position:absolute; inset:0; border-radius:50%;
  border: 2px solid rgba(123,140,255,0.2);
  transform: scale(1);
  transition: transform 0s, border-color 0.6s;
}
.breath-ring-inner {
  width:80px; height:80px; border-radius:50%;
  background: radial-gradient(circle, rgba(123,140,255,0.4), rgba(123,140,255,0.1));
  border: 1px solid rgba(123,140,255,0.5);
  transition: transform 0s;
  transform: scale(1);
}
.breath-count { font-size:28px; font-weight:700; color:var(--accent); position:absolute; }
.breath-sub   { font-size:13px; color:var(--muted); text-align:center; }

/* â”€â”€ Floating effects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.particle,.sparkle,.confetti-star { position:fixed; pointer-events:none; z-index:9999; }
.particle { border-radius:50%; transform:translate(-50%,-50%); }
.sparkle  { transform:translate(-50%,-50%); }
.confetti-star { font-size:18px; top:-30px; animation:starFall linear forwards; }
@keyframes starFall { to{transform:translateY(110vh) rotate(540deg);opacity:0;} }

#inputCard { transition:border-color 0.4s,box-shadow 0.5s; }
#inputCard.typing { border-color:rgba(123,140,255,0.22); box-shadow:0 0 40px rgba(123,140,255,0.08); }

/* â”€â”€ Draft notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.draft-notice {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 14px; border-radius: 10px; margin-bottom: 12px;
  background: rgba(123,140,255,0.08); border: 1px solid rgba(123,140,255,0.2);
  font-size: 12.5px; color: rgba(123,140,255,0.85); animation: entryIn 0.4s ease;
}
.draft-notice span { flex: 1; }
.draft-restore-btn, .draft-discard-btn {
  padding: 4px 12px; border-radius: 999px; border: 1px solid; font-size: 12px;
  cursor: pointer; background: transparent; transition: all 0.18s; outline: none;
}
.draft-restore-btn { border-color: rgba(123,140,255,0.4); color: var(--accent); }
.draft-restore-btn:hover { background: rgba(123,140,255,0.15); }
.draft-discard-btn { border-color: var(--border); color: var(--muted); }
.draft-discard-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); }

/* â”€â”€ Edit mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.entry-edit-btn {
  position: absolute; right: 42px; top: 50%; transform: translateY(-50%);
  width: 28px; height: 28px; border-radius: 50%; border: 1px solid transparent;
  background: transparent; color: var(--muted); font-size: 15px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; transition: opacity 0.18s, background 0.18s; outline: none;
}
.entry:hover .entry-edit-btn { opacity: 0.45; }
.entry-edit-btn:hover { opacity: 1 !important; background: rgba(123,140,255,0.15); color: var(--accent); border-color: rgba(123,140,255,0.3); }
.entry-edit-ta {
  width: 100%; min-height: 80px; background: var(--surface);
  border: 1px solid rgba(123,140,255,0.35); border-radius: var(--radius-s);
  padding: 10px 12px; color: var(--text); font-family: inherit; font-size: 13.5px;
  line-height: 1.65; resize: vertical; outline: none; margin-top: 6px;
  box-shadow: 0 0 0 3px rgba(123,140,255,0.1);
}
.entry-edit-actions { display: flex; gap: 8px; margin-top: 8px; }
.edit-save-btn, .edit-cancel-btn {
  padding: 6px 16px; border-radius: 999px; font-size: 12.5px;
  cursor: pointer; outline: none; transition: all 0.18s;
}
.edit-save-btn { background: rgba(123,140,255,0.2); border: 1px solid rgba(123,140,255,0.4); color: var(--accent); }
.edit-save-btn:hover { background: rgba(123,140,255,0.35); }
.edit-cancel-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); }
.edit-cancel-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); }
.edited-badge { font-size: 10.5px; color: var(--dim); padding: 1px 7px; border-radius: 999px; border: 1px solid var(--border); }

/* â”€â”€ Insights card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.insights-card { padding: 18px 20px; }
.insights-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
.insights-title { font-size: 15px; font-weight: 700; flex: 1; }
.period-pills { display: flex; gap: 5px; }
.period-pill {
  padding: 4px 12px; border-radius: 999px; border: 1px solid var(--border);
  background: transparent; color: var(--muted); font-size: 11.5px; cursor: pointer;
  transition: all 0.18s; outline: none;
}
.period-pill:hover { border-color: var(--border-h); color: var(--text); }
.period-pill.active { background: var(--accent-s); border-color: var(--accent); color: var(--accent); }
#moodSparkline { display: block; width: 100%; border-radius: 8px; transition: opacity 0.25s ease; }
#moodSparkline.fading { opacity: 0; }
.sparkline-wrap { position: relative; }
.sparkline-tooltip {
  display: none; position: absolute; z-index: 20; pointer-events: none;
  background: var(--surface); border: 1px solid var(--border-h);
  border-radius: 10px; padding: 8px 12px; max-width: 190px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.28); font-size: 12.5px;
}
.stt-date  { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
.stt-mood  { font-size: 18px; margin-bottom: 2px; }
.stt-count { font-size: 11px; color: var(--dim); }

.insights-collapse-btn {
  width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border);
  background: transparent; color: var(--muted); font-size: 13px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s ease; outline: none; flex-shrink: 0;
}
.insights-collapse-btn:hover { border-color: var(--border-h); color: var(--text); background: rgba(255,255,255,0.06); }
.insights-body { overflow: hidden; transition: max-height 0.4s cubic-bezier(.4,0,.2,1), opacity 0.3s ease; max-height: 600px; opacity: 1; }
.insights-body.collapsed { max-height: 0; opacity: 0; }

.insight-summary { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
.insight-stat {
  flex: 1; min-width: 110px; padding: 10px 13px; border-radius: var(--radius-s);
  background: var(--surface2); border: 1px solid var(--border); text-align: center;
  transition: border-color 0.2s;
}
.insight-stat.accent {
  background: linear-gradient(135deg, rgba(123,140,255,0.1), rgba(167,139,250,0.06));
  border-color: rgba(123,140,255,0.28);
}
.insight-stat-val { font-size: 28px; margin-bottom: 4px; line-height: 1.1; font-weight: 700; }
.insight-stat.emoji .insight-stat-val { font-size: 24px; line-height: 1.3; }
.insight-stat-label { font-size: 11px; color: var(--muted); }
.insight-week-msg {
  width: 100%; padding: 10px 14px; border-radius: var(--radius-s);
  background: linear-gradient(135deg, rgba(123,140,255,0.07), rgba(167,139,250,0.05));
  border: 1px solid rgba(123,140,255,0.15); font-size: 13px; color: var(--text); line-height: 1.55;
}

/* â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.reactions-row { display: flex; gap: 4px; margin-top: 10px; align-items: center; flex-wrap: wrap; }
.reaction-label { display: none; }
.reaction-btn {
  font-size: 15px; padding: 5px 9px; border-radius: 999px;
  border: 1px solid var(--border); background: transparent; cursor: pointer;
  transition: all 0.18s ease; outline: none; line-height: 1; opacity: 0.4;
  min-height: 36px;
}
.reaction-btn:hover { opacity: 0.9; transform: scale(1.22) translateY(-2px); border-color: var(--border-h); }
.reaction-btn.reacted {
  opacity: 1; background: rgba(123,140,255,0.18); border-color: rgba(123,140,255,0.5);
  box-shadow: 0 0 10px rgba(123,140,255,0.22);
  animation: reactionPop 0.3s cubic-bezier(.34,1.56,.64,1);
  transform: scale(1.08);
}
@keyframes reactionPop { 0%{transform:scale(1);}55%{transform:scale(1.38);}100%{transform:scale(1);} }

/* â”€â”€ iPad & Touch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 820px) {
  .page { padding: 20px 16px 100px; }
  .tag-btn      { padding: 8px 16px; min-height: 42px; }
  .filter-pill  { padding: 7px 13px; min-height: 40px; }
  .period-pill  { padding: 6px 13px; min-height: 38px; }
  .mood-btn     { width: 46px; height: 46px; font-size: 24px; }
  .reaction-btn { padding: 7px 11px; font-size: 16px; min-height: 40px; opacity: 0.55; }
  .triage-btn   { min-height: 52px; font-size: 14px; }
  #historyList  { max-height: 420px; }
  #historyListWrap { max-height: 420px; }
  .history-toolbar { gap: 8px; }
  .search-wrap  { max-width: 160px; }
  /* Edit/Delete Buttons on touch immer minimal sichtbar */
  .entry-del, .entry-edit-btn { opacity: 0.35; }
  /* Breath-Button etwas kleiner damit er weniger Platz nimmt */
  .breath-btn { width: 42px; height: 42px; font-size: 18px; }
}

@media (max-width: 480px) {
  .triage-btns  { grid-template-columns: 1fr; }
  .triage-release { grid-column: auto; }
  .filter-pills { gap: 4px; }
  .filter-pill  { padding: 7px 10px; font-size: 11.5px; }
  .mood-btns    { gap: 2px; }
  #historyList  { max-height: 360px; }
  #historyListWrap { max-height: 360px; }
  .history-toolbar { flex-wrap: wrap; }
  .search-wrap  { max-width: 100%; flex: 1 1 100%; order: 3; }
}
</style>
</head>
<body>

<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div class="orb orb-3"></div>

<div class="page">
  <div class="draft-notice" id="draftNotice" style="display:none">
    <span>ğŸ“ Du hast einen unverÃ¶ffentlichten Entwurf</span>
    <button class="draft-restore-btn" id="draftRestoreBtn">Wiederherstellen</button>
    <button class="draft-discard-btn" id="draftDiscardBtn">Verwerfen</button>
  </div>

  <div id="memoryCardSlot"></div>

  <!-- Input card -->
  <div class="card" id="inputCard">
    <div class="brain-header">
      <div class="brain-icon-wrap">ğŸ’­</div>
      <div>
        <div class="brain-title">Brain-Dump</div>
        <div class="brain-subtitle">Dein sicherer Raum. Kein Stress, nur du.</div>
      </div>
      <div class="streak-badge" id="streakBadge" style="display:none">ğŸ”¥ <span id="streakCount"></span></div>
    </div>

    <div class="tags-row">
      <button class="tag-btn" data-tag="Idee">ğŸ’¡ Idee</button>
      <button class="tag-btn" data-tag="Stress">ğŸŒŠ Stress</button>
      <button class="tag-btn" data-tag="Frage">ğŸ” Frage</button>
      <button class="tag-btn" data-tag="To-do">ğŸ“Œ To-do</button>
      <button class="tag-btn" data-tag="Erkenntnis">âœ¨ Erkenntnis</button>
    </div>

    <div class="textarea-wrap">
      <textarea id="brainText" placeholder="Was geht dir durch den Kopf?"></textarea>
      <div id="dissolveOverlay"></div>
      <span class="word-counter" id="wordCounter"></span>
    </div>

    <div class="mood-row">
      <span class="mood-label">Wie geht's dir?</span>
      <div class="mood-btns">
        <button class="mood-btn" data-mood="1" title="ErschÃ¶pft">ğŸ˜®â€ğŸ’¨</button>
        <button class="mood-btn" data-mood="2" title="Nicht so gut">ğŸ˜”</button>
        <button class="mood-btn" data-mood="3" title="Es geht">ğŸ˜</button>
        <button class="mood-btn" data-mood="4" title="Gut">ğŸ™‚</button>
        <button class="mood-btn" data-mood="5" title="Super!">ğŸŒŸ</button>
      </div>
    </div>

    <div class="save-row">
      <button class="btn-keep" id="keepBtn">Eintragen â†’</button>
      <button class="btn-release" id="releaseBtn">Loslassen ğŸŒ¿</button>
    </div>
    <div class="save-hints">
      <span class="hint-tag">Strg+Enter = Eintragen</span>
      <span class="hint-tag release-hint">ğŸŒ¿ verschwindet fÃ¼r 30 Tage</span>
    </div>
    <span class="affirm-msg" id="affirmMsg"></span>
  </div>

  <!-- Triage -->
  <div class="triage-panel" id="triagePanel">
    <div class="triage-title">Was soll damit passieren? âœ¨</div>
    <div class="triage-sub">Oder einfach loslassen â€“ das ist auch vÃ¶llig okay.</div>
    <div class="triage-btns">
      <button class="triage-btn" data-action="task">ğŸ“‹ Als Aufgabe</button>
      <button class="triage-btn" data-action="card">ğŸ´ Als Karteikarte</button>
      <button class="triage-btn triage-release" data-action="release">ğŸƒ Einfach loslassen</button>
    </div>
  </div>

  <!-- Insights / Mood sparkline -->
  <div class="card insights-card" id="insightsCard">
    <div class="insights-header">
      <span class="insights-title">âœ¨ Stimmungsverlauf</span>
      <div class="period-pills">
        <button class="period-pill active" data-period="14">2 Wochen</button>
        <button class="period-pill" data-period="90">3 Monate</button>
        <button class="period-pill" data-period="365">1 Jahr</button>
      </div>
      <button class="insights-collapse-btn" id="insightsCollapseBtn" title="Ein-/ausklappen">â–¾</button>
    </div>
    <div class="insights-body" id="insightsBody">
      <div class="sparkline-wrap">
        <canvas id="moodSparkline" height="130"></canvas>
        <div class="sparkline-tooltip" id="sparklineTooltip">
          <div class="stt-date" id="sttDate"></div>
          <div class="stt-mood" id="sttMood"></div>
          <div class="stt-count" id="sttCount"></div>
        </div>
      </div>
      <div class="insight-summary" id="insightSummary"></div>
    </div>
  </div>

  <!-- History -->
  <div class="card" id="historyCard">
    <div class="history-toolbar">
      <span class="history-title">Verlauf</span>
      <div class="search-wrap">
        <span class="search-ico">ğŸ”</span>
        <input id="searchInput" class="search-input" type="text" placeholder="Suchenâ€¦">
      </div>
      <div class="filter-pills">
        <button class="filter-pill active" data-filter="all">Alle</button>
        <button class="filter-pill" data-filter="Idee">ğŸ’¡</button>
        <button class="filter-pill" data-filter="Stress">ğŸŒŠ</button>
        <button class="filter-pill" data-filter="Frage">ğŸ”</button>
        <button class="filter-pill" data-filter="To-do">ğŸ“Œ</button>
        <button class="filter-pill" data-filter="Erkenntnis">âœ¨</button>
      </div>
      <button class="view-toggle" id="galaxyToggle" title="Galaxie-Ansicht">ğŸŒŒ</button>
    </div>
    <div id="hiddenBanner"></div>
    <div id="historyListWrap">
      <div id="historyList"></div>
    </div>
    <div id="galaxyWrap">
      <canvas id="galaxyCanvas" height="280"></canvas>
      <div class="galaxy-tooltip" id="galaxyTooltip">
        <div class="gt-date" id="gtDate"></div>
        <div class="gt-text" id="gtText"></div>
        <div class="gt-mood" id="gtMood"></div>
      </div>
    </div>
  </div>
</div>

<!-- Breath -->
<button class="breath-btn" id="breathBtn" title="AtemÃ¼bung">ğŸŒ¬ï¸</button>
<div class="breath-overlay" id="breathOverlay">
  <button class="breath-close" id="breathClose">âœ•</button>
  <div class="breath-instruction" id="breathInstruction">Bereit?</div>
  <div class="breath-ring-wrap">
    <div class="breath-ring-outer" id="breathOuter"></div>
    <div class="breath-ring-inner" id="breathInner"></div>
    <div class="breath-count" id="breathCount"></div>
  </div>
  <div class="breath-sub">4 Â· 7 Â· 8 AtemÃ¼bung â€“ hilft beim Runterkommen</div>
</div>

<script>
// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY    = "uniHyperNotes_v3";
const RELEASE_DAYS   = 30;
const DRAFT_KEY      = "uniHyperNotes_brainDraft";
const REACTION_EMOJIS = ["ğŸ¥°","ğŸ’ª","ğŸ˜…","ğŸŒ±","âœ¨"];

function loadData()  { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
function saveData(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function getBrainData() {
  const d = loadData();
  if (!d.brain) d.brain = { entries: [] };
  if (!d.brain.entries) d.brain.entries = [];
  d.brain.entries.forEach(e => {
    if (!Array.isArray(e.tags))      e.tags = [];
    if (e.mood === undefined)         e.mood = null;
    if (e.released === undefined)     e.released = false;
    if (e.releaseUntil === undefined) e.releaseUntil = null;
    if (!Array.isArray(e.reactions))  e.reactions = [];
    if (e.edited === undefined)       e.edited = false;
  });
  return d;
}

// â”€â”€ Theme sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncTheme() {
  try { document.body.classList.toggle("light", (JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}")).theme === "light"); } catch {}
}
window.addEventListener("storage", e => { if (e.key === STORAGE_KEY) syncTheme(); });

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeTags   = [], activeMood = null;
let activeFilter = "all", searchQuery = "", lastEntry = null;
let galaxyView   = false;
let breathActive = false, breathTimer = null;

const AFFIRM_KEEP    = ["Eingetragen. ğŸ“Œ","Notiert. ğŸ—’ï¸","Behalten. âœ“","Festgehalten. ğŸ–Šï¸"];
const AFFIRM_RELEASE = ["Losgelassen. ğŸŒ¿","Verabschiedet. ğŸƒ","Geht seinen Weg. ğŸ’¨","Freigelassen. âœ¨","Lass es ziehen. ğŸŒŠ"];
const MOOD_EMOJI     = ["","ğŸ˜®â€ğŸ’¨","ğŸ˜”","ğŸ˜","ğŸ™‚","ğŸŒŸ"];
const TAG_COLORS     = { Idee:"#a78bfa", Stress:"#fb7185", Frage:"#fbbf24", "To-do":"#34d399", Erkenntnis:"#38bdf8" };
const ORB_CONFIGS    = {
  0: ["#7b8cff","#38bdf8","#a78bfa"],
  1: ["#4a6fa8","#2d6ba0","#3a5a8a"],
  2: ["#8b5cf6","#6b3aed","#a78bfa"],
  3: ["#7b8cff","#38bdf8","#a78bfa"],
  4: ["#f59e0b","#fb923c","#fbbf24"],
  5: ["#06b6d4","#22d3ee","#38bdf8"],
};
const PROMPTS = [
  "Was geht dir durch den Kopf?","Was beschÃ¤ftigt dich gerade?",
  "Wie war dein Tag â€“ wirklich?","Was wÃ¼rdest du gerne jemandem sagen?",
  "Was macht dir Sorgen?","Welcher Gedanke lÃ¤sst dich nicht los?",
  "Schreib einfach. Es muss nichts perfekt sein.","Was brauchst du gerade?",
];

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const brainText      = document.getElementById("brainText");
const wordCounter    = document.getElementById("wordCounter");
const keepBtn        = document.getElementById("keepBtn");
const releaseBtn     = document.getElementById("releaseBtn");
const affirmMsg      = document.getElementById("affirmMsg");
const triagePanel    = document.getElementById("triagePanel");
const historyList    = document.getElementById("historyList");
const hiddenBanner   = document.getElementById("hiddenBanner");
const searchInput    = document.getElementById("searchInput");
const inputCard      = document.getElementById("inputCard");
const streakBadge    = document.getElementById("streakBadge");
const streakCount    = document.getElementById("streakCount");
const dissolveOvl    = document.getElementById("dissolveOverlay");
const galaxyToggle   = document.getElementById("galaxyToggle");
const galaxyWrap     = document.getElementById("galaxyWrap");
const galaxyCanvas   = document.getElementById("galaxyCanvas");
const galaxyTooltip  = document.getElementById("galaxyTooltip");
const breathBtn      = document.getElementById("breathBtn");
const breathOverlay  = document.getElementById("breathOverlay");
const breathClose    = document.getElementById("breathClose");
const draftNotice    = document.getElementById("draftNotice");
const draftRestoreBtn= document.getElementById("draftRestoreBtn");
const draftDiscardBtn= document.getElementById("draftDiscardBtn");
const moodSparkline      = document.getElementById("moodSparkline");
const insightSummary     = document.getElementById("insightSummary");
const insightsCollapseBtn= document.getElementById("insightsCollapseBtn");
const insightsBody       = document.getElementById("insightsBody");
const sparklineTooltip   = document.getElementById("sparklineTooltip");
const orb1 = document.querySelector(".orb-1");
const orb2 = document.querySelector(".orb-2");
const orb3 = document.querySelector(".orb-3");

// â”€â”€ Parallax orbs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mx=0.5, my=0.5, cx=0.5, cy=0.5;
document.addEventListener("mousemove", e => { mx = e.clientX/window.innerWidth; my = e.clientY/window.innerHeight; });
(function orbLoop() {
  cx += (mx-cx)*0.028; cy += (my-cy)*0.028;
  const dx=cx-0.5, dy=cy-0.5;
  if (orb1) orb1.style.transform = `translate(${dx*-45}px,${dy*-32}px)`;
  if (orb2) orb2.style.transform = `translate(${dx*38}px,${dy*28}px)`;
  if (orb3) orb3.style.transform = `translate(${dx*22}px,${dy*-24}px)`;
  requestAnimationFrame(orbLoop);
})();

function setOrbColors(cfg) {
  [orb1,orb2,orb3].forEach((o,i) => {
    if (!o) return;
    o.style.background   = `radial-gradient(circle, ${cfg[i]}, transparent 68%)`;
    o.style.transition   = "background 1.3s ease";
  });
}
setOrbColors(ORB_CONFIGS[0]);

// â”€â”€ 3D tilt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tiltEl = null;
document.addEventListener("mousemove", e => {
  const card = e.target.closest(".entry");
  if (card !== tiltEl) { if (tiltEl) tiltEl.style.transform=""; tiltEl=card; }
  if (!card) return;
  const r=card.getBoundingClientRect();
  card.style.transform=`perspective(900px) rotateX(${-(e.clientY-r.top)/r.height*10-5}deg) rotateY(${((e.clientX-r.left)/r.width-0.5)*9}deg) translateY(-3px) scale(1.01)`;
});
document.addEventListener("mouseleave", ()=>{ if(tiltEl){tiltEl.style.transform="";tiltEl=null;} });

// â”€â”€ Particle burst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function burst(x, y, n=22) {
  const cols=["#7b8cff","#a78bfa","#fb7185","#34d399","#38bdf8","#fbbf24","#f9a8d4"];
  for (let i=0;i<n;i++) {
    const p=document.createElement("div"); p.className="particle";
    const col=cols[i%cols.length], ang=(Math.PI*2/n)*i+(Math.random()-.5)*.6;
    const spd=35+Math.random()*75, sz=4+Math.random()*5, dur=460+Math.random()*320;
    p.style.cssText=`left:${x}px;top:${y}px;width:${sz}px;height:${sz}px;background:${col};`;
    document.body.appendChild(p);
    p.animate([{transform:"translate(-50%,-50%) scale(1)",opacity:1},
      {transform:`translate(calc(-50% + ${Math.cos(ang)*spd}px),calc(-50% + ${Math.sin(ang)*spd}px)) scale(0)`,opacity:0}],
      {duration:dur,easing:"cubic-bezier(0,.9,.57,1)",fill:"forwards"}).finished.then(()=>p.remove());
  }
}

function sparkleTag(btn) {
  const r=btn.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
  const col=TAG_COLORS[btn.dataset.tag]||"#7b8cff";
  ["âœ¦","âœ§","âœ¦","âœ§","âœ¦","âœ§"].forEach((sym,i)=>{
    const s=document.createElement("span"); s.className="sparkle"; s.textContent=sym;
    s.style.cssText=`left:${cx}px;top:${cy}px;color:${col};font-size:${9+Math.random()*5}px;`;
    document.body.appendChild(s);
    const a=(Math.PI*2/6)*i+Math.random()*.3, rd=22+Math.random()*14;
    s.animate([{transform:"translate(-50%,-50%)",opacity:1},
      {transform:`translate(calc(-50% + ${Math.cos(a)*rd}px),calc(-50% + ${Math.sin(a)*rd}px)) scale(0)`,opacity:0}],
      {duration:520+Math.random()*150,easing:"ease-out",fill:"forwards"}).finished.then(()=>s.remove());
  });
}

function starConfetti() {
  const icons=["â­","âœ¨","ğŸŒŸ","ğŸ’«","â­","âœ¨"];
  for(let i=0;i<18;i++) setTimeout(()=>{
    const s=document.createElement("div"); s.className="confetti-star";
    const d=1600+Math.random()*1800;
    s.textContent=icons[i%icons.length];
    s.style.cssText=`left:${5+Math.random()*90}vw;font-size:${13+Math.random()*14}px;animation-duration:${d}ms;`;
    document.body.appendChild(s); setTimeout(()=>s.remove(),d+100);
  },i*90);
}

function ripple(btn, e) {
  const r=btn.getBoundingClientRect(), rip=document.createElement("span"); rip.className="ripple";
  const sz=Math.max(r.width,r.height)*2;
  rip.style.cssText=`width:${sz}px;height:${sz}px;left:${e.clientX-r.left}px;top:${e.clientY-r.top}px;margin:${-sz/2}px 0 0 ${-sz/2}px;`;
  btn.appendChild(rip); setTimeout(()=>rip.remove(),600);
}

// â”€â”€ Cycling placeholder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pi=0;
setInterval(()=>{ if(document.activeElement!==brainText&&!brainText.value){ pi=(pi+1)%PROMPTS.length; brainText.placeholder=PROMPTS[pi]; } },3600);

// â”€â”€ Draft save / restore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveDraft() {
  const text = brainText.value;
  if (text.trim()) {
    localStorage.setItem(DRAFT_KEY, JSON.stringify({ text, tags: [...activeTags], mood: activeMood }));
  } else {
    clearDraft();
  }
}
function clearDraft() {
  localStorage.removeItem(DRAFT_KEY);
  draftNotice.style.display = "none";
}
function restoreDraft() {
  try {
    const raw = localStorage.getItem(DRAFT_KEY);
    if (!raw) return;
    const draft = JSON.parse(raw);
    if (!draft.text || !draft.text.trim()) { clearDraft(); return; }
    draftNotice.style.display = "flex";
    draftRestoreBtn.onclick = () => {
      brainText.value = draft.text;
      brainText.dispatchEvent(new Event("input"));
      activeTags = Array.isArray(draft.tags) ? draft.tags : [];
      document.querySelectorAll(".tag-btn").forEach(b =>
        b.classList.toggle("active", activeTags.includes(b.dataset.tag))
      );
      if (draft.mood) {
        activeMood = draft.mood;
        document.querySelectorAll(".mood-btn").forEach(b =>
          b.classList.toggle("active", parseInt(b.dataset.mood) === draft.mood)
        );
        setMoodAtmosphere(draft.mood);
      }
      draftNotice.style.display = "none";
      brainText.focus();
    };
    draftDiscardBtn.onclick = () => clearDraft();
  } catch {}
}

// â”€â”€ Mood atmosphere â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMoodAtmosphere(mood) {
  setOrbColors(ORB_CONFIGS[mood]||ORB_CONFIGS[0]);
  const tints={1:"rgba(74,111,175,0.04)",2:"rgba(107,58,237,0.04)",3:"transparent",4:"rgba(245,158,11,0.04)",5:"rgba(6,182,212,0.05)"};
  document.documentElement.style.setProperty("--bg-tint", tints[mood]||"transparent");
}

// â”€â”€ Streak â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcStreak() {
  const entries=getBrainData().brain.entries;
  if(!entries.length) return 0;
  const days=new Set(entries.map(e=>new Date(e.date).toDateString()));
  let s=0; const c=new Date();
  while(days.has(c.toDateString())){s++;c.setDate(c.getDate()-1);}
  return s;
}
function updateStreak() {
  const s=calcStreak();
  if(s>=2){streakBadge.style.display="flex";streakCount.textContent=s+" Tage";}
  else streakBadge.style.display="none";
}

// â”€â”€ Memory card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMemoryCard() {
  const slot=document.getElementById("memoryCardSlot");
  const dismissed=new Set(JSON.parse(sessionStorage.getItem("brainMemoryDismissed")||"[]"));
  const d=getBrainData();
  const now=Date.now(), week=7*24*60*60*1000;
  const candidates=d.brain.entries.filter(e=>!e.released&&(now-e.date)>week&&!dismissed.has(e.id));
  if(!candidates.length){slot.innerHTML="";return;}
  const e=candidates[Math.floor(Math.random()*candidates.length)];
  const daysAgo=Math.round((now-e.date)/(24*60*60*1000));
  const chips=e.tags.map(t=>`<span class="memory-chip">${t}</span>`).join("");
  const moodEl=e.mood?`<span class="memory-mood">${MOOD_EMOJI[e.mood]}</span>`:"";
  const safe=e.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  slot.innerHTML=`
    <div class="memory-card" id="memCard">
      <div class="memory-label">ğŸ’­ Damals hattest du das gedachtâ€¦</div>
      <div class="memory-ago">vor ${daysAgo} Tag${daysAgo===1?"":"en"}</div>
      <div class="memory-text">${safe}</div>
      <div class="memory-footer">
        ${moodEl}<div class="memory-chips">${chips}</div>
        <button class="memory-dismiss" id="memDismiss">Okay âœ“</button>
      </div>
    </div>`;
  document.getElementById("memDismiss").addEventListener("click",()=>{
    const mc=document.getElementById("memCard");
    mc.classList.add("leaving");
    mc.addEventListener("animationend",()=>{slot.innerHTML="";},{ once:true });
    dismissed.add(e.id);
    sessionStorage.setItem("brainMemoryDismissed",JSON.stringify([...dismissed]));
  });
}

// â”€â”€ Dissolve animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dissolveAndSave(text, onDone) {
  dissolveOvl.style.display = "block";
  dissolveOvl.innerHTML = "";
  brainText.style.color = "transparent";

  let maxEnd = 0;
  const lines = text.split("\n");
  lines.forEach((line, li) => {
    if (li > 0) dissolveOvl.appendChild(document.createElement("br"));
    [...line].forEach((ch, ci) => {
      const sp = document.createElement("span");
      sp.style.display = "inline-block";
      if (ch === " ") { sp.innerHTML = "&nbsp;"; }
      else { sp.textContent = ch; }
      const delay  = (li * line.length + ci) * 12;
      const dur    = 550 + Math.random() * 450;
      const tx     = (Math.random() - 0.5) * 70;
      const ty     = -(25 + Math.random() * 65);
      const rot    = (Math.random() - 0.5) * 50;
      sp.style.cssText += `animation:charDissolve ${dur}ms ease-out ${delay}ms forwards;--tx:${tx}px;--ty:${ty}px;--rot:${rot}deg;`;
      dissolveOvl.appendChild(sp);
      maxEnd = Math.max(maxEnd, delay + dur);
    });
  });

  setTimeout(() => {
    dissolveOvl.style.display = "none";
    dissolveOvl.innerHTML = "";
    brainText.style.color = "";
    onDone();
  }, maxEnd + 80);
}

// â”€â”€ Textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
brainText.addEventListener("input", () => {
  brainText.style.height = "auto";
  brainText.style.height = Math.max(118, brainText.scrollHeight) + "px";
  const w = brainText.value.trim().split(/\s+/).filter(Boolean).length;
  wordCounter.textContent = w > 0 ? w + " WÃ¶rter" : "";
  wordCounter.classList.toggle("visible", w >= 4);
  releaseBtn.classList.toggle("glowing", brainText.value.trim().length > 0);
  inputCard.classList.toggle("typing", brainText.value.length > 0);
  saveDraft();
});
brainText.addEventListener("focus", () => inputCard.classList.add("typing"));
brainText.addEventListener("blur",  () => { if (!brainText.value) inputCard.classList.remove("typing"); });
brainText.addEventListener("keydown", e => {
  if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) { e.preventDefault(); doSave("keep"); }
});

// â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".tag-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const tag = btn.dataset.tag, adding = !activeTags.includes(tag);
    activeTags = adding ? [...activeTags, tag] : activeTags.filter(t => t !== tag);
    btn.classList.toggle("active", adding);
    if (adding) sparkleTag(btn);
  });
});

// â”€â”€ Mood â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".mood-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const m = parseInt(btn.dataset.mood), same = activeMood === m;
    activeMood = same ? null : m;
    document.querySelectorAll(".mood-btn").forEach(b => b.classList.toggle("active", !same && parseInt(b.dataset.mood)===m));
    if (!same) {
      setMoodAtmosphere(m);
      if (m === 5) starConfetti();
    } else { setMoodAtmosphere(null); }
  });
});

// â”€â”€ Save (both modes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSave(mode) {
  const text = brainText.value.trim();
  if (!text) {
    brainText.classList.add("shake");
    brainText.addEventListener("animationend", () => brainText.classList.remove("shake"), { once: true });
    brainText.focus(); return;
  }

  const isRelease = mode === "release";
  const entry = {
    id: "brain-" + Date.now(),
    text, date: Date.now(),
    tags: [...activeTags],
    mood: activeMood,
    released:    isRelease,
    releaseUntil: isRelease ? Date.now() + RELEASE_DAYS * 24 * 60 * 60 * 1000 : null,
  };

  const commit = () => {
    const d = getBrainData();
    d.brain.entries.push(entry);
    saveData(d);
    lastEntry = entry;

    brainText.value = "";
    brainText.style.height = "118px";
    clearDraft();
    releaseBtn.classList.remove("glowing");
    wordCounter.classList.remove("visible");
    inputCard.classList.remove("typing");
    activeTags = []; activeMood = null;
    document.querySelectorAll(".tag-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("active"));
    setMoodAtmosphere(null);

    const msgs = isRelease ? AFFIRM_RELEASE : AFFIRM_KEEP;
    affirmMsg.textContent = msgs[Math.floor(Math.random() * msgs.length)];
    affirmMsg.classList.remove("show"); void affirmMsg.offsetWidth; affirmMsg.classList.add("show");

    renderHistory(); updateStreak(); renderInsights(insightsPeriod);
    if (!isRelease) {
      triagePanel.classList.add("visible");
      triagePanel.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  };

  if (isRelease) {
    // Dissolve the text then commit silently
    dissolveAndSave(text, commit);
  } else {
    // Burst from keep button
    const r = keepBtn.getBoundingClientRect();
    burst(r.left + r.width / 2, r.top + r.height / 2, activeTags.length > 0 ? 28 : 18);
    commit();
  }
}

keepBtn.addEventListener("click", e => { ripple(keepBtn, e); doSave("keep"); });
releaseBtn.addEventListener("click", e => { ripple(releaseBtn, e); doSave("release"); });

// â”€â”€ Triage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".triage-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    triagePanel.classList.remove("visible");
    if (!lastEntry) return;
    const a = btn.dataset.action;
    if (a === "task")
      window.parent.postMessage({ type: "brain-triage", action: "task", text: lastEntry.text }, "*");
    else if (a === "card")
      window.parent.postMessage({ type: "brain-triage", action: "card", text: lastEntry.text }, "*");
    lastEntry = null;
  });
});

// â”€â”€ Search & filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
searchInput.addEventListener("input", () => { searchQuery = searchInput.value.trim().toLowerCase(); renderHistory(); });
document.querySelectorAll(".filter-pill").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-pill").forEach(b => b.classList.remove("active"));
    btn.classList.add("active"); activeFilter = btn.dataset.filter; renderHistory();
  });
});

// â”€â”€ Galaxy view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
galaxyToggle.addEventListener("click", () => {
  galaxyView = !galaxyView;
  galaxyToggle.classList.toggle("active", galaxyView);
  historyList.style.display = galaxyView ? "none" : "";
  galaxyWrap.style.display  = galaxyView ? "block" : "none";
  if (galaxyView) drawGalaxy();
});

function hashId(id) { let h=0; for(const c of id) h=((h<<5)-h)+c.charCodeAt(0); return Math.abs(h); }

function drawGalaxy() {
  const d   = getBrainData();
  const now = Date.now();
  const entries = d.brain.entries.filter(e => !(e.released && now < e.releaseUntil));
  if (!entries.length) return;

  const dpr = window.devicePixelRatio || 1;
  const W   = galaxyWrap.clientWidth;
  const H   = Math.min(280, Math.round(W * 0.44));
  galaxyCanvas.width  = W * dpr;
  galaxyCanvas.height = H * dpr;
  galaxyCanvas.style.width  = W + "px";
  galaxyCanvas.style.height = H + "px";
  const ctx = galaxyCanvas.getContext("2d");
  ctx.scale(dpr, dpr);

  const dates = entries.map(e => e.date);
  const minD  = Math.min(...dates), maxD = Math.max(...dates);
  const range = maxD - minD || 1;

  // store positions for hover
  galaxyCanvas._stars = entries.map(e => {
    const h  = hashId(e.id);
    const tx = (e.date - minD) / range;
    const x  = (0.07 + tx * 0.86 + ((h % 200) / 200 - 0.1) * 0.12) * W;
    const y  = (0.1  + ((h >> 5) % 1000) / 1000 * 0.8) * H;
    const sz = 3 + Math.sqrt(e.text.split(" ").length) * 0.6;
    return { e, x: Math.max(12, Math.min(W-12, x)), y: Math.max(12, Math.min(H-12, y)), sz };
  });

  // background
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--surface2").trim() || "#252840";
  ctx.fillRect(0, 0, W, H);

  // faint grid
  ctx.strokeStyle = "rgba(255,255,255,0.03)";
  ctx.lineWidth = 1;
  for (let gx = 0; gx < W; gx += 60) { ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,H); ctx.stroke(); }
  for (let gy = 0; gy < H; gy += 60) { ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(W,gy); ctx.stroke(); }

  // stars
  galaxyCanvas._stars.forEach(({ e, x, y, sz }) => {
    const col = e.tags[0] ? TAG_COLORS[e.tags[0]] : "#7b8cff";
    const grd = ctx.createRadialGradient(x, y, 0, x, y, sz * 3.5);
    grd.addColorStop(0, col + "cc"); grd.addColorStop(0.5, col + "44"); grd.addColorStop(1, col + "00");
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(x, y, sz * 3.5, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.beginPath(); ctx.arc(x, y, Math.min(sz, 4), 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = col;
    ctx.beginPath(); ctx.arc(x, y, Math.min(sz, 4) * 0.55, 0, Math.PI * 2); ctx.fill();
  });
}

// Galaxy hover tooltip
galaxyCanvas.addEventListener("mousemove", e => {
  if (!galaxyCanvas._stars) return;
  const rect = galaxyCanvas.getBoundingClientRect();
  const mx   = e.clientX - rect.left, my = e.clientY - rect.top;
  let hit = null, minD = 20;
  galaxyCanvas._stars.forEach(s => {
    const d = Math.hypot(s.x - mx, s.y - my);
    if (d < Math.max(s.sz * 4, 12) && d < minD) { minD = d; hit = s; }
  });
  if (hit) {
    const { e: en, x, y } = hit;
    const ds = new Date(en.date).toLocaleString("de-DE", { day:"2-digit", month:"short", year:"numeric" });
    document.getElementById("gtDate").textContent = ds;
    document.getElementById("gtText").textContent = en.text.slice(0, 100) + (en.text.length > 100 ? "â€¦" : "");
    document.getElementById("gtMood").textContent = en.mood ? MOOD_EMOJI[en.mood] : "";
    const tt = galaxyTooltip;
    tt.style.display = "block";
    let tx = x + 14, ty = y - 10;
    const ttW = 230, ttH = 100;
    if (tx + ttW > rect.width) tx = x - ttW - 10;
    if (ty + ttH > rect.height) ty = y - ttH;
    tt.style.left = tx + "px"; tt.style.top = ty + "px";
  } else {
    galaxyTooltip.style.display = "none";
  }
});
galaxyCanvas.addEventListener("mouseleave", () => { galaxyTooltip.style.display = "none"; });

// â”€â”€ Edit mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startEdit(id, el) {
  const d = getBrainData();
  const entry = d.brain.entries.find(e => e.id === id);
  if (!entry) return;
  const textEl = el.querySelector(".entry-text");
  if (!textEl) return;
  textEl.style.display = "none";

  const wrap   = document.createElement("div");
  const ta     = document.createElement("textarea"); ta.className = "entry-edit-ta";
  const acts   = document.createElement("div"); acts.className = "entry-edit-actions";
  const saveBtn   = document.createElement("button"); saveBtn.className = "edit-save-btn";   saveBtn.textContent = "âœ“ Speichern";
  const cancelBtn = document.createElement("button"); cancelBtn.className = "edit-cancel-btn"; cancelBtn.textContent = "Abbrechen";

  ta.value = entry.text;
  acts.append(saveBtn, cancelBtn);
  wrap.append(ta, acts);
  textEl.insertAdjacentElement("afterend", wrap);
  setTimeout(() => { ta.style.height = ta.scrollHeight + "px"; ta.focus(); }, 0);
  ta.addEventListener("input", () => { ta.style.height = "auto"; ta.style.height = ta.scrollHeight + "px"; });

  saveBtn.addEventListener("click", () => {
    const newText = ta.value.trim();
    if (!newText) return;
    const d2 = getBrainData();
    const e2 = d2.brain.entries.find(e => e.id === id);
    if (e2) { e2.text = newText; e2.edited = true; saveData(d2); }
    renderHistory(); renderInsights(insightsPeriod);
  });
  cancelBtn.addEventListener("click", () => renderHistory());
}

// â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleReaction(id, emoji, btn) {
  const d = getBrainData();
  const entry = d.brain.entries.find(e => e.id === id);
  if (!entry) return;
  if (!Array.isArray(entry.reactions)) entry.reactions = [];
  const idx = entry.reactions.indexOf(emoji);
  if (idx > -1) {
    entry.reactions.splice(idx, 1);
    btn.classList.remove("reacted");
  } else {
    entry.reactions.push(emoji);
    btn.classList.add("reacted");
    btn.animate(
      [{transform:"scale(1)"},{transform:"scale(1.45)"},{transform:"scale(1)"}],
      {duration:300, easing:"cubic-bezier(.34,1.56,.64,1)"}
    );
  }
  saveData(d);
}

// â”€â”€ Insights / Mood sparkline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let insightsPeriod = 14;
let insightsCollapsed = false;

function renderInsights(days, fade = false) {
  insightsPeriod = days;
  const d        = getBrainData();
  const now      = Date.now();
  const periodMs = days * 24 * 60 * 60 * 1000;
  const allVisible = d.brain.entries.filter(e => !e.released);
  const entries  = allVisible.filter(e => (now - e.date) <= periodMs);

  // Bucket config
  let buckets, bucketMs;
  if      (days <= 14) { buckets = days; bucketMs = 86400000; }
  else if (days <= 90) { buckets = 18;   bucketMs = periodMs / 18; }
  else                 { buckets = 13;   bucketMs = periodMs / 13; }

  const MONTHS = ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
  const bucketData = Array.from({length: buckets}, (_, i) => {
    const start    = now - periodMs + i * bucketMs;
    const bE       = entries.filter(e => e.date >= start && e.date < start + bucketMs);
    const moods    = bE.map(e => e.mood).filter(Boolean);
    const avg      = moods.length ? moods.reduce((a,b)=>a+b,0)/moods.length : null;
    const dt       = new Date(start);
    const label    = days <= 90
      ? dt.getDate() + "." + (dt.getMonth()+1) + "."
      : MONTHS[dt.getMonth()];
    return { label, avgMood: avg, count: bE.length, startMs: start };
  });

  const draw = () => {
    const dpr = window.devicePixelRatio || 1;
    const W   = (moodSparkline.parentElement?.clientWidth || 620);
    const H   = 130;
    moodSparkline.width  = W * dpr;
    moodSparkline.height = H * dpr;
    moodSparkline.style.width  = W + "px";
    moodSparkline.style.height = H + "px";
    const ctx = moodSparkline.getContext("2d");
    ctx.scale(dpr, dpr);

    // Y-axis emoji labels (left side)
    const YEMOJI = ["","ğŸ˜®â€ğŸ’¨","ğŸ˜”","ğŸ˜","ğŸ™‚","ğŸŒŸ"];
    const PAD  = { l: 30, r: 12, t: 10, b: 22 };
    const cW   = W - PAD.l - PAD.r;
    const cH   = H - PAD.t - PAD.b;

    // Background
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--surface2").trim() || "#252840";
    ctx.fillRect(0, 0, W, H);

    // Guide lines + Y-emoji labels
    ctx.font = "12px sans-serif"; ctx.textAlign = "right";
    for (let m = 1; m <= 5; m++) {
      const gy = PAD.t + cH - ((m-1)/4)*cH;
      ctx.strokeStyle = "rgba(255,255,255,0.05)";
      ctx.lineWidth = 1; ctx.setLineDash([2,4]);
      ctx.beginPath(); ctx.moveTo(PAD.l, gy); ctx.lineTo(W-PAD.r, gy); ctx.stroke();
      // only top (ğŸŒŸ) and bottom (ğŸ˜®â€ğŸ’¨) labels to avoid clutter
      if (m === 1 || m === 5) {
        ctx.fillStyle = "rgba(255,255,255,0.28)";
        ctx.fillText(YEMOJI[m], PAD.l - 4, gy + 4);
      }
    }
    ctx.setLineDash([]);

    const pts = bucketData.map((b,i) => ({
      x: PAD.l + (i / Math.max(buckets-1,1)) * cW,
      y: b.avgMood != null ? PAD.t + cH - ((b.avgMood-1)/4)*cH : null,
      ...b
    }));
    // store for hover
    moodSparkline._pts = pts;
    moodSparkline._PAD = PAD;
    moodSparkline._H   = H;

    const withMood = pts.filter(p => p.y != null);

    // Gradient fill + line
    if (withMood.length >= 1) {
      if (withMood.length > 1) {
        ctx.beginPath();
        ctx.moveTo(withMood[0].x, H - PAD.b);
        ctx.lineTo(withMood[0].x, withMood[0].y);
        for (let i = 1; i < withMood.length; i++) {
          const cp = (withMood[i-1].x + withMood[i].x)/2;
          ctx.bezierCurveTo(cp, withMood[i-1].y, cp, withMood[i].y, withMood[i].x, withMood[i].y);
        }
        ctx.lineTo(withMood[withMood.length-1].x, H - PAD.b);
        ctx.closePath();
        const gfill = ctx.createLinearGradient(0, PAD.t, 0, H-PAD.b);
        gfill.addColorStop(0, "rgba(123,140,255,0.25)");
        gfill.addColorStop(1, "rgba(123,140,255,0.02)");
        ctx.fillStyle = gfill; ctx.fill();

        ctx.beginPath();
        ctx.moveTo(withMood[0].x, withMood[0].y);
        for (let i = 1; i < withMood.length; i++) {
          const cp = (withMood[i-1].x + withMood[i].x)/2;
          ctx.bezierCurveTo(cp, withMood[i-1].y, cp, withMood[i].y, withMood[i].x, withMood[i].y);
        }
        ctx.strokeStyle = "rgba(123,140,255,0.65)"; ctx.lineWidth = 2; ctx.stroke();
      }
    }

    // Dots + X-labels
    const MOOD_COLS = ["","#4a6fa8","#8b5cf6","#7b8cff","#f59e0b","#06b6d4"];
    const skip = Math.ceil(buckets / 9);
    pts.forEach((p, i) => {
      if (p.y != null) {
        const col = MOOD_COLS[Math.round(p.avgMood)] || "#7b8cff";
        const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 11);
        grd.addColorStop(0, col+"aa"); grd.addColorStop(1, col+"00");
        ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(p.x, p.y, 11, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = col;    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(p.x, p.y, 1.8, 0, Math.PI*2); ctx.fill();
      } else {
        ctx.fillStyle = "rgba(255,255,255,0.1)";
        ctx.beginPath(); ctx.arc(p.x, PAD.t + cH/2, 2, 0, Math.PI*2); ctx.fill();
      }
      if (i % skip === 0 || i === buckets-1) {
        ctx.fillStyle = "rgba(255,255,255,0.32)";
        ctx.font = "10px sans-serif"; ctx.textAlign = "center";
        ctx.fillText(p.label, p.x, H - 4);
      }
    });
  };

  if (fade) {
    moodSparkline.classList.add("fading");
    setTimeout(() => { draw(); moodSparkline.classList.remove("fading"); }, 230);
  } else {
    draw();
  }

  // Summary stats
  const totalEntries = entries.length;
  const allMoods     = entries.map(e=>e.mood).filter(Boolean);
  const avgMoodAll   = allMoods.length ? Math.round(allMoods.reduce((a,b)=>a+b,0)/allMoods.length) : null;
  const tagCounts    = {};
  entries.forEach(e => e.tags.forEach(t => { tagCounts[t]=(tagCounts[t]||0)+1; }));
  const topTag = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1])[0];

  const weekAgo       = now - 7*24*60*60*1000;
  const lastWeekE     = allVisible.filter(e => e.date >= weekAgo);
  const lastWeekMoods = lastWeekE.map(e=>e.mood).filter(Boolean);
  const avgWeekMood   = lastWeekMoods.length ? Math.round(lastWeekMoods.reduce((a,b)=>a+b,0)/lastWeekMoods.length) : null;
  const isMonday      = new Date().getDay() === 1;
  const weekMsg       = avgWeekMood
    ? `${isMonday ? "ğŸ—“ï¸ WochenrÃ¼ckblick:" : "ğŸ“… Letzte 7 Tage:"} Durchschnittsstimmung ${MOOD_EMOJI[avgWeekMood]} Â· ${lastWeekE.length} EintrÃ¤ge`
    : null;

  insightSummary.innerHTML = [
    `<div class="insight-stat"><div class="insight-stat-val">${totalEntries}</div><div class="insight-stat-label">EintrÃ¤ge</div></div>`,
    avgMoodAll != null
      ? `<div class="insight-stat accent emoji"><div class="insight-stat-val">${MOOD_EMOJI[avgMoodAll]}</div><div class="insight-stat-label">Ã˜ Stimmung</div></div>`
      : "",
    topTag
      ? `<div class="insight-stat"><div class="insight-stat-val" style="font-size:15px;font-weight:600">${topTag[0]}</div><div class="insight-stat-label">hÃ¤ufigster Tag Â· ${topTag[1]}Ã—</div></div>`
      : "",
    weekMsg ? `<div class="insight-week-msg">${weekMsg}</div>` : "",
  ].join("");
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteEntry(id, el) {
  el.classList.add("removing");
  el.addEventListener("animationend", () => {
    const d = getBrainData(); d.brain.entries = d.brain.entries.filter(e => e.id !== id); saveData(d);
    renderHistory(); updateStreak(); renderInsights(insightsPeriod);
  }, { once: true });
}

// â”€â”€ Render history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistory() {
  const d   = getBrainData();
  const now = Date.now();

  // count hidden
  const hidden = d.brain.entries.filter(e => e.released && now < e.releaseUntil);
  if (hidden.length) {
    hiddenBanner.innerHTML = `<div class="hidden-banner"><span>ğŸŒ™ ${hidden.length} Gedanke${hidden.length===1?"":"n"} schlÃ¤ft${hidden.length===1?" noch":"n noch"} â€“ kommt in ${Math.ceil((Math.min(...hidden.map(e=>e.releaseUntil))-now)/(24*60*60*1000))} Tagen zurÃ¼ck</span></div>`;
  } else { hiddenBanner.innerHTML = ""; }

  let entries = d.brain.entries
    .filter(e => !(e.released && now < e.releaseUntil)) // hide locked
    .slice().sort((a, b) => b.date - a.date);

  if (activeFilter !== "all") entries = entries.filter(e => e.tags.includes(activeFilter));
  if (searchQuery)             entries = entries.filter(e => e.text.toLowerCase().includes(searchQuery));

  if (!entries.length) {
    const noData = !searchQuery && activeFilter === "all";
    historyList.innerHTML = `<div class="empty-state"><span class="empty-icon">${noData?"ğŸŒ±":"ğŸ”"}</span><div class="empty-title">${noData?"Noch nichts hier.":"Keine EintrÃ¤ge gefunden."}</div><div class="empty-sub">${noData?"Schreib einfach drauf los. Es muss nichts perfekt sein.":"Versuch einen anderen Suchbegriff."}</div></div>`;
    return;
  }

  historyList.innerHTML = "";
  entries.forEach((e, i) => {
    const el  = document.createElement("div");
    const isUnlocked = e.released && now >= e.releaseUntil;
    el.className = "entry" + (isUnlocked ? " unlocked" : "");
    el.style.animationDelay = (i * 0.04) + "s";
    el.dataset.primary = e.tags[0] || "";
    const dsRel  = relativeTime(e.date);
    const dsFull = new Date(e.date).toLocaleString("de-DE", { day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit" });
    const chips = e.tags.map(t => `<span class="entry-chip" data-tag="${t}">${t}</span>`).join("");
    const moodEl = e.mood ? `<span class="entry-mood">${MOOD_EMOJI[e.mood]}</span>` : "";
    const safe   = e.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const unlockLabel = isUnlocked
      ? `<div class="unlock-label">ğŸ’Œ Losgelassen vor ${Math.round((now-e.date)/(24*60*60*1000))} Tagen Â· Wie siehst du das heute?</div>` : "";
    const editedBadge = e.edited ? `<span class="edited-badge">bearbeitet</span>` : "";
    const reactionsHtml = `<div class="reactions-row"><span class="reaction-label">Reaktion:</span>${
      REACTION_EMOJIS.map(em => `<button class="reaction-btn${(e.reactions||[]).includes(em)?" reacted":""}" data-emoji="${em}">${em}</button>`).join("")
    }</div>`;
    el.innerHTML = `<div class="entry-meta"><span class="entry-date" title="${dsFull}">${dsRel}</span>${moodEl}${chips}${editedBadge}</div><div class="entry-text">${safe}</div>${unlockLabel}${reactionsHtml}<button class="entry-edit-btn" title="Bearbeiten">âœ</button><button class="entry-del" title="LÃ¶schen">âœ•</button>`;
    el.querySelector(".entry-del").addEventListener("click", ev => { ev.stopPropagation(); deleteEntry(e.id, el); });
    el.querySelector(".entry-edit-btn").addEventListener("click", ev => { ev.stopPropagation(); startEdit(e.id, el); });
    el.querySelectorAll(".reaction-btn").forEach(btn =>
      btn.addEventListener("click", ev => { ev.stopPropagation(); toggleReaction(e.id, btn.dataset.emoji, btn); })
    );
    historyList.appendChild(el);
  });

  if (galaxyView) drawGalaxy();
}

// â”€â”€ Breath widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BREATH_PHASES = [
  { label: "Einatmenâ€¦",  sec: 4,  scale: 1.9 },
  { label: "Haltenâ€¦",    sec: 7,  scale: 1.9 },
  { label: "Ausatmenâ€¦",  sec: 8,  scale: 1.0 },
];

function startBreath() {
  breathActive = true; breathOverlay.classList.add("visible");
  let phase = 0, remaining = BREATH_PHASES[0].sec;
  const inner  = document.getElementById("breathInner");
  const outer  = document.getElementById("breathOuter");
  const instr  = document.getElementById("breathInstruction");
  const cnt    = document.getElementById("breathCount");

  function applyPhase(p) {
    const ph = BREATH_PHASES[p];
    instr.textContent = ph.label;
    const dur = ph.sec + "s";
    inner.style.transition = `transform ${dur} ease-in-out`;
    outer.style.transition  = `transform ${dur} ease-in-out`;
    inner.style.transform   = `scale(${ph.scale})`;
    outer.style.transform   = `scale(${ph.scale})`;
    outer.style.borderColor = ph.scale > 1 ? "rgba(123,140,255,0.55)" : "rgba(123,140,255,0.15)";
  }
  applyPhase(0); cnt.textContent = remaining;

  breathTimer = setInterval(() => {
    if (!breathActive) { clearInterval(breathTimer); return; }
    remaining--;
    cnt.textContent = remaining;
    if (remaining <= 0) {
      phase = (phase + 1) % BREATH_PHASES.length;
      remaining = BREATH_PHASES[phase].sec;
      applyPhase(phase);
      cnt.textContent = remaining;
    }
  }, 1000);
}

function stopBreath() {
  breathActive = false;
  clearInterval(breathTimer);
  breathOverlay.classList.remove("visible");
  const inner = document.getElementById("breathInner");
  const outer = document.getElementById("breathOuter");
  inner.style.transition = outer.style.transition = "transform 0.5s ease";
  inner.style.transform  = outer.style.transform  = "scale(1)";
}

breathBtn.addEventListener("click",  startBreath);
breathClose.addEventListener("click", stopBreath);
document.addEventListener("keydown", e => { if (e.key === "Escape" && breathActive) stopBreath(); });

// â”€â”€ Period pill listeners (with fade) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".period-pill").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".period-pill").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderInsights(parseInt(btn.dataset.period), true);
  });
});

// â”€â”€ Insights collapse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
insightsCollapseBtn.addEventListener("click", () => {
  insightsCollapsed = !insightsCollapsed;
  insightsBody.classList.toggle("collapsed", insightsCollapsed);
  insightsCollapseBtn.textContent = insightsCollapsed ? "â–¸" : "â–¾";
});

// â”€â”€ Sparkline hover tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
moodSparkline.addEventListener("mousemove", ev => {
  const pts = moodSparkline._pts;
  const PAD = moodSparkline._PAD;
  if (!pts || !PAD) return;
  const rect  = moodSparkline.getBoundingClientRect();
  const mx    = ev.clientX - rect.left;
  const my    = ev.clientY - rect.top;
  let hit = null, minDist = 18;
  pts.forEach(p => {
    if (p.y == null) return;
    const dist = Math.hypot(p.x - mx, p.y - my);
    if (dist < minDist) { minDist = dist; hit = p; }
  });
  if (hit) {
    const dt  = new Date(hit.startMs);
    const ds  = dt.toLocaleDateString("de-DE", { day:"2-digit", month:"short" });
    document.getElementById("sttDate").textContent  = ds;
    document.getElementById("sttMood").textContent  = MOOD_EMOJI[Math.round(hit.avgMood)] || "";
    document.getElementById("sttCount").textContent = hit.count + (hit.count === 1 ? " Eintrag" : " EintrÃ¤ge");
    const tt = sparklineTooltip;
    tt.style.display = "block";
    let tx = hit.x + 12, ty = hit.y - 10;
    if (tx + 160 > rect.width)  tx = hit.x - 170;
    if (ty < 0)                 ty = hit.y + 14;
    tt.style.left = tx + "px"; tt.style.top = ty + "px";
    moodSparkline.style.cursor = "pointer";
  } else {
    sparklineTooltip.style.display = "none";
    moodSparkline.style.cursor = "crosshair";
  }
});
moodSparkline.addEventListener("mouseleave", () => {
  sparklineTooltip.style.display = "none";
});

// â”€â”€ Relative time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function relativeTime(ts) {
  const diff = Date.now() - ts;
  const min  = Math.floor(diff / 60000);
  const hr   = Math.floor(diff / 3600000);
  const day  = Math.floor(diff / 86400000);
  if (min < 1)    return "gerade eben";
  if (min < 60)   return `vor ${min} Min.`;
  if (hr  < 24)   return `vor ${hr} Std.`;
  if (day === 1)  return "gestern";
  if (day < 7)    return `vor ${day} Tagen`;
  if (day < 30)   return `vor ${Math.floor(day/7)} Wochen`;
  if (day < 365)  return `vor ${Math.floor(day/30)} Monaten`;
  return `vor ${Math.floor(day/365)} Jahren`;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
syncTheme();
renderHistory();
updateStreak();
renderMemoryCard();
restoreDraft();
renderInsights(14);
</script>
</body>
</html>
