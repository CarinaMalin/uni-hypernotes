<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Digitale Laborassistenz ‚Äì MVP</title>
  <style>
    /* ===== Basis (angelehnt an Karteikarten-Design) ===== */
    * { margin:0; padding:0; box-sizing:border-box; }
    :root{
      --bg-primary:#0a0d1a;
      --bg-secondary:#12151f;
      --bg-card:#1a1d2e;
      --bg-elevated:#1f2230;
      --accent:#7b8cff;
      --accent-soft:rgba(123,140,255,.16);
      --accent-hover:#8b9cff;
      --text:#f7f7ff;
      --text-muted:#a4aac5;
      --border:#2f3445;
      --success:#10b981;
      --warning:#f59e0b;
      --error:#ef4444;
      --radius:12px;
      --shadow:0 4px 20px rgba(0,0,0,.3);
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif;
      background: radial-gradient(circle at top, #2a3245 0, #10121a 45%, #05060a 100%);
      color:var(--text);
      min-height:100vh;
      padding:20px;
      line-height:1.6;
    }
    .container{ max-width:1200px; margin:0 auto; }

    /* ===== Header ===== */
    .header{
      display:flex; justify-content:space-between; align-items:center;
      flex-wrap:wrap; gap:14px;
      margin-bottom:22px;
    }
    .header-left h1{
      font-size:1.9em; font-weight:800; margin-bottom:4px;
      background:linear-gradient(135deg,var(--accent),var(--accent-hover));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .header-left p{ color:var(--text-muted); font-size:.95em; max-width:70ch; }
    .header-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    /* ===== Buttons & Inputs ===== */
    .btn{
      padding:12px 18px; border:none; border-radius:var(--radius);
      font-size:.95em; font-weight:700; cursor:pointer;
      transition:all .2s ease; display:inline-flex; align-items:center; gap:8px;
    }
    .btn-primary{ background:var(--accent); color:#fff; box-shadow:0 4px 16px rgba(123,140,255,.25); }
    .btn-primary:hover{ background:var(--accent-hover); transform:translateY(-2px); }
    .btn-secondary{ background:var(--bg-card); color:var(--text); border:1px solid var(--border); }
    .btn-secondary:hover{ border-color:var(--accent); background:var(--accent-soft); }
    .btn-danger{ background:rgba(239,68,68,.14); color:#ffb4b4; border:1px solid rgba(239,68,68,.35); }
    .btn-danger:hover{ background:rgba(239,68,68,.22); border-color:rgba(239,68,68,.6); }

    .input, .select, .textarea{
      width:100%;
      padding:12px 14px;
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text);
      font-size:.95em;
      transition:all .2s ease;
      font-family:inherit;
    }
    .textarea{ min-height:100px; resize:vertical; }
    .input:focus, .select:focus, .textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-soft);
    }
    .label{ font-size:.85em; color:var(--text-muted); margin-bottom:7px; font-weight:700; display:block; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:820px){ .row{ grid-template-columns:1fr; } }

    /* ===== Cards / Layout ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
      margin-top:14px;
    }
    .card{
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      transition:all .25s ease;
      box-shadow:0 2px 18px rgba(0,0,0,.18);
    }
    .card:hover{ border-color:var(--accent); transform:translateY(-3px); box-shadow:var(--shadow); }
    .card-title{ font-weight:800; margin-bottom:6px; font-size:1.05em; }
    .pill-row{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:.78em; color:var(--text-muted);
      padding:6px 10px; border-radius:999px;
      background:var(--bg-secondary);
      border:1px solid rgba(255,255,255,.06);
    }
    .pill strong{ color:var(--text); font-weight:800; }

    /* ===== Tabs ===== */
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 16px;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--bg-card);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      transition:all .2s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .tab:hover{ border-color:var(--accent); background:var(--accent-soft); }
    .tab.active{ background:var(--accent); border-color:var(--accent); color:#fff; }

    /* ===== Modal ===== */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.78);
      display:none; align-items:center; justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal.active{ display:flex; }
    .modal-content{
      width:min(980px, 100%);
      max-height:90vh;
      overflow:auto;
      background:var(--bg-elevated);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
    }
    .modal-header{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:12px;
    }
    .modal-header h2{ font-size:1.2em; font-weight:900; }
    .close{
      background:none; border:none; color:var(--text-muted);
      font-size:1.8em; cursor:pointer; line-height:1;
      padding:6px 10px; border-radius:10px;
    }
    .close:hover{ color:var(--text); background:rgba(255,255,255,.06); }

    /* ===== Experiment Detail / Lab Mode ===== */
    .split{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width:980px){ .split{ grid-template-columns:1fr; } }

    .step-card{
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-bottom:12px;
    }
    .step-top{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:8px;
    }
    .step-top h3{ font-size:1.05em; font-weight:900; }
    .muted{ color:var(--text-muted); font-size:.92em; }

    .kpi{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:12px;
      margin-top:12px;
    }
    .kpi .card{ padding:14px; }
    .kpi .value{ font-size:1.7em; font-weight:900; color:var(--accent); line-height:1.1; }
    .kpi .name{ color:var(--text-muted); font-size:.82em; margin-top:6px; font-weight:700; }

    .toast{
      position:fixed;
      left:50%; bottom:26px;
      transform:translateX(-50%) translateY(140%);
      background:var(--bg-elevated);
      border:1px solid var(--border);
      border-left:4px solid var(--accent);
      border-radius:14px;
      padding:14px 16px;
      display:flex; gap:10px; align-items:center;
      z-index:2000;
      box-shadow:0 10px 40px rgba(0,0,0,.55);
      transition:transform .25s ease;
      max-width:min(680px, 92vw);
    }
    .toast.show{ transform:translateX(-50%) translateY(0); }
    .toast .msg{ font-weight:700; }
    .toast .sub{ color:var(--text-muted); font-size:.9em; font-weight:600; }

    code.inline{
      background:var(--bg-secondary);
      padding:2px 6px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,.06);
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:.9em;
    }

    .divider{ height:1px; background:rgba(255,255,255,.06); margin:14px 0; }
    .hint{
      background:rgba(123,140,255,.12);
      border:1px solid rgba(123,140,255,.25);
      padding:12px 14px;
      border-radius:14px;
      color:#dfe4ff;
      font-weight:650;
    }

    /* ===== Embed mode (for Hypernotes iframe) ===== */
    .embed body{ padding:0; background: transparent; }
    .embed body .container{ max-width: 100%; padding: 12px; }
    .embed body .header{ display:none; }
    .embed body #viewHome .row{ grid-template-columns: 1fr; } /* simpler in iframe */
    .embed body .modal{ padding:0; }
    .embed body .modal-content{ width:100%; max-height:100vh; border-radius:0; }

  </style>
</head>
<body>
  <div class="container">
    <div id="embedBar" style="display:none; position:sticky; top:0; z-index:50; margin-bottom:12px;">
      <div class="card" style="padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:900;">üß™ Labor</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-secondary" id="btnOpenStandalone" style="padding:10px 14px;">‚ÜóÔ∏è Vollbild</button>
        </div>
      </div>
    </div>


    <div class="header">
      <div class="header-left">
        <h1>üß™ Digitale Laborassistenz</h1>
        <p>Saubere Messdaten + reproduzierbare Protokolle. Offline-f√§hig, iPad-first, ‚Äûnur Zahlen tippen‚Äú ‚Äì danach Auto-Protokoll.</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" id="btnExport">‚¨áÔ∏è Export (JSON)</button>
        <button class="btn btn-secondary" id="btnImport">‚¨ÜÔ∏è Import</button>
        <button class="btn btn-primary" id="btnNewExp">‚ûï Neuer Versuch</button>
      </div>
    </div>

    <div id="viewHome">
      <div class="row">
        <div class="card">
          <div class="card-title">üîé Schnellfilter</div>
          <div class="row" style="margin-top:10px;">
            <div>
              <label class="label">Fach</label>
              <select class="select" id="filterSubject"></select>
            </div>
            <div>
              <label class="label">Suche (Titel/Kategorie)</label>
              <input class="input" id="filterSearch" placeholder="z.B. Titration, Destillation, Kinetik ..." />
            </div>
          </div>
          <div class="divider"></div>
          <div class="hint">
            MVP: Du kannst Versuche bauen ‚Üí Lab Mode f√ºhrt dich Schritt f√ºr Schritt ‚Üí am Ende gibt‚Äôs ein Auto-Protokoll.
          </div>
        </div>

        <div class="card">
          <div class="card-title">üìå Stats</div>
          <div class="kpi">
            <div class="card">
              <div class="value" id="kpiExperiments">0</div>
              <div class="name">Versuche</div>
            </div>
            <div class="card">
              <div class="value" id="kpiSessions">0</div>
              <div class="name">Sessions</div>
            </div>
            <div class="card">
              <div class="value" id="kpiLast">‚Äì</div>
              <div class="name">Letzte Session</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid" id="expGrid" aria-label="Versuchs√ºbersicht"></div>
      <div class="card" id="emptyState" style="display:none; margin-top:16px;">
        <div class="card-title">Noch keine Versuche</div>
        <div class="muted">Klick auf <strong>‚ÄûNeuer Versuch‚Äú</strong> und bau dir schnell ein Template.</div>
      </div>
    </div>

    <div id="viewDetail" style="display:none;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
          <div>
            <div class="muted" id="detailMeta"></div>
            <div class="card-title" style="font-size:1.4em;" id="detailTitle"></div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-secondary" id="btnBack">‚Üê Zur√ºck</button>
            <button class="btn btn-secondary" id="btnEdit">‚úèÔ∏è Bearbeiten</button>
            <button class="btn btn-primary" id="btnStartLab">‚ñ∂Ô∏è Lab Mode starten</button>
          </div>
        </div>

        <div class="tabs" style="margin-top:14px;">
          <button class="tab active" data-tab="prep">üß† Vorbereitung</button>
          <button class="tab" data-tab="run">‚è±Ô∏è Durchf√ºhrung</button>
          <button class="tab" data-tab="post">üßæ Nachbereitung</button>
          <button class="tab" data-tab="sessions">üìö Sessions</button>
        </div>

        <div id="tabPrep"></div>
        <div id="tabRun" style="display:none;"></div>
        <div id="tabPost" style="display:none;"></div>
        <div id="tabSessions" style="display:none;"></div>
      </div>
    </div>

    <!-- ===== Modal: Builder ===== -->
    <div class="modal" id="modalBuilder" role="dialog" aria-modal="true" aria-labelledby="builderTitle">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="builderTitle">Versuch erstellen / bearbeiten</h2>
          <button class="close" id="builderClose" aria-label="Schlie√üen">√ó</button>
        </div>

        <div class="row">
          <div>
            <label class="label">Fach (z.B. Allgemeine Chemie, Physikalische Chemie, Biochemie)</label>
            <input class="input" id="bSubject" placeholder="Allgemeine Chemie" />
          </div>
          <div>
            <label class="label">Kategorie (z.B. Titration, Destillation, Kinetik)</label>
            <input class="input" id="bCategory" placeholder="Titration" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label class="label">Titel</label>
          <input class="input" id="bTitle" placeholder="S√§ure-Base-Titration einer unbekannten Probe" />
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label class="label">Ziel (kurz)</label>
            <input class="input" id="bGoal" placeholder="Konzentration der Probe bestimmen" />
          </div>
          <div>
            <label class="label">Prinzip (kurz)</label>
            <input class="input" id="bPrinciple" placeholder="Neutralisation + Indikator/Endpunkt" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label class="label">Begriffe / ‚ÄûX‚Äú-W√∂rter (Komma-getrennt)</label>
          <input class="input" id="bTerms" placeholder="Titrant, Probe, Indikator, B√ºrette" />
          <div class="muted" style="margin-top:6px;">
            Diese Begriffe kannst du sp√§ter pro Eingabe ausw√§hlen ‚Äì damit Fragen wie ‚ÄûWie viel mL wurden von <code class="inline">Titrant</code> verbraucht?‚Äú sauber klingen.
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="card" style="margin:0;">
            <div class="card-title">‚è±Ô∏è Schritte</div>
            <div class="muted">Jeder Schritt kann 0‚Äì3 Inputs haben. Lab Mode fragt Inputs der Reihe nach ab.</div>

            <div id="stepsList" style="margin-top:10px;"></div>

            <button class="btn btn-secondary" id="btnAddStep" style="margin-top:10px;">‚ûï Schritt hinzuf√ºgen</button>
          </div>

          <div class="card" style="margin:0;">
            <div class="card-title">üßæ Nachbereitung</div>
            <div class="muted">Nur grob: Report-Sections & Tabellen (sp√§ter bauen wir das pro Template aus).</div>

            <div style="margin-top:10px;">
              <label class="label">Report-Sections (eine pro Zeile)</label>
              <textarea class="textarea" id="bReportSections" placeholder="Ziel&#10;Ger√§te & Chemikalien&#10;Sicherheit&#10;Durchf√ºhrung (kurz)&#10;Messdaten&#10;Auswertung&#10;Diskussion&#10;Fazit"></textarea>
            </div>

            <div style="margin-top:10px;">
              <label class="label">Auto-Tabellen (eine pro Zeile, nur Titel)</label>
              <textarea class="textarea" id="bTables" placeholder="Messwerte&#10;Berechnungen"></textarea>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn btn-danger" id="btnDeleteExp" style="display:none;">üóëÔ∏è L√∂schen</button>
          <button class="btn btn-secondary" id="btnCancelBuilder">Abbrechen</button>
          <button class="btn btn-primary" id="btnSaveBuilder">Speichern</button>
        </div>
      </div>
    </div>

    <!-- ===== Modal: Lab Mode ===== -->
    <div class="modal" id="modalLab" role="dialog" aria-modal="true" aria-labelledby="labTitle">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="labTitle">Lab Mode</h2>
          <button class="close" id="labClose" aria-label="Schlie√üen">√ó</button>
        </div>

        <div class="split">
          <div>
            <div class="step-card">
              <div class="step-top">
                <div>
                  <div class="muted" id="labStepMeta">Schritt 1 / 1</div>
                  <h3 id="labStepTitle">‚Äì</h3>
                </div>
                <div class="pill"><strong id="labTimer">00:00</strong> <span>Session</span></div>
              </div>
              <div class="muted" id="labStepAction">‚Äì</div>

              <div class="divider"></div>

              <div id="labInputArea"></div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                <button class="btn btn-secondary" id="btnLabPrev">‚Üê Zur√ºck</button>
                <button class="btn btn-secondary" id="btnLabFlag">üö© Abweichung / Problem</button>
                <button class="btn btn-primary" id="btnLabNext">Weiter ‚Üí</button>
              </div>
            </div>

            <div class="card">
              <div class="card-title">üìù Notizen (optional)</div>
              <textarea class="textarea" id="labNotes" placeholder="Kurznotiz, Beobachtung, Farbe, Geruch, Probleme ..."></textarea>
              <div class="muted" style="margin-top:8px;">Notizen werden im Auto-Protokoll als Abschnitt ‚ÄûBeobachtungen/Flags‚Äú gesammelt.</div>
            </div>
          </div>

          <div>
            <div class="card">
              <div class="card-title">üìå Session-√úbersicht</div>
              <div class="muted" id="labSummaryMeta">‚Äì</div>
              <div class="divider"></div>
              <div id="labLiveLog" class="muted"></div>
              <div class="divider"></div>
              <button class="btn btn-primary" id="btnFinishLab">‚úÖ Session beenden & Protokoll</button>
            </div>

            <div class="card">
              <div class="card-title">‚ÑπÔ∏è Kurz-Disclaimer</div>
              <div class="muted">
                Diese Assistenz ersetzt keine Laboranweisung/Aufsicht. Sie hilft beim strukturierten Erfassen von Daten (Einheitenf√ºhrung, Reihenfolge, Protokoll).
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===== Modal: Import (simple) ===== -->
    <input type="file" id="fileImport" accept="application/json" style="display:none;" />

    <div class="toast" id="toast">
      <div>
        <div class="msg" id="toastMsg">‚Äì</div>
        <div class="sub" id="toastSub">‚Äì</div>
      </div>
      <button class="btn btn-secondary" id="toastOk" style="padding:8px 12px;">OK</button>
    </div>

  </div>

<script>
/* =========================================================
   Digitale Laborassistenz ‚Äì MVP
   - localStorage: experiments + sessions
   - Builder: steps + inputs
   - Lab Mode: sequential input prompting + timestamps
   ========================================================= */

let LS_KEY = "labassist_v1";
const __params = new URLSearchParams(location.search);
if(__params.get("namespace")){
  LS_KEY = `labassist_v1__${__params.get("namespace")}`;
}
const __embed = __params.get("embed")==="1";
if(__embed){ document.documentElement.classList.add("embed"); }

const nowISO = () => new Date().toISOString();
const pad2 = (n) => String(n).padStart(2,"0");

function loadState(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw){
    return {
      experiments: [],
      sessions: []
    };
  }
  try { return JSON.parse(raw); } catch(e){ return { experiments:[], sessions:[] }; }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

let state = loadState();
// ===== Embed helpers =====
if(__embed){
  const bar = document.getElementById("embedBar");
  if(bar) bar.style.display = "block";
  const btn = document.getElementById("btnOpenStandalone");
  if(btn){
    btn.onclick = ()=> window.open(location.pathname + location.search.replace("embed=1","embed=0"), "_blank", "noopener");
  }
}

let currentExpId = null;
let editingExpId = null;

/* ===== Toast ===== */
const toastEl = document.getElementById("toast");
const toastMsg = document.getElementById("toastMsg");
const toastSub = document.getElementById("toastSub");
document.getElementById("toastOk").onclick = () => toastEl.classList.remove("show");
function showToast(msg, sub=""){
  toastMsg.textContent = msg;
  toastSub.textContent = sub;
  toastEl.classList.add("show");
}

/* ===== Simple IDs ===== */
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

/* ===== Defaults ===== */
function normalizeSubject(s){
  const t = (s||"").trim();
  return t.length ? t : "Unbekanntes Fach";
}
function normalizeCategory(s){
  const t = (s||"").trim();
  return t.length ? t : "Unkategorisiert";
}
function safeArrFromLines(text){
  return (text||"").split("\n").map(x=>x.trim()).filter(Boolean);
}
function safeArrFromCSV(text){
  return (text||"").split(",").map(x=>x.trim()).filter(Boolean);
}

/* ===== UI Elements ===== */
const viewHome = document.getElementById("viewHome");
const viewDetail = document.getElementById("viewDetail");
const expGrid = document.getElementById("expGrid");
const emptyState = document.getElementById("emptyState");

const filterSubject = document.getElementById("filterSubject");
const filterSearch = document.getElementById("filterSearch");

const kpiExperiments = document.getElementById("kpiExperiments");
const kpiSessions = document.getElementById("kpiSessions");
const kpiLast = document.getElementById("kpiLast");

/* ===== Detail UI ===== */
const detailMeta = document.getElementById("detailMeta");
const detailTitle = document.getElementById("detailTitle");
const tabPrep = document.getElementById("tabPrep");
const tabRun = document.getElementById("tabRun");
const tabPost = document.getElementById("tabPost");
const tabSessions = document.getElementById("tabSessions");

/* ===== Builder UI ===== */
const modalBuilder = document.getElementById("modalBuilder");
const builderClose = document.getElementById("builderClose");
const btnCancelBuilder = document.getElementById("btnCancelBuilder");
const btnSaveBuilder = document.getElementById("btnSaveBuilder");
const btnDeleteExp = document.getElementById("btnDeleteExp");

const bSubject = document.getElementById("bSubject");
const bCategory = document.getElementById("bCategory");
const bTitle = document.getElementById("bTitle");
const bGoal = document.getElementById("bGoal");
const bPrinciple = document.getElementById("bPrinciple");
const bTerms = document.getElementById("bTerms");
const bReportSections = document.getElementById("bReportSections");
const bTables = document.getElementById("bTables");

const stepsList = document.getElementById("stepsList");
const btnAddStep = document.getElementById("btnAddStep");

/* ===== Lab UI ===== */
const modalLab = document.getElementById("modalLab");
const labClose = document.getElementById("labClose");
const labTitle = document.getElementById("labTitle");
const labStepMeta = document.getElementById("labStepMeta");
const labStepTitle = document.getElementById("labStepTitle");
const labStepAction = document.getElementById("labStepAction");
const labInputArea = document.getElementById("labInputArea");
const btnLabPrev = document.getElementById("btnLabPrev");
const btnLabNext = document.getElementById("btnLabNext");
const btnLabFlag = document.getElementById("btnLabFlag");
const btnFinishLab = document.getElementById("btnFinishLab");
const labNotes = document.getElementById("labNotes");
const labTimer = document.getElementById("labTimer");
const labLiveLog = document.getElementById("labLiveLog");
const labSummaryMeta = document.getElementById("labSummaryMeta");

/* ===== Import/Export ===== */
document.getElementById("btnExport").onclick = () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "labassist_export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  showToast("Export erstellt", "Datei wurde heruntergeladen.");
};

document.getElementById("btnImport").onclick = () => document.getElementById("fileImport").click();
document.getElementById("fileImport").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const parsed = JSON.parse(text);
    if(!parsed || !Array.isArray(parsed.experiments) || !Array.isArray(parsed.sessions)){
      showToast("Import fehlgeschlagen", "JSON-Format passt nicht (erwartet: {experiments:[], sessions:[]}).");
      return;
    }
    state = parsed;
    saveState();
    renderAll();
    showToast("Import erfolgreich", "Daten wurden √ºbernommen.");
  }catch(err){
    showToast("Import fehlgeschlagen", "Datei ist kein g√ºltiges JSON.");
  }finally{
    e.target.value = "";
  }
});

/* ===== Home Actions ===== */
document.getElementById("btnNewExp").onclick = () => openBuilder(null);

/* ===== Navigation ===== */
document.getElementById("btnBack").onclick = () => {
  currentExpId = null;
  viewDetail.style.display = "none";
  viewHome.style.display = "block";
  renderHome();
};
document.getElementById("btnEdit").onclick = () => openBuilder(currentExpId);

/* ===== Tabs ===== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    tabPrep.style.display = (t==="prep") ? "block" : "none";
    tabRun.style.display = (t==="run") ? "block" : "none";
    tabPost.style.display = (t==="post") ? "block" : "none";
    tabSessions.style.display = (t==="sessions") ? "block" : "none";
  });
});

/* =========================================================
   Render: Home
   ========================================================= */
function renderKPIs(){
  kpiExperiments.textContent = state.experiments.length;
  kpiSessions.textContent = state.sessions.length;
  if(state.sessions.length){
    const last = state.sessions.slice().sort((a,b)=> (b.started_at||"").localeCompare(a.started_at||""))[0];
    kpiLast.textContent = (last.started_at||"").slice(0,10);
  } else {
    kpiLast.textContent = "‚Äì";
  }
}

function subjectsList(){
  const set = new Set(state.experiments.map(e=>normalizeSubject(e.subject)));
  const arr = ["Alle F√§cher", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
  return arr;
}

function renderFilters(){
  const subs = subjectsList();
  const current = filterSubject.value || "Alle F√§cher";
  filterSubject.innerHTML = subs.map(s=> `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  filterSubject.value = subs.includes(current) ? current : "Alle F√§cher";
}

filterSubject.addEventListener("change", renderHome);
filterSearch.addEventListener("input", renderHome);

function renderHome(){
  renderKPIs();
  renderFilters();

  const subj = filterSubject.value || "Alle F√§cher";
  const q = (filterSearch.value||"").trim().toLowerCase();

  let exps = state.experiments.slice();

  if(subj !== "Alle F√§cher"){
    exps = exps.filter(e => normalizeSubject(e.subject) === subj);
  }
  if(q){
    exps = exps.filter(e => (
      (e.title||"").toLowerCase().includes(q) ||
      normalizeCategory(e.category).toLowerCase().includes(q)
    ));
  }

  expGrid.innerHTML = "";
  emptyState.style.display = (state.experiments.length===0) ? "block" : "none";

  exps.sort((a,b)=> (a.title||"").localeCompare(b.title||""));

  for(const exp of exps){
    const sessionsCount = state.sessions.filter(s=>s.experiment_id === exp.id).length;
    const lastSession = state.sessions
      .filter(s=>s.experiment_id === exp.id)
      .sort((a,b)=> (b.started_at||"").localeCompare(a.started_at||""))[0];

    const card = document.createElement("div");
    card.className = "card";
    card.tabIndex = 0;
    card.role = "button";
    card.innerHTML = `
      <div class="card-title">üß∑ ${escapeHtml(exp.title || "Unbenannter Versuch")}</div>
      <div class="muted">${escapeHtml(normalizeSubject(exp.subject))} ¬∑ ${escapeHtml(normalizeCategory(exp.category))}</div>
      <div class="pill-row">
        <div class="pill">üß† Prep: <strong>${exp.overview?.goal ? "‚úì" : "‚Äî"}</strong></div>
        <div class="pill">‚è±Ô∏è Steps: <strong>${(exp.run?.steps||[]).length}</strong></div>
        <div class="pill">üìö Sessions: <strong>${sessionsCount}</strong></div>
        <div class="pill">üïí Last: <strong>${lastSession ? (lastSession.started_at||"").slice(0,10) : "‚Äî"}</strong></div>
      </div>
      <div class="divider"></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-secondary" data-act="open">√ñffnen</button>
        <button class="btn btn-primary" data-act="start">Lab Mode</button>
      </div>
    `;

    card.addEventListener("click", (ev)=>{
      const act = ev.target?.dataset?.act;
      if(act === "start"){
        openDetail(exp.id);
        startLab(exp.id);
        return;
      }
      if(act === "open"){
        openDetail(exp.id);
        return;
      }
      // click anywhere: open
      openDetail(exp.id);
    });

    card.addEventListener("keydown", (ev)=>{
      if(ev.key==="Enter" || ev.key===" "){
        ev.preventDefault();
        openDetail(exp.id);
      }
    });

    expGrid.appendChild(card);
  }
}

/* =========================================================
   Render: Detail
   ========================================================= */
function openDetail(expId){
  currentExpId = expId;
  viewHome.style.display = "none";
  viewDetail.style.display = "block";
  renderDetail();
}

function renderDetail(){
  const exp = state.experiments.find(e=>e.id===currentExpId);
  if(!exp){
    showToast("Fehler", "Versuch nicht gefunden.");
    return;
  }
  detailMeta.textContent = `${normalizeSubject(exp.subject)} ¬∑ ${normalizeCategory(exp.category)} ¬∑ ID: ${exp.id}`;
  detailTitle.textContent = exp.title || "Unbenannter Versuch";

  // Prep
  const terms = (exp.terms||[]);
  tabPrep.innerHTML = `
    <div class="row" style="margin-top:10px;">
      <div class="step-card" style="margin:0;">
        <div class="card-title">üß† √úberblick</div>
        <div class="muted"><strong>Ziel:</strong> ${escapeHtml(exp.overview?.goal || "‚Äî")}</div>
        <div class="muted"><strong>Prinzip:</strong> ${escapeHtml(exp.overview?.principle_short || "‚Äî")}</div>
        <div class="divider"></div>
        <div class="muted"><strong>Begriffe:</strong> ${terms.length ? terms.map(t=>`<code class="inline">${escapeHtml(t)}</code>`).join(" ") : "‚Äî"}</div>
      </div>

      <div class="step-card" style="margin:0;">
        <div class="card-title">‚úÖ Quick-Start</div>
        <div class="muted">1) Starte Lab Mode ¬∑ 2) Tippe nur Zahlen ¬∑ 3) Am Ende exportierst du das Protokoll.</div>
        <div class="divider"></div>
        <div class="hint">Sp√§ter: Apparatus-Cards, Storyboard & typische Fehler (v3_prep Ausbau).</div>
      </div>
    </div>
  `;

  // Run
  const steps = exp.run?.steps || [];
  tabRun.innerHTML = steps.length ? steps.map((s, idx)=>{
    const inpCount = (s.inputs||[]).length;
    return `
      <div class="step-card">
        <div class="step-top">
          <div>
            <div class="muted">Schritt ${idx+1}</div>
            <h3>${escapeHtml(s.title || "‚Äî")}</h3>
          </div>
          <div class="pill">Inputs: <strong>${inpCount}</strong></div>
        </div>
        <div class="muted">${escapeHtml(s.action || "")}</div>
        ${inpCount ? `
          <div class="divider"></div>
          <div class="muted"><strong>Inputs:</strong><br/>
            ${s.inputs.map(i=>renderInputBadge(i, exp)).join("<br/>")}
          </div>
        ` : ""}
      </div>
    `;
  }).join("") : `
    <div class="step-card">
      <div class="card-title">Noch keine Schritte</div>
      <div class="muted">Bearbeiten ‚Üí Schritte hinzuf√ºgen ‚Üí Inputs definieren.</div>
    </div>
  `;

  // Post
  const sections = exp.post?.report_sections || [];
  const tables = exp.post?.auto_tables || [];
  tabPost.innerHTML = `
    <div class="row" style="margin-top:10px;">
      <div class="step-card" style="margin:0;">
        <div class="card-title">üßæ Report-Sections</div>
        <div class="muted">${sections.length ? ("<ol style='padding-left:1.2em; margin-top:8px;'>" + sections.map(x=>`<li>${escapeHtml(x)}</li>`).join("") + "</ol>") : "‚Äî"}</div>
      </div>
      <div class="step-card" style="margin:0;">
        <div class="card-title">üìä Auto-Tabellen</div>
        <div class="muted">${tables.length ? ("<ul style='padding-left:1.2em; margin-top:8px;'>" + tables.map(x=>`<li>${escapeHtml(x.title||x)}</li>`).join("") + "</ul>") : "‚Äî"}</div>
        <div class="divider"></div>
        <div class="hint">Sp√§ter: Einheiten-Engine + Berechnungs-Module pro Template.</div>
      </div>
    </div>
  `;

  // Sessions
  const sess = state.sessions
    .filter(s=>s.experiment_id===exp.id)
    .sort((a,b)=> (b.started_at||"").localeCompare(a.started_at||""));

  tabSessions.innerHTML = sess.length ? sess.map(s=>{
    const count = s.entries?.length || 0;
    const flags = (s.flags||[]).length;
    return `
      <div class="step-card">
        <div class="step-top">
          <div>
            <div class="muted">${escapeHtml((s.started_at||"").replace("T"," ").slice(0,16))}</div>
            <h3>Session ${escapeHtml(s.id)}</h3>
          </div>
          <div class="pill">Eintr√§ge: <strong>${count}</strong></div>
        </div>
        <div class="pill-row">
          <div class="pill">Flags: <strong>${flags}</strong></div>
          <div class="pill">Dauer: <strong>${formatDuration(s.duration_s||0)}</strong></div>
        </div>
        <div class="divider"></div>
        <button class="btn btn-secondary" onclick="openProtocol('${s.id}')">üßæ Protokoll ansehen</button>
      </div>
    `;
  }).join("") : `
    <div class="step-card">
      <div class="card-title">Noch keine Sessions</div>
      <div class="muted">Starte den Lab Mode, um eine Session zu erzeugen.</div>
    </div>
  `;
}

function renderInputBadge(inp, exp){
  const term = inp.term_key ? (exp.terms||[]).find(t=>t===inp.term_key) : null;
  const label = buildQuestionLabel(inp, term);
  const unit = inp.unit_default || "";
  return `‚Ä¢ ${escapeHtml(label)} <span class="pill" style="display:inline-flex; margin-left:8px;">Unit: <strong>${escapeHtml(unit||"‚Äî")}</strong></span>`;
}

function buildQuestionLabel(inp, term){
  // Wenn label "{X}" enth√§lt, ersetzen
  const raw = inp.label || inp.key || "Wert";
  if(raw.includes("{X}")){
    return raw.replaceAll("{X}", term || "X");
  }
  // sonst: "Label (Term)" wenn Term gesetzt
  if(term){
    return `${raw} (${term})`;
  }
  return raw;
}

/* =========================================================
   Builder: Steps / Inputs UI
   ========================================================= */
function openBuilder(expId){
  editingExpId = expId;
  const exp = expId ? state.experiments.find(e=>e.id===expId) : null;

  document.getElementById("builderTitle").textContent = exp ? "Versuch bearbeiten" : "Neuen Versuch erstellen";
  btnDeleteExp.style.display = exp ? "inline-flex" : "none";

  bSubject.value = exp ? normalizeSubject(exp.subject) : "Allgemeine Chemie";
  bCategory.value = exp ? normalizeCategory(exp.category) : "Titration";
  bTitle.value = exp ? (exp.title||"") : "";
  bGoal.value = exp ? (exp.overview?.goal||"") : "";
  bPrinciple.value = exp ? (exp.overview?.principle_short||"") : "";
  bTerms.value = exp ? (exp.terms||[]).join(", ") : "Titrant, Probe";

  bReportSections.value = exp ? (exp.post?.report_sections||[]).join("\n") :
`Ziel
Ger√§te & Chemikalien
Sicherheit
Durchf√ºhrung (kurz)
Messdaten
Auswertung
Diskussion
Fazit`;

  bTables.value = exp ? (exp.post?.auto_tables||[]).map(t=>t.title||t).join("\n") :
`Messwerte
Berechnungen`;

  // Steps
  const steps = exp ? (exp.run?.steps||[]) : [
    {
      id: uid("step"),
      title: "Setup vorbereiten",
      action: "Aufbau bereitstellen, Glasger√§te pr√ºfen, Startbedingungen notieren.",
      inputs: []
    },
    {
      id: uid("step"),
      title: "Messung durchf√ºhren",
      action: "Relevante Werte erfassen und ggf. Messpunkte wiederholen.",
      inputs: [
        { key:"temp", label:"Wie viel Temperatur betr√§gt {X}?", type:"number", unit_default:"¬∞C", unit_allowed:["¬∞C"], term_key:"Probe" }
      ]
    }
  ];

  builderStepsDraft = JSON.parse(JSON.stringify(steps));
  renderBuilderSteps();

  modalBuilder.classList.add("active");
}

function closeBuilder(){ modalBuilder.classList.remove("active"); }
builderClose.onclick = closeBuilder;
btnCancelBuilder.onclick = closeBuilder;

btnDeleteExp.onclick = () => {
  if(!editingExpId) return;
  const exp = state.experiments.find(e=>e.id===editingExpId);
  if(!exp) return;

  // l√∂schen
  state.experiments = state.experiments.filter(e=>e.id!==editingExpId);
  // Sessions (optional) mit l√∂schen
  state.sessions = state.sessions.filter(s=>s.experiment_id!==editingExpId);

  saveState();
  closeBuilder();
  currentExpId = null;
  viewDetail.style.display = "none";
  viewHome.style.display = "block";
  renderAll();
  showToast("Gel√∂scht", "Versuch und Sessions wurden entfernt.");
};

let builderStepsDraft = [];

btnAddStep.onclick = () => {
  builderStepsDraft.push({
    id: uid("step"),
    title: "Neuer Schritt",
    action: "Kurzer Imperativ-Satz.",
    inputs: []
  });
  renderBuilderSteps();
};

function renderBuilderSteps(){
  const terms = safeArrFromCSV(bTerms.value || "");

  stepsList.innerHTML = builderStepsDraft.map((s, idx)=>{
    const inputs = s.inputs || [];
    return `
      <div class="step-card" style="margin:10px 0 0;">
        <div class="step-top">
          <div>
            <div class="muted">Schritt ${idx+1}</div>
            <h3 contenteditable="true" data-role="stepTitle" data-id="${s.id}" style="outline:none;">${escapeHtml(s.title||"")}</h3>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-secondary" data-act="addInput" data-id="${s.id}" style="padding:8px 12px;">‚ûï Input</button>
            <button class="btn btn-danger" data-act="delStep" data-id="${s.id}" style="padding:8px 12px;">üóëÔ∏è</button>
          </div>
        </div>

        <label class="label" style="margin-top:8px;">Action (kurz)</label>
        <textarea class="textarea" data-role="stepAction" data-id="${s.id}" style="min-height:70px;">${escapeHtml(s.action||"")}</textarea>

        ${inputs.length ? `
          <div class="divider"></div>
          <div class="muted" style="font-weight:800; margin-bottom:8px;">Inputs</div>
          ${inputs.map((inp, j)=>renderInputEditor(inp, s.id, terms, j)).join("")}
        ` : `
          <div class="divider"></div>
          <div class="muted">Keine Inputs in diesem Schritt.</div>
        `}
      </div>
    `;
  }).join("");

  // bind events
  stepsList.querySelectorAll("[data-act='delStep']").forEach(btn=>{
    btn.onclick = () => {
      const id = btn.dataset.id;
      builderStepsDraft = builderStepsDraft.filter(x=>x.id!==id);
      renderBuilderSteps();
    };
  });
  stepsList.querySelectorAll("[data-act='addInput']").forEach(btn=>{
    btn.onclick = () => {
      const stepId = btn.dataset.id;
      const step = builderStepsDraft.find(x=>x.id===stepId);
      if(!step) return;
      if((step.inputs||[]).length >= 3){
        showToast("Limit", "Max. 3 Inputs pro Schritt (MVP-Limit).");
        return;
      }
      step.inputs = step.inputs || [];
      step.inputs.push({
        key: `val_${(step.inputs.length+1)}`,
        label: "Wie viel ‚Ä¶ betr√§gt {X}?",
        type: "number",
        unit_default: "mL",
        unit_allowed: ["mL"],
        term_key: terms[0] || ""
      });
      renderBuilderSteps();
    };
  });

  // live update on edit
  stepsList.querySelectorAll("[data-role='stepAction']").forEach(el=>{
    el.oninput = () => {
      const id = el.dataset.id;
      const step = builderStepsDraft.find(x=>x.id===id);
      if(step) step.action = el.value;
    };
  });
  stepsList.querySelectorAll("[data-role='stepTitle']").forEach(el=>{
    el.oninput = () => {
      const id = el.dataset.id;
      const step = builderStepsDraft.find(x=>x.id===id);
      if(step) step.title = el.textContent.trim();
    };
  });

  // input editor bindings
  stepsList.querySelectorAll("[data-role='inp']").forEach(el=>{
    el.oninput = () => {
      const stepId = el.dataset.step;
      const idx = Number(el.dataset.idx);
      const field = el.dataset.field;
      const step = builderStepsDraft.find(x=>x.id===stepId);
      if(!step) return;
      const inp = step.inputs?.[idx];
      if(!inp) return;
      inp[field] = el.value;
    };
    el.onchange = el.oninput;
  });

  stepsList.querySelectorAll("[data-act='delInput']").forEach(btn=>{
    btn.onclick = () => {
      const stepId = btn.dataset.step;
      const idx = Number(btn.dataset.idx);
      const step = builderStepsDraft.find(x=>x.id===stepId);
      if(!step) return;
      step.inputs.splice(idx,1);
      renderBuilderSteps();
    };
  });
}

function renderInputEditor(inp, stepId, terms, idx){
  const termOptions = ["", ...terms].map(t=>`<option value="${escapeHtml(t)}" ${t===inp.term_key?"selected":""}>${escapeHtml(t||"(kein Begriff)")}</option>`).join("");
  return `
    <div class="card" style="margin:0 0 10px; padding:12px; border-radius:14px;">
      <div class="row">
        <div>
          <label class="label">Key (intern, eindeutig)</label>
          <input class="input" data-role="inp" data-step="${stepId}" data-idx="${idx}" data-field="key" value="${escapeHtml(inp.key||"")}" />
        </div>
        <div>
          <label class="label">Begriff (X)</label>
          <select class="select" data-role="inp" data-step="${stepId}" data-idx="${idx}" data-field="term_key">
            ${termOptions}
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="label">Frage/Label (optional {X} Platzhalter)</label>
        <input class="input" data-role="inp" data-step="${stepId}" data-idx="${idx}" data-field="label"
               value="${escapeHtml(inp.label||"")}" />
        <div class="muted" style="margin-top:6px;">
          Beispiel: <code class="inline">Wie viel mL wurden von {X} verwendet?</code>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label class="label">Unit default</label>
          <input class="input" data-role="inp" data-step="${stepId}" data-idx="${idx}" data-field="unit_default"
                 value="${escapeHtml(inp.unit_default||"")}" placeholder="mL, g, ¬∞C, mol/L, min ..." />
        </div>
        <div>
          <label class="label">Unit allowed (CSV)</label>
          <input class="input" data-role="inp" data-step="${stepId}" data-idx="${idx}" data-field="unit_allowed"
                 value="${escapeHtml((inp.unit_allowed||[]).join(", "))}" placeholder="mL, L" />
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; margin-top:10px;">
        <button class="btn btn-danger" data-act="delInput" data-step="${stepId}" data-idx="${idx}" style="padding:8px 12px;">Input l√∂schen</button>
      </div>
    </div>
  `;
}

btnSaveBuilder.onclick = () => {
  const subject = normalizeSubject(bSubject.value);
  const category = normalizeCategory(bCategory.value);
  const title = (bTitle.value||"").trim();
  if(!title){
    showToast("Fehlt", "Bitte gib einen Titel an.");
    return;
  }

  const terms = safeArrFromCSV(bTerms.value);
  // fix inputs unit_allowed from CSV string to array
  const steps = builderStepsDraft.map(s=>{
    const inputs = (s.inputs||[]).map(inp=>{
      const allowed = Array.isArray(inp.unit_allowed)
        ? inp.unit_allowed
        : safeArrFromCSV(inp.unit_allowed);
      return {
        key: (inp.key||"").trim() || uid("key"),
        label: (inp.label||"").trim(),
        type: "number",
        unit_default: (inp.unit_default||"").trim(),
        unit_allowed: allowed,
        term_key: (inp.term_key||"").trim()
      };
    });
    return {
      id: s.id || uid("step"),
      title: (s.title||"").trim(),
      action: (s.action||"").trim(),
      inputs
    };
  });

  // ensure keys are unique inside experiment (simple check)
  const allKeys = steps.flatMap(s => (s.inputs||[]).map(i=>i.key));
  const dup = allKeys.filter((k, i)=> allKeys.indexOf(k)!==i);
  if(dup.length){
    showToast("Keys doppelt", "Bitte Input-Keys eindeutig machen: " + Array.from(new Set(dup)).join(", "));
    return;
  }

  const expObj = {
    id: editingExpId || uid("exp"),
    subject,
    category,
    title,
    terms,
    overview: {
      goal: (bGoal.value||"").trim(),
      principle_short: (bPrinciple.value||"").trim(),
      safety_short: [],
      disposal_short: "",
      needs_review: false,
      review_notes: []
    },
    run: { steps },
    post: {
      report_sections: safeArrFromLines(bReportSections.value),
      auto_tables: safeArrFromLines(bTables.value).map(t=>({ title:t })),
      calculations: []
    },
    updated_at: nowISO(),
    created_at: editingExpId ? (state.experiments.find(e=>e.id===editingExpId)?.created_at || nowISO()) : nowISO()
  };

  if(editingExpId){
    state.experiments = state.experiments.map(e=> e.id===editingExpId ? expObj : e);
  }else{
    state.experiments.push(expObj);
  }

  saveState();
  closeBuilder();
  renderAll();
  showToast("Gespeichert", "Versuch wurde aktualisiert.");
};

/* =========================================================
   Lab Mode
   ========================================================= */
let lab = null; // active session runtime
let labTick = null;

document.getElementById("btnStartLab").onclick = () => startLab(currentExpId);

function startLab(expId){
  const exp = state.experiments.find(e=>e.id===expId);
  if(!exp){
    showToast("Fehler", "Versuch nicht gefunden.");
    return;
  }
  const steps = exp.run?.steps || [];
  if(!steps.length){
    showToast("Fehlt", "Versuch hat noch keine Schritte.");
    return;
  }

  const sessionId = uid("sess");
  const startedAt = nowISO();

  lab = {
    session_id: sessionId,
    experiment_id: exp.id,
    started_at: startedAt,
    step_index: 0,
    input_index: 0,
    entries: [],  // {ts, step_id, input_key, value, unit, label}
    flags: [],    // {ts, step_id, note}
    notes: ""
  };

  labTitle.textContent = `Lab Mode ‚Äì ${exp.title}`;
  labNotes.value = "";
  labLiveLog.innerHTML = "";
  labSummaryMeta.textContent = `${normalizeSubject(exp.subject)} ¬∑ ${normalizeCategory(exp.category)} ¬∑ Session: ${sessionId}`;

  modalLab.classList.add("active");

  // timer
  const startedMs = Date.now();
  clearInterval(labTick);
  labTick = setInterval(()=>{
    const s = Math.floor((Date.now()-startedMs)/1000);
    labTimer.textContent = `${pad2(Math.floor(s/60))}:${pad2(s%60)}`;
  }, 300);

  renderLabStep();
}

function closeLab(){
  modalLab.classList.remove("active");
  clearInterval(labTick);
  labTick = null;
  lab = null;
}
labClose.onclick = closeLab;

btnLabPrev.onclick = () => {
  if(!lab) return;
  // move back within step inputs
  const exp = state.experiments.find(e=>e.id===lab.experiment_id);
  const steps = exp.run.steps;

  if(lab.input_index > 0){
    lab.input_index--;
  }else if(lab.step_index > 0){
    lab.step_index--;
    const prevStep = steps[lab.step_index];
    lab.input_index = Math.max(((prevStep.inputs||[]).length - 1), 0);
  }else{
    showToast("Start", "Du bist schon am Anfang.");
    return;
  }
  renderLabStep();
};

btnLabNext.onclick = () => {
  if(!lab) return;
  if(!commitCurrentInputIfAny()) return; // validation
  moveForward();
};

btnLabFlag.onclick = () => {
  if(!lab) return;
  const exp = state.experiments.find(e=>e.id===lab.experiment_id);
  const step = exp.run.steps[lab.step_index];
  const note = prompt("Kurze Abweichung / Problem (wird ins Protokoll √ºbernommen):");
  if(!note) return;
  lab.flags.push({ ts: nowISO(), step_id: step?.id || "", note });
  updateLiveLog();
  showToast("Flag gespeichert", "Wird im Protokoll unter Beobachtungen/Flags gelistet.");
};

btnFinishLab.onclick = () => finishLab();

function commitCurrentInputIfAny(){
  const exp = state.experiments.find(e=>e.id===lab.experiment_id);
  const step = exp.run.steps[lab.step_index];
  const inputs = step.inputs || [];
  if(!inputs.length) return true;

  const inp = inputs[lab.input_index];
  if(!inp) return true;

  const valEl = document.getElementById("labVal");
  if(!valEl) return true;

  const raw = (valEl.value||"").trim();
  if(raw === ""){
    showToast("Fehlt", "Bitte Wert eingeben (oder Schritt ohne Input verwenden).");
    return false;
  }
  const num = Number(raw.replace(",", "."));
  if(Number.isNaN(num)){
    showToast("Ung√ºltig", "Bitte nur Zahlen eingeben.");
    return false;
  }

  // save entry
  const term = inp.term_key || "";
  const label = buildQuestionLabel(inp, term);
  lab.entries.push({
    ts: nowISO(),
    step_id: step.id,
    step_title: step.title,
    input_key: inp.key,
    label,
    value: num,
    unit: inp.unit_default || ""
  });

  updateLiveLog();
  return true;
}

function moveForward(){
  const exp = state.experiments.find(e=>e.id===lab.experiment_id);
  const steps = exp.run.steps;
  const step = steps[lab.step_index];
  const inputs = step.inputs || [];

  if(inputs.length && lab.input_index < inputs.length - 1){
    lab.input_index++;
  }else{
    // next step
    if(lab.step_index < steps.length - 1){
      lab.step_index++;
      lab.input_index = 0;
    }else{
      // end
      finishLab();
      return;
    }
  }
  renderLabStep();
}

function renderLabStep(){
  const exp = state.experiments.find(e=>e.id===lab.experiment_id);
  const steps = exp.run.steps;

  const step = steps[lab.step_index];
  labStepMeta.textContent = `Schritt ${lab.step_index+1} / ${steps.length}`;
  labStepTitle.textContent = step.title || "‚Äî";
  labStepAction.textContent = step.action || "";

  // input area
  const inputs = step.inputs || [];
  if(!inputs.length){
    labInputArea.innerHTML = `
      <div class="hint">Keine Eingaben in diesem Schritt. Du kannst direkt weiter.</div>
    `;
  }else{
    const inp = inputs[lab.input_index];
    const term = inp.term_key || "";
    const label = buildQuestionLabel(inp, term);
    const unit = inp.unit_default || "";
    labInputArea.innerHTML = `
      <div class="card" style="margin:0; padding:14px; border-radius:14px;">
        <div class="muted" style="font-weight:900;">Input ${lab.input_index+1} / ${inputs.length}</div>
        <div class="divider"></div>
        <div class="card-title" style="font-size:1.05em;">${escapeHtml(label)}</div>
        <div class="muted">Einheit: <code class="inline">${escapeHtml(unit||"‚Äî")}</code> ¬∑ Eingabe: nur Zahl</div>
        <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;">
          <input class="input" id="labVal" inputmode="decimal" placeholder="z.B. 80" style="max-width:260px;" />
          <span class="pill">‚è∫Ô∏è Autosave</span>
        </div>
        <div class="muted" style="margin-top:8px;">
          Tipp: Verwende <code class="inline">,</code> oder <code class="inline">.</code> als Dezimaltrenner.
        </div>
      </div>
    `;
  }
}

function updateLiveLog(){
  if(!lab) return;
  const last10 = lab.entries.slice(-10).reverse();
  const flags = lab.flags.slice(-5).reverse();

  const entriesHtml = last10.length ? last10.map(e=>(
    `<div>‚Ä¢ <strong>${escapeHtml(e.label)}</strong>: ${escapeHtml(String(e.value))} ${escapeHtml(e.unit||"")} <span class="muted">(${escapeHtml((e.ts||"").slice(11,19))})</span></div>`
  )).join("") : `<div class="muted">Noch keine Messwerte.</div>`;

  const flagsHtml = flags.length ? flags.map(f=>(
    `<div>üö© ${escapeHtml(f.note)} <span class="muted">(${escapeHtml((f.ts||"").slice(11,19))})</span></div>`
  )).join("") : `<div class="muted">Keine Flags.</div>`;

  labLiveLog.innerHTML = `
    <div class="muted" style="font-weight:900; margin-bottom:6px;">Letzte Eintr√§ge</div>
    ${entriesHtml}
    <div class="divider"></div>
    <div class="muted" style="font-weight:900; margin-bottom:6px;">Flags</div>
    ${flagsHtml}
  `;
}

function finishLab(){
  if(!lab) return;
  // capture notes
  lab.notes = (labNotes.value||"").trim();

  const durationS = parseTimerToSeconds(labTimer.textContent || "00:00");

  // persist session
  const sessObj = {
    id: lab.session_id,
    experiment_id: lab.experiment_id,
    started_at: lab.started_at,
    finished_at: nowISO(),
    duration_s: durationS,
    entries: lab.entries,
    flags: lab.flags,
    notes: lab.notes
  };
  state.sessions.push(sessObj);
  saveState();

  closeLab();
  renderAll();
  showToast("Session gespeichert", "Du kannst sie im Versuch unter ‚ÄûSessions‚Äú √∂ffnen.");

  // open protocol right away
  openDetail(sessObj.experiment_id);
  // switch to sessions tab
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  const sessionsTabBtn = document.querySelector(".tab[data-tab='sessions']");
  sessionsTabBtn.classList.add("active");
  tabPrep.style.display="none"; tabRun.style.display="none"; tabPost.style.display="none"; tabSessions.style.display="block";
  renderDetail();

  // auto-open protocol view
  openProtocol(sessObj.id);
}

/* =========================================================
   Protocol Preview (simple)
   ========================================================= */
function openProtocol(sessionId){
  const sess = state.sessions.find(s=>s.id===sessionId);
  if(!sess){
    showToast("Fehler", "Session nicht gefunden.");
    return;
  }
  const exp = state.experiments.find(e=>e.id===sess.experiment_id);
  if(!exp){
    showToast("Fehler", "Experiment zur Session fehlt.");
    return;
  }

  const sections = exp.post?.report_sections || [];
  const tables = exp.post?.auto_tables || [];

  const md = buildProtocolMarkdown(exp, sess, sections, tables);

  // show as modal-ish via prompt-like overlay (reuse builder modal for simplicity)
  const html = `
    <div class="modal-header">
      <h2>üßæ Auto-Protokoll (Preview)</h2>
      <button class="close" id="protoClose">√ó</button>
    </div>
    <div class="muted">Session: ${escapeHtml(sess.id)} ¬∑ ${escapeHtml((sess.started_at||"").replace("T"," ").slice(0,16))} ¬∑ Dauer: ${escapeHtml(formatDuration(sess.duration_s||0))}</div>
    <div class="divider"></div>
    <textarea class="textarea" style="min-height:380px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:.9em;">${escapeHtml(md)}</textarea>
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
      <button class="btn btn-secondary" id="protoCopy">üìã Kopieren</button>
      <button class="btn btn-primary" id="protoDownload">‚¨áÔ∏è Download (.md)</button>
    </div>
  `;

  // create a lightweight modal
  const overlay = document.createElement("div");
  overlay.className = "modal active";
  overlay.innerHTML = `<div class="modal-content">${html}</div>`;
  document.body.appendChild(overlay);

  overlay.querySelector("#protoClose").onclick = ()=> overlay.remove();
  overlay.addEventListener("click", (e)=>{ if(e.target===overlay) overlay.remove(); });

  overlay.querySelector("#protoCopy").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(md);
      showToast("Kopiert", "Protokoll wurde in die Zwischenablage kopiert.");
    }catch(e){
      showToast("Nicht m√∂glich", "Clipboard nicht verf√ºgbar (Browser/Permissions).");
    }
  };

  overlay.querySelector("#protoDownload").onclick = ()=>{
    const blob = new Blob([md], {type:"text/markdown"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${exp.title.replaceAll(" ","_")}_${sess.id}.md`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
}

function buildProtocolMarkdown(exp, sess, sections, tables){
  const lines = [];
  lines.push(`# ${exp.title}`);
  lines.push(`**Fach:** ${normalizeSubject(exp.subject)}  `);
  lines.push(`**Kategorie:** ${normalizeCategory(exp.category)}  `);
  lines.push(`**Datum:** ${(sess.started_at||"").slice(0,10)}  `);
  lines.push(`**Session:** ${sess.id}`);
  lines.push("");
  lines.push(`## Ziel`);
  lines.push(exp.overview?.goal ? `- ${exp.overview.goal}` : `- ‚Äî`);
  lines.push("");
  lines.push(`## Durchf√ºhrung (Kurz)`);
  (exp.run?.steps||[]).forEach((s,i)=> lines.push(`${i+1}. ${s.title}${s.action?` ‚Äì ${s.action}`:""}`));
  lines.push("");

  // Measurements table (simple)
  lines.push(`## Messdaten`);
  if(sess.entries?.length){
    lines.push(`| Zeit | Schritt | Key | Label | Wert | Einheit |`);
    lines.push(`|---|---|---|---|---:|---|`);
    for(const e of sess.entries){
      lines.push(`| ${(e.ts||"").slice(11,19)} | ${safePipe(e.step_title||"")} | ${safePipe(e.input_key||"")} | ${safePipe(e.label||"")} | ${e.value} | ${safePipe(e.unit||"")} |`);
    }
  }else{
    lines.push(`‚Äî`);
  }
  lines.push("");

  // Flags & Notes
  lines.push(`## Beobachtungen / Flags`);
  const hasFlags = (sess.flags||[]).length > 0;
  const hasNotes = (sess.notes||"").trim().length > 0;

  if(hasFlags){
    for(const f of sess.flags){
      lines.push(`- [${(f.ts||"").slice(11,19)}] ${f.note}`);
    }
  }
  if(hasNotes){
    lines.push("");
    lines.push(`**Notizen:**`);
    lines.push(sess.notes);
  }
  if(!hasFlags && !hasNotes){
    lines.push(`‚Äî`);
  }
  lines.push("");

  // Post structure placeholders
  if(sections.length){
    lines.push(`## Report-Struktur (Template)`);
    sections.forEach((s)=> lines.push(`- ${s}`));
    lines.push("");
  }
  if(tables.length){
    lines.push(`## Tabellen (Template)`);
    tables.forEach((t)=> lines.push(`- ${t.title||t}`));
    lines.push("");
  }

  lines.push(`---`);
  lines.push(`_Auto-Protokoll erzeugt aus Session-Daten (MVP). Sp√§ter: Einheiten-Engine + Berechnungen._`);
  return lines.join("\n");
}

/* =========================================================
   Helpers
   ========================================================= */
function formatDuration(s){
  const mm = Math.floor((s||0)/60);
  const ss = (s||0)%60;
  return `${pad2(mm)}:${pad2(ss)}`;
}
function parseTimerToSeconds(mmss){
  const [m,s] = (mmss||"00:00").split(":").map(x=>Number(x)||0);
  return m*60 + s;
}
function safePipe(s){ return String(s||"").replaceAll("|","\\|"); }
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   Boot
   ========================================================= */
function renderAll(){
  renderHome();
  if(currentExpId){
    renderDetail();
  }
}

/* =========================================================
   UI PATCH v1:
   - Lab Mode: Big Question + better spacing
   - Protocol Preview: render modern HTML instead of Markdown textarea
   - Download protocol as .html (Word-friendly)
   ========================================================= */

/* ---------- 1) Inject extra CSS (one-time) ---------- */
(function injectUIPatchCSS(){
  if(document.getElementById("uiPatchCSS")) return;
  const style = document.createElement("style");
  style.id = "uiPatchCSS";
  style.textContent = `
    /* ===== Lab Mode: more whitespace & hierarchy ===== */
    .lab-qwrap{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 16px;
    }
    .lab-qmeta{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .lab-qmeta .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(123,140,255,.12);
      border:1px solid rgba(123,140,255,.25);
      color:#dfe4ff;
      font-weight:800;
      font-size:.85em;
    }
    .lab-question{
      font-size: 1.25em;
      font-weight: 950;
      line-height: 1.25;
      letter-spacing: .2px;
      margin: 10px 0 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .lab-sub{
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 12px;
    }
    .lab-inputrow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 10px;
    }
    .lab-inputrow .unitPill{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      font-weight: 900;
      color: var(--text);
    }
    .lab-actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 14px;
      justify-content: space-between;
      align-items:center;
    }
    .lab-actions .left, .lab-actions .right{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .btn.btn-ghost{
      background: transparent;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
    }
    .btn.btn-ghost:hover{
      border-color: var(--accent);
      background: rgba(123,140,255,.10);
    }

    /* ===== Protocol: Modern report styles ===== */
    .proto-wrap{
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }
    .proto-header{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      align-items:flex-start;
      margin-bottom: 12px;
    }
    .proto-title{
      font-size:1.4em;
      font-weight: 950;
      line-height:1.2;
      margin-bottom:6px;
    }
    .proto-meta{
      color: var(--text-muted);
      font-weight: 700;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .proto-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color: var(--text-muted);
      font-size:.85em;
      font-weight: 800;
    }
    .proto-section{
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .proto-section h3{
      font-size: 1.05em;
      font-weight: 950;
      margin-bottom: 8px;
      color: var(--text);
    }
    .proto-cardgrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .proto-card{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
    }
    .proto-k{
      color: var(--text-muted);
      font-weight: 800;
      font-size: .86em;
      margin-bottom: 6px;
    }
    .proto-v{
      font-weight: 950;
      font-size: 1.15em;
      color: var(--text);
    }
    .proto-table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      margin-top: 10px;
    }
    .proto-table th, .proto-table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: .93em;
    }
    .proto-table th{
      text-align:left;
      color: var(--text-muted);
      font-weight: 900;
      background: rgba(255,255,255,.03);
    }
    .proto-muted{ color: var(--text-muted); font-weight: 700; }
    .proto-list{ margin: 8px 0 0 18px; }
    .proto-list li{ margin: 6px 0; }
  `;
  document.head.appendChild(style);
})();

/* ---------- 2) Improve Lab Mode rendering (bigger question) ---------- */
const _renderLabStep_ORIG = renderLabStep;
renderLabStep = function(){
  // call original to set base content, then overwrite labInputArea with nicer layout
  if(!lab) return;
  const exp = state.experiments.find(e=>e.id===lab.experiment_id);
  if(!exp) return;
  const steps = exp.run.steps;
  const step = steps[lab.step_index];

  labStepMeta.textContent = `Schritt ${lab.step_index+1} / ${steps.length}`;
  labStepTitle.textContent = step.title || "‚Äî";
  labStepAction.textContent = step.action || "";

  const inputs = step.inputs || [];

  if(!inputs.length){
    labInputArea.innerHTML = `
      <div class="hint">Keine Eingaben in diesem Schritt. Du kannst direkt weiter.</div>
    `;
  } else {
    const inp = inputs[lab.input_index];
    const term = inp.term_key || "";
    const label = buildQuestionLabel(inp, term);
    const unit = inp.unit_default || "";

    labInputArea.innerHTML = `
      <div class="lab-qwrap">
        <div class="lab-qmeta">
          <div class="badge">Input ${lab.input_index+1} / ${inputs.length}</div>
          <div class="proto-chip">Einheit: <strong style="color:var(--text);">${escapeHtml(unit||"‚Äî")}</strong></div>
        </div>

        <div class="lab-question">${escapeHtml(label)}</div>
        <div class="lab-sub">Bitte nur die Zahl eingeben. Dezimal: <code class="inline">,</code> oder <code class="inline">.</code></div>

        <div class="lab-inputrow">
          <input class="input" id="labVal" inputmode="decimal" placeholder="z.B. 7,0" style="max-width:320px; font-size:1.05em; font-weight:900;" />
          <div class="unitPill">${escapeHtml(unit||"")}</div>
          <span class="pill">‚è∫Ô∏è Autosave</span>
        </div>
      </div>
    `;
  }
};

/* =========================================================
   WORD EXPORT PATCH v1:
   - Download as .doc (Word-HTML; tables stay tables)
   - Copy (Word) as HTML to clipboard (tables stay tables)
   - Auto conclusion text from measured data
   ========================================================= */

/* ---------- Auto conclusion helpers ---------- */
function autoConclusionHTML(exp, sess){
  const e = sess.entries || [];
  const byKey = (k) => e.slice().reverse().find(x => x.input_key===k)?.value;

  // Hydronium template
  if(typeof TEMPLATE_IDS !== "undefined" && exp.id === TEMPLATE_IDS.HYDRONIUM){
    const phH = byKey("ph_hcl");
    const phW = byKey("ph_water");
    const phN = byKey("ph_nacl");
    if([phH,phW,phN].every(v => typeof v === "number")){
      const ok = (phH < phW) && (phH < phN);
      const strength =
        phH <= 2 ? "stark sauer" :
        phH <= 4 ? "deutlich sauer" :
        phH <= 6 ? "leicht sauer" : "nicht klar sauer";
      const neutralW = (phW>=6 && phW<=8) ? "nahe neutral" : "nicht neutral";
      const neutralN = (phN>=6 && phN<=8) ? "nahe neutral" : "nicht neutral";

      return `
        <div class="proto-muted">
          Auf Basis der Skalenablesungen zeigte die <strong>verd√ºnnte HCl</strong> mit <strong>pH = ${phH}</strong> eine <strong>${strength}</strong> reagierende L√∂sung.
          Im Vergleich lagen <strong>dest. Wasser</strong> (pH = ${phW}, ${neutralW}) und <strong>NaCl-L√∂sung</strong> (pH = ${phN}, ${neutralN}) h√∂her.
          ${ok
            ? `Damit ist der <strong>Hydroniumionen-Nachweis</strong> √ºber den Farbumschlag des Indikatorpapiers <strong>plausibel gelungen</strong>.`
            : `Die Werte sind <strong>auff√§llig</strong> (HCl nicht am niedrigsten). Wahrscheinlich beeinflusst durch Skalenvergleich/Benetzung/Kontamination; Wiederholung unter kontrollierten Bedingungen empfohlen.`
          }
        </div>
      `;
    }
    return `<div class="proto-muted">Fazit kann erst automatisch erzeugt werden, wenn pH(Wasser), pH(HCl) und pH(NaCl) eingetragen sind.</div>`;
  }

  // NaOH hygroscopicity template
  if(typeof TEMPLATE_IDS !== "undefined" && exp.id === TEMPLATE_IDS.HYGRO_NAOH){
    const s0 = byKey("t0_surface_score");
    const s30 = byKey("t30_surface_score");
    const ph0 = byKey("t0_ph");
    const ph30 = byKey("t30_ph");

    if(typeof s0 === "number" && typeof s30 === "number"){
      const trend = s30 - s0;
      const trendText = trend > 0 ? "nahm zu" : trend < 0 ? "nahm ab" : "blieb gleich";
      const ok = trend > 0;

      return `
        <div class="proto-muted">
          √úber die Beobachtungszeit zeigte das NaOH-Pl√§tzchen eine Oberfl√§chen√§nderung (Score t0=${s0}, t30=${s30}); die Oberfl√§chenverfl√ºssigung <strong>${trendText}</strong>.
          ${ok
            ? `Das spricht f√ºr eine <strong>sichtbare Hygroskopizit√§t</strong> (Wasseraufnahme aus der Luft).`
            : `Es war <strong>keine deutliche Zunahme</strong> erkennbar; m√∂gliche Gr√ºnde: trockene Luft, altes Pl√§tzchen, Abdeckung/Luftstrom.`
          }
          ${
            (typeof ph0==="number" && typeof ph30==="number")
              ? ` Der pH blieb im basischen Bereich (t0 pH=${ph0}, t30 pH=${ph30}), konsistent mit <strong>OH‚Åª</strong>-Dominanz.`
              : ``
          }
        </div>
      `;
    }
    return `<div class="proto-muted">Fazit kann erst automatisch erzeugt werden, wenn mindestens Oberfl√§che t0 und t30 eingetragen sind.</div>`;
  }

  return `<div class="proto-muted">‚Äî</div>`;
}

/* ---------- protocolHTML (modern report) ---------- */
function protocolHTML(exp, sess){
  const dt = (sess.started_at||"").replace("T"," ").slice(0,16);
  const subj = normalizeSubject(exp.subject);
  const cat = normalizeCategory(exp.category);

  const entries = sess.entries || [];
  const flags = sess.flags || [];

  // ===== Auto-Fazit (robust: ID + Titel-Fallback) =====
  let autoFazitTitle = "9) Fazit (Auto)";
  let autoFazitHTML  = `<div class="proto-muted">Auto-Fazit wird erzeugt, sobald genug Messwerte vorliegen.</div>`;

  const titleLower = (exp.title || "").toLowerCase();
  const idIsHydronium = (typeof TEMPLATE_IDS !== "undefined" && exp.id === TEMPLATE_IDS.HYDRONIUM);
  const idIsNaOH      = (typeof TEMPLATE_IDS !== "undefined" && exp.id === TEMPLATE_IDS.HYGRO_NAOH);
  const looksHydronium = titleLower.includes("hydronium") || titleLower.includes("indikatorpapier") || titleLower.includes("salzs√§ure") || titleLower.includes("hcl");
  const looksNaOH      = titleLower.includes("hygroskop") || titleLower.includes("naoh");

  function val(key){ return entries.slice().reverse().find(e=>e.input_key===key)?.value; }
  function hasNum(x){ return typeof x === "number" && !Number.isNaN(x); }

  // --- Hydronium (uni-tauglich) ---
  if(idIsHydronium || looksHydronium){
    autoFazitTitle = "9) Fazit (Auto ‚Äì Hydronium-Nachweis)";
    const phW = val("ph_water");
    const phH = val("ph_hcl");
    const phN = val("ph_nacl");
    const light = val("light_score");
    const wet = val("paper_wetness_score");

    if([phW,phH,phN].every(hasNum)){
      const ok = (phH < phW) && (phH < phN);
      const acidClass =
        phH <= 2 ? "stark sauer" :
        phH <= 4 ? "deutlich sauer" :
        phH <= 6 ? "leicht sauer" : "nur schwach sauer/unklar";
      const wNeutral = (phW>=6 && phW<=8);
      const nNeutral = (phN>=6 && phN<=8);

      autoFazitHTML = `
        <div class="proto-card">
          <div class="proto-k">Erwartung</div>
          <div class="proto-muted">HCl zeigt einen deutlich niedrigeren pH (sauer) als dest. Wasser und NaCl (nahe neutral).</div>
        </div>

        <div class="proto-card" style="margin-top:10px;">
          <div class="proto-k">Beobachtung (Skalenablesung)</div>
          <div class="proto-muted">
            pH(HCl) = <strong>${phH}</strong> (${acidClass}); 
            pH(Wasser) = <strong>${phW}</strong> (${wNeutral ? "nahe neutral" : "abweichend vom Neutralbereich"});
            pH(NaCl) = <strong>${phN}</strong> (${nNeutral ? "nahe neutral" : "abweichend vom Neutralbereich"}).
          </div>
        </div>

        <div class="proto-card" style="margin-top:10px; border-color:rgba(123,140,255,.25);">
          <div class="proto-k">Bewertung / Schlussfolgerung</div>
          <div class="proto-muted">
            ${ok
              ? `Da <strong>pH(HCl)</strong> am niedrigsten ist, ist der <strong>Hydroniumionen-Nachweis</strong> √ºber den Farbumschlag des Indikatorpapiers <strong>plausibel best√§tigt</strong>.`
              : `Da <strong>pH(HCl)</strong> nicht eindeutig am niedrigsten ist, ist das Ergebnis <strong>nicht eindeutig</strong>. Eine Wiederholung unter kontrollierten Bedingungen ist sinnvoll.`
            }
          </div>
        </div>

        <div class="proto-card" style="margin-top:10px;">
          <div class="proto-k">M√∂gliche Ursachen/Verbesserung</div>
          <ul class="proto-list">
            <li><strong>Skalenablesung:</strong> konstante Beleuchtung, Skala direkt daneben halten.</li>
            <li><strong>Benetzung:</strong> Streifen gleichm√§√üig anfeuchten (keine Pf√ºtzen/keine trockenen Stellen).</li>
            <li><strong>Kontamination:</strong> getrennte Pipetten/Sp√ºlen zwischen L√∂sungen.</li>
            <li><strong>Material:</strong> Indikatorpapier trocken lagern; Dose sofort schlie√üen.</li>
            ${hasNum(light) ? `<li><strong>Beleuchtung-Score:</strong> ${light}/5</li>` : ``}
            ${hasNum(wet) ? `<li><strong>Benetzung-Score:</strong> ${wet}/5</li>` : ``}
          </ul>
        </div>
      `;
    } else {
      autoFazitHTML = `<div class="proto-muted">F√ºr das Auto-Fazit bitte pH(Wasser), pH(HCl) und pH(NaCl) eintragen.</div>`;
    }
  }

  // --- NaOH Hygroskopizit√§t (uni-tauglich) ---
  if(idIsNaOH || looksNaOH){
    autoFazitTitle = "9) Fazit (Auto ‚Äì Hygroskopizit√§t NaOH)";
    const s0 = val("t0_surface_score");
    const s10 = val("t10_surface_score");
    const s20 = val("t20_surface_score");
    const s30 = val("t30_surface_score");
    const ph0 = val("t0_ph");
    const ph10 = val("t10_ph");
    const ph20 = val("t20_ph");
    const ph30 = val("t30_ph");
    const hum = val("humidity_est");
    const light = val("light_score");

    if(hasNum(s0) && hasNum(s30)){
      const trend = s30 - s0;
      const ok = trend > 0;
      const trendText = trend > 0 ? `zunahm (+${trend})` : trend < 0 ? `abnahm (${trend})` : `konstant blieb (0)`;

      const phInfo = [ph0,ph10,ph20,ph30].some(hasNum)
        ? `pH-Verlauf: ${hasNum(ph0)?`t0=${ph0}`:"t0=‚Äî"}, ${hasNum(ph10)?`t10=${ph10}`:"t10=‚Äî"}, ${hasNum(ph20)?`t20=${ph20}`:"t20=‚Äî"}, ${hasNum(ph30)?`t30=${ph30}`:"t30=‚Äî"}.`
        : `pH-Werte wurden nicht vollst√§ndig erfasst.`;

      autoFazitHTML = `
        <div class="proto-card">
          <div class="proto-k">Erwartung</div>
          <div class="proto-muted">NaOH nimmt Wasser aus der Luft auf ‚Üí Oberfl√§che wird feuchter/gel√∂ster; Indikatorpapier bleibt basisch.</div>
        </div>

        <div class="proto-card" style="margin-top:10px;">
          <div class="proto-k">Beobachtung (Zeitverlauf)</div>
          <div class="proto-muted">
            Oberfl√§che-Score: t0=<strong>${s0}</strong>, t10=<strong>${hasNum(s10)?s10:"‚Äî"}</strong>, t20=<strong>${hasNum(s20)?s20:"‚Äî"}</strong>, t30=<strong>${s30}</strong> ‚Üí Ver√§nderung ${trendText}.<br>
            ${escapeHtml(phInfo)}
          </div>
        </div>

        <div class="proto-card" style="margin-top:10px; border-color:rgba(123,140,255,.25);">
          <div class="proto-k">Bewertung / Schlussfolgerung</div>
          <div class="proto-muted">
            ${ok
              ? `Die Zunahme des Oberfl√§chen-Scores spricht f√ºr eine <strong>sichtbare Hygroskopizit√§t</strong> (Wasseraufnahme aus der Luft).`
              : `Es zeigt sich <strong>keine klare Zunahme</strong>. M√∂gliche Gr√ºnde: trockene Luft, Luftstrom/Abdeckung oder vorgesch√§digtes NaOH.`
            }
          </div>
        </div>

        <div class="proto-card" style="margin-top:10px;">
          <div class="proto-k">Verbesserung</div>
          <ul class="proto-list">
            <li><strong>Luftfeuchte:</strong> Effekt st√§rker bei h√∂herer Feuchte (Score ${hasNum(hum)?hum:"‚Äî"}/5).</li>
            <li><strong>Material:</strong> frisches NaOH verwenden, Dose sofort schlie√üen.</li>
            <li><strong>Ablese-Bedingungen:</strong> konstantes Licht (Score ${hasNum(light)?light:"‚Äî"}/5) & gleiche Skala.</li>
          </ul>
        </div>
      `;
    } else {
      autoFazitHTML = `<div class="proto-muted">F√ºr das Auto-Fazit bitte mindestens Oberfl√§che t0 und t30 eintragen.</div>`;
    }
  }


  const stepLines = (exp.run?.steps||[]).map((s,i)=> `
    <li><strong>${escapeHtml(String(i+1))}. ${escapeHtml(s.title||"")}</strong>
      <div class="proto-muted">${escapeHtml(s.action||"")}</div>
    </li>
  `).join("");

  const rows = entries.map(e => `
    <tr>
      <td class="proto-muted">${escapeHtml((e.ts||"").slice(11,19))}</td>
      <td>${escapeHtml(e.step_title||"")}</td>
      <td class="proto-muted">${escapeHtml(e.input_key||"")}</td>
      <td>${escapeHtml(e.label||"")}</td>
      <td style="text-align:right; font-weight:950;">${escapeHtml(String(e.value))}</td>
      <td class="proto-muted">${escapeHtml(e.unit||"")}</td>
    </tr>
  `).join("");

  const flagsHtml = (flags.length || (sess.notes||"").trim()) ? `
    ${flags.length ? `<ul class="proto-list">${flags.map(f=>`<li>üö© <strong>${escapeHtml((f.ts||"").slice(11,19))}</strong> ‚Äì ${escapeHtml(f.note||"")}</li>`).join("")}</ul>` : `<div class="proto-muted">Keine Flags.</div>`}
    ${(sess.notes||"").trim() ? `<div style="margin-top:10px;"><div class="proto-k">Notizen</div><div class="proto-card">${escapeHtml(sess.notes).replaceAll("\n","<br>")}</div></div>` : ""}
  ` : `<div class="proto-muted">‚Äî</div>`;

  const safety = (exp.overview?.safety_short||[]);
  const safetyHtml = safety.length ? `<ul class="proto-list">${safety.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : `<div class="proto-muted">‚Äî</div>`;



  // Keep your auto-check
  let autoInsight = "";
  try{
    if(typeof TEMPLATE_IDS !== "undefined" && exp.id === TEMPLATE_IDS.HYDRONIUM){
      const phH = entries.slice().reverse().find(e=>e.input_key==="ph_hcl")?.value;
      const phW = entries.slice().reverse().find(e=>e.input_key==="ph_water")?.value;
      const phN = entries.slice().reverse().find(e=>e.input_key==="ph_nacl")?.value;
      if([phH,phW,phN].every(v=>typeof v==="number")){
        const ok = (phH < phW) && (phH < phN);
        autoInsight = `<div class="proto-card" style="border-color:rgba(123,140,255,.25);">
          <div class="proto-k">Auto-Check</div>
          <div class="proto-v">${ok ? "‚úÖ Plausibel" : "‚ö†Ô∏è Auff√§llig"}</div>
          <div class="proto-muted" style="margin-top:6px;">pH(HCl)=${phH}, pH(Wasser)=${phW}, pH(NaCl)=${phN}</div>
        </div>`;
      }
    }
    if(typeof TEMPLATE_IDS !== "undefined" && exp.id === TEMPLATE_IDS.HYGRO_NAOH){
      const s0 = entries.slice().reverse().find(e=>e.input_key==="t0_surface_score")?.value;
      const s30 = entries.slice().reverse().find(e=>e.input_key==="t30_surface_score")?.value;
      if([s0,s30].every(v=>typeof v==="number")){
        const trend = s30 - s0;
        autoInsight = `<div class="proto-card" style="border-color:rgba(123,140,255,.25);">
          <div class="proto-k">Auto-Check</div>
          <div class="proto-v">${trend>0 ? "‚úÖ Hygroskopizit√§t sichtbar" : "‚ö†Ô∏è Wenig √Ñnderung"}</div>
          <div class="proto-muted" style="margin-top:6px;">Trend Oberfl√§che (30‚Äì0 min): ${trend>=0?`+${trend}`:trend}</div>
        </div>`;
      }
    }
  }catch(e){}

  return `
  <div class="proto-wrap" id="protoWrap">
    <div class="proto-header">
      <div>
        <div class="proto-title">${escapeHtml(exp.title||"Protokoll")}</div>
        <div class="proto-meta">
          <span class="proto-chip">üß™ ${escapeHtml(subj)}</span>
          <span class="proto-chip">üìÅ ${escapeHtml(cat)}</span>
          <span class="proto-chip">üóìÔ∏è ${escapeHtml(dt)}</span>
          <span class="proto-chip">‚è±Ô∏è ${escapeHtml(formatDuration(sess.duration_s||0))}</span>
        </div>
      </div>
      <div class="proto-chip">Session: <strong style="color:var(--text);">${escapeHtml(sess.id)}</strong></div>
    </div>

    ${autoInsight ? `<div class="proto-cardgrid">${autoInsight}</div>` : ""}
    <div class="proto-section">
      <h3>2) Theorie (kurz)</h3>
      <div class="proto-muted">${escapeHtml(exp.overview?.principle_short || "‚Äî")}</div>
    </div>

    <div class="proto-section">
      <h3>3) Ger√§te & Chemikalien</h3>
      <div class="proto-muted">Template-basiert (kannst du sp√§ter als Liste/Checkliste ausbauen).</div>
    </div>

    <div class="proto-section">
      <h3>4) Sicherheit & Entsorgung</h3>
      <div class="proto-k">Sicherheit</div>
      ${safetyHtml}
      <div style="margin-top:10px;" class="proto-k">Entsorgung</div>
      <div class="proto-muted">${escapeHtml(exp.overview?.disposal_short || "‚Äî")}</div>
    </div>

    <div class="proto-section">
      <h3>5) Durchf√ºhrung (reproduzierbar)</h3>
      <ol class="proto-list">${stepLines}</ol>
    </div>

    <div class="proto-section">
      <h3>6) Messdaten</h3>
      ${entries.length ? `
        <table class="proto-table">
          <thead>
            <tr>
              <th>Zeit</th><th>Schritt</th><th>Key</th><th>Frage</th><th style="text-align:right;">Wert</th><th>Einheit</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      ` : `<div class="proto-muted">‚Äî</div>`}
    </div>

    <div class="proto-section">
      <h3>7) Beobachtungen / Abweichungen</h3>
      ${flagsHtml}
    </div>

    <div class="proto-section">
      <h3>8) Fehlerquellen (Template)</h3>
      <div class="proto-muted">Wird aus dem Template erg√§nzt (wir rendern das als n√§chstes als h√ºbsche Liste).</div>
    </div>

    <div class="proto-section">
      <h3>9) Fazit (Auto)</h3>
      ${autoConclusionHTML(exp, sess)}
    </div>
    <div class="proto-section">
      <h3>${autoFazitTitle}</h3>
      ${autoFazitHTML}
    </div>

  </div>
  `;
}

/* ---------- Word (.doc) builder ---------- */
function buildWordDocHTML(exp, sess){
  const inner = protocolHTML(exp, sess);
  return `
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Protokoll ‚Äì ${escapeHtml(exp.title||"")}</title>
<style>
  body{font-family: Calibri, Arial, sans-serif; margin:24px; color:#111; background:#fff; line-height:1.4;}
  .proto-wrap{border:1px solid #d1d5db; border-radius:12px; padding:16px;}
  .proto-title{font-size:20px; font-weight:800; margin-bottom:6px;}
  .proto-meta{color:#374151; font-weight:600; display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;}
  .proto-chip{display:inline-flex; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; font-size:11px;}
  .proto-section{margin-top:12px; padding-top:10px; border-top:1px solid #eef2f7;}
  .proto-section h3{font-size:13px; font-weight:800; margin-bottom:8px;}
  .proto-muted{color:#111; font-weight:500;}
  .proto-table{width:100%; border-collapse:collapse; margin-top:8px;}
  .proto-table th,.proto-table td{border:1px solid #e5e7eb; padding:7px; font-size:11px; vertical-align:top;}
  .proto-table th{background:#f3f4f6; font-weight:800;}
  .proto-list{margin: 6px 0 0 18px;}
  .proto-list li{margin: 4px 0;}
  strong{font-weight:800;}
</style>
</head>
<body>
${inner}
</body>
</html>
  `.trim();
}

/* ---------- Copy for Word: put HTML into clipboard ---------- */
async function copyProtocolAsWordHTML(exp, sess){
  const html = buildWordDocHTML(exp, sess);
  const fallback = `Protokoll ‚Äì ${exp.title} (Session ${sess.id})`;

  if(window.ClipboardItem){
    const item = new ClipboardItem({
      "text/html": new Blob([html], {type:"text/html"}),
      "text/plain": new Blob([fallback], {type:"text/plain"})
    });
    await navigator.clipboard.write([item]);
    return true;
  }
  await navigator.clipboard.writeText(fallback);
  return false;
}

/* ---------- Patch openProtocol buttons ---------- */
const _openProtocol_ORIG = openProtocol;
openProtocol = function(sessionId){
  const sess = state.sessions.find(s=>s.id===sessionId);
  if(!sess){ showToast("Fehler", "Session nicht gefunden."); return; }
  const exp = state.experiments.find(e=>e.id===sess.experiment_id);
  if(!exp){ showToast("Fehler", "Experiment zur Session fehlt."); return; }

  const overlay = document.createElement("div");
  overlay.className = "modal active";
  overlay.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>üßæ Protokoll</h2>
        <button class="close" id="protoClose">√ó</button>
      </div>

      ${protocolHTML(exp, sess)}

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
        <button class="btn btn-secondary" id="protoCopyWord">üìã Copy (Word)</button>
        <button class="btn btn-primary" id="protoDownloadDOC">‚¨áÔ∏è Download (Word .doc)</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  overlay.querySelector("#protoClose").onclick = ()=> overlay.remove();
  overlay.addEventListener("click", (e)=>{ if(e.target===overlay) overlay.remove(); });

  overlay.querySelector("#protoCopyWord").onclick = async ()=>{
    try{
      const ok = await copyProtocolAsWordHTML(exp, sess);
      showToast("Kopiert", ok ? "In Word einf√ºgen ‚Üí Tabellen bleiben Tabellen." : "Fallback kopiert.");
    }catch(e){
      showToast("Nicht m√∂glich", "Clipboard nicht verf√ºgbar.");
    }
  };

  overlay.querySelector("#protoDownloadDOC").onclick = ()=>{
    const doc = buildWordDocHTML(exp, sess);
    const blob = new Blob([doc], {type:"application/msword"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${(exp.title||"Protokoll").replaceAll(" ","_")}_${sess.id}.doc`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
};

renderAll();
</script>
</body>
</html>
