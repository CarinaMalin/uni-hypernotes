<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Uni Hyper Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    :root {
      --bg: #161821;
      --bg-gradient: radial-gradient(circle at top, #2a3245 0, #10121a 45%, #05060a 100%);
      --bg-elevated: #1f2230;
      --bg-sidebar: #181b27;
      --border: #2f3445;
      --text: #f7f7ff;
      --muted: #a4aac5;
      --accent: #7b8cff;
      --accent-soft: rgba(123, 140, 255, 0.16);
      --danger: #ff6b81;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
      --radius-card: 18px;
    }

    .light {
      --bg: #f5f5fb;
      --bg-gradient: radial-gradient(circle at top, #ffffff 0, #eceefd 40%, #dde2ff 100%);
      --bg-elevated: #ffffff;
      --bg-sidebar: #f1f3ff;
      --border: #d3d7f0;
      --text: #1a1c2c;
      --muted: #6f7593;
      --accent: #4a5cff;
      --accent-soft: rgba(74, 92, 255, 0.18);
      --danger: #ff4d6a;
      --shadow-soft: 0 16px 40px rgba(32, 36, 90, 0.18);
      --radius-card: 18px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* ---------- Topbar ---------- */

    #topbar {
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      background: rgba(5, 7, 15, 0.9);
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      z-index: 20;
    }

    body.light #topbar {
      background: rgba(255, 255, 255, 0.92);
      box-shadow: 0 12px 30px rgba(39, 46, 120, 0.25);
    }

    #topbar-left,
    #topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #appTitle {
      font-weight: 800;
      font-size: 17px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #appTitle::before {
      content: "ğŸ“š";
      font-size: 16px;
    }

    button,
    select,
    input,
    textarea {
      font-family: inherit;
      font-size: 13px;
    }

    button,
    select {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 6px 11px;
      background: rgba(9, 11, 25, 0.9);
      color: var(--text);
      cursor: pointer;
      outline: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease transform, 0.15s ease box-shadow, 0.15s ease background-color, 0.15s ease border-color;
    }

    body.light button,
    body.light select {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.05);
    }

    button:hover {
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0px) scale(0.97);
      box-shadow: none;
    }

    #darkModeBtn {
      font-size: 14px;
      padding-inline: 10px;
    }

    /* ---------- Tabbar ---------- */

    #tabbar {
      display: flex;
      align-items: center;
      padding: 5px 10px;
      background: radial-gradient(circle at top left, rgba(123, 140, 255, 0.2), transparent 40%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      gap: 4px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 4px 11px 5px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.16s ease background-color, 0.16s ease color, 0.16s ease transform;
    }

    .tab-btn::before {
      font-size: 13px;
    }

    .tab-btn[data-tab="notes"]::before { content: "âœï¸"; }
    .tab-btn[data-tab="cards"]::before { content: "ğŸ´"; }
    .tab-btn[data-tab="planner"]::before { content: "ğŸ—“ï¸"; }
    .tab-btn[data-tab="formulas"]::before { content: "âˆ‘"; }
    .tab-btn[data-tab="tools"]::before { content: "ğŸ§®"; }
    .tab-btn[data-tab="learn"]::before { content: "ğŸ“–"; }
    .tab-btn[data-tab="tasks"]::before { content: "ğŸ“Œ"; }
    .tab-btn[data-tab="brain"]::before { content: "ğŸ’­"; }
    .tab-btn[data-tab="stats"]::before { content: "ğŸ“Š"; }

    .tab-btn.active {
      background: var(--accent-soft);
      border-color: rgba(255, 255, 255, 0.16);
      color: var(--text);
      transform: translateY(-1px);
    }

    /* ---------- Main Layout ---------- */

    #main {
      flex: 1;
      display: flex;
      min-height: 0;
      padding: 10px 10px 12px 10px;
      gap: 10px;
    }

    /* ---------- Notizen-Bereich ---------- */

    #notesLayout.section {
      flex: 1;
      display: none;
      min-height: 0;
      background: transparent;
    }

    #notesLayout.section.active {
      display: flex;
    }

    #sidebarNotes {
      width: 130px;
      background: linear-gradient(180deg, rgba(15, 18, 32, 0.98), rgba(12, 14, 26, 0.98));
      border-radius: var(--radius-card);
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: var(--shadow-soft);
      padding: 10px 8px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #sidebar-section-title {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      opacity: 0.72;
    }

    #sidebarNotes button {
      font-size: 11px;
      padding: 3px 8px;
    }

    #templateSelect {
      width: 100%;
      margin-top: 4px;
      font-size: 11px;
      padding-block: 4px;
    }

    #pageList {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
    }

    .page-thumb {
      position: relative;
      background: rgba(10, 12, 24, 0.96);
      border-radius: 12px;
      border: 1.5px solid transparent;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.5);
      margin-bottom: 7px;
      cursor: pointer;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      text-align: center;
      color: var(--muted);
      transition: 0.15s ease border-color, 0.15s ease transform, 0.15s ease background-color;
    }

    .page-thumb.active {
      border-color: var(--accent);
      background: rgba(123, 140, 255, 0.18);
      color: var(--text);
      transform: translateY(-1px);
    }

    .page-thumb span.index {
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 9px;
      opacity: 0.7;
    }

    #canvasWrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px;
      min-width: 0;
      gap: 8px;
    }

    #toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at top left, rgba(123, 140, 255, 0.3), rgba(15, 16, 32, 0.98));
      padding: 6px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow-soft);
      flex-wrap: wrap;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    body.light #toolbar {
      background: radial-gradient(circle at top left, rgba(123, 140, 255, 0.16), #ffffff);
    }

    #canvas {
      background: #fbfbff;
      border-radius: 22px;
      box-shadow: 0 22px 55px rgba(5, 6, 17, 0.85);
      touch-action: none;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    body.light #canvas {
      background: #ffffff;
    }

    input[type="color"] {
      border: none;
      background: transparent;
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 999px;
      overflow: hidden;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .tool-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 4px 10px;
      font-size: 12px;
      background: rgba(6, 8, 20, 0.9);
      cursor: pointer;
      color: var(--muted);
    }

    .tool-btn.active {
      border-color: var(--accent);
      background: rgba(123, 140, 255, 0.28);
      color: var(--text);
    }

    .stroke-btn {
      padding: 3px 8px;
      font-size: 11px;
      opacity: 0.85;
    }

    .stroke-btn.active {
      border-color: var(--accent);
      background: rgba(123, 140, 255, 0.18);
      color: var(--text);
    }

    label {
      font-size: 11px;
      opacity: 0.8;
    }

    /* ---------- Generische Sektionen (andere Tabs) ---------- */

    .section {
      flex: 1;
      padding: 0;
      display: none;
      overflow: auto;
    }

    .section.active {
      display: block;
    }

    .card {
      background: var(--bg-elevated);
      border-radius: var(--radius-card);
      padding: 11px 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .card h3 {
      margin: 0 0 6px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h3::before {
      content: "â€¢";
      font-size: 18px;
      color: var(--accent);
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row > * {
      flex: 1;
      min-width: 150px;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select#notebookSelect,
    select#templateSelect,
    select#studyDeckSelect {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 7px 11px;
      background: rgba(7, 9, 20, 0.9);
      color: var(--text);
      width: 100%;
      box-sizing: border-box;
    }

    body.light input[type="text"],
    body.light input[type="date"],
    body.light input[type="number"],
    body.light textarea,
    body.light select {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.06);
    }

    textarea {
      min-height: 70px;
      border-radius: 14px;
      line-height: 1.4;
      resize: vertical;
    }

    .pill {
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: inline-block;
      margin-right: 4px;
      margin-bottom: 4px;
      background: rgba(15, 18, 40, 0.9);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
    }

    /* ---------- Lernen-Layout ---------- */
    #learnLayout {
      display: flex;
      gap: 10px;
      height: 100%;
    }

    #learnSidebar {
      width: 210px;
      background: var(--bg-sidebar);
      border-radius: var(--radius-card);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: var(--shadow-soft);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #learnSubjects,
    #learnTopics {
      margin-top: 4px;
      padding: 0;
      list-style: none;
      max-height: 40%;
      overflow-y: auto;
    }

    .learn-item {
      padding: 5px 9px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      margin-bottom: 4px;
      background: rgba(0,0,0,0.08);
      color: var(--muted);
      transition: 0.15s;
    }

    .learn-item.active {
      background: var(--accent-soft);
      color: var(--text);
    }

    #learnContent {
      flex: 1;
      overflow-y: auto;
    }

    .learn-heading {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .learn-subheading {
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .learn-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .learn-list {
      margin-top: 0;
      padding-left: 18px;
      font-size: 13px;
    }

    .learn-chiprow {
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .learn-chip {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      margin-right: 4px;
      margin-bottom: 4px;
    }

    @media (max-width: 860px) {
      #sidebarNotes { width: 105px; }
      button, select { font-size: 11px; padding: 4px 9px; }
      #toolbar { font-size: 11px; padding-inline: 10px; }
      #learnLayout { flex-direction: column; }
      #learnSidebar { width: 100%; flex-direction: row; overflow-x: auto; }
    }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <div id="topbar">
    <div id="topbar-left">
      <div id="appTitle">Uni Hyper Notes</div>
      <select id="notebookSelect"></select>
      <button id="addNotebookBtn">ï¼‹ Notizbuch</button>
    </div>
    <div id="topbar-right">
      <button id="darkModeBtn">ğŸŒ™ / â˜€ï¸</button>
      <button id="exportPageBtn">ğŸ–¼ï¸ Seite als PNG</button>
      <button id="exportJsonBtn">ğŸ’¾ Backup</button>
    </div>
  </div>

  <!-- TABBAR -->
  <div id="tabbar">
    <button class="tab-btn active" data-tab="notes">Notizen</button>
    <button class="tab-btn" data-tab="cards">Karteikarten</button>
    <button class="tab-btn" data-tab="planner">Planer</button>
    <button class="tab-btn" data-tab="formulas">Formeln</button>
    <button class="tab-btn" data-tab="tools">Tools</button>
    <button class="tab-btn" data-tab="learn">Lernen</button>
    <button class="tab-btn" data-tab="tasks">Aufgaben</button>
    <button class="tab-btn" data-tab="brain">Brain-Dump</button>
    <button class="tab-btn" data-tab="stats">Stats</button>
  </div>

  <div id="main">
    <!-- NOTIZEN-TAB -->
    <div id="notesLayout" class="section active">
      <div id="sidebarNotes">
        <div id="sidebar-header">
          <div><div id="sidebar-section-title">Seiten</div></div>
          <button id="addPageBtn" title="Neue Seite">ï¼‹</button>
        </div>
        <div>
          <label for="templateSelect">Template:</label><br>
          <select id="templateSelect">
            <option value="blank">Blanko</option>
            <option value="lined">Liniert</option>
            <option value="dotted">Dotted</option>
            <option value="grid">Kariert</option>
          </select>
        </div>
        <div id="pageList"></div>
      </div>

      <div id="canvasWrapper">
        <div id="toolbar">
          <label>Tool:</label>
          <button class="tool-btn active" data-tool="pen">Stift</button>
          <button class="tool-btn" data-tool="highlighter">Marker</button>
          <button class="tool-btn" data-tool="eraser">Radierer</button>
          <button class="tool-btn" data-tool="line">Linie</button>
          <button class="tool-btn" data-tool="rect">Rechteck</button>
          <button class="tool-btn" data-tool="circle">Kreis</button>

          <label>Farbe:</label>
          <input type="color" id="colorPicker" value="#000000">

          <label>StÃ¤rke:</label>
          <button class="stroke-btn active" data-width="2">DÃ¼nn</button>
          <button class="stroke-btn" data-width="5">Mittel</button>
          <button class="stroke-btn" data-width="9">Dick</button>

          <button id="undoBtn">â†¶ Undo</button>
          <button id="redoBtn">â†· Redo</button>

          <button id="clearBtn">ğŸ§¹ Seite leeren</button>
        </div>

        <canvas id="canvas"></canvas>
      </div>
    </div>

    <!-- KARTEIKARTEN-TAB -->
    <div id="cardsSection" class="section">
      <div class="card">
        <h3>Karteikarten-Decks</h3>
        <div class="row">
          <div>
            <input type="text" id="cardDeckName" placeholder="Neues Deck (z.B. Allgemeine Chemie)">
          </div>
          <div style="flex:0 0 auto;">
            <button id="addDeckBtn">ï¼‹ Deck</button>
          </div>
        </div>
        <div id="deckList"></div>
      </div>

      <div class="card">
        <h3>Karteikarten in Deck</h3>
        <div class="row">
          <div><textarea id="cardQuestion" placeholder="Frage / Vorderseite"></textarea></div>
          <div><textarea id="cardAnswer" placeholder="Antwort / RÃ¼ckseite"></textarea></div>
        </div>
        <div class="row">
          <div><input type="text" id="cardTags" placeholder="Tags (z.B. SÃ¤ure-Base, wichtig)"></div>
          <div style="flex:0 0 auto;"><button id="addCardBtn">ï¼‹ Karte speichern</button></div>
        </div>
        <div id="cardList"></div>
      </div>

      <div class="card">
        <h3>Lernmodus (Spaced-Repetition light)</h3>
        <div class="row">
          <div><select id="studyDeckSelect"></select></div>
          <div style="flex:0 0 auto;"><button id="startStudyBtn">Lernen starten</button></div>
        </div>
        <div id="studyArea" style="margin-top:8px; display:none;">
          <div id="studyQuestion" style="margin-bottom:6px; font-weight:600;"></div>
          <div id="studyAnswer" style="margin-bottom:6px; display:none;"></div>
          <button id="revealAnswerBtn">Antwort anzeigen</button>
          <div style="margin-top:6px; display:none;" id="studyFeedback">
            <span style="font-size:12px;">Wie gut wusstest du es?</span><br>
            <button class="studyGradeBtn" data-grade="0">Keine Ahnung</button>
            <button class="studyGradeBtn" data-grade="1">Schwer</button>
            <button class="studyGradeBtn" data-grade="2">Okay</button>
            <button class="studyGradeBtn" data-grade="3">Super</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PLANER-TAB -->
    <div id="plannerSection" class="section">
      <div class="card">
        <h3>Deine nÃ¤chsten PrÃ¼fungen</h3>
        <div class="row">
          <div><input type="text" id="examName" placeholder="Modul / PrÃ¼fung"></div>
          <div><input type="date" id="examDate"></div>
          <div><input type="number" id="examWeight" placeholder="ECTS / Wichtigkeit" min="1"></div>
          <div style="flex:0 0 auto;"><button id="addExamBtn">ï¼‹ PrÃ¼fung speichern</button></div>
        </div>
        <div id="examList"></div>
      </div>

      <div class="card">
        <h3>Fokus heute</h3>
        <div class="row">
          <div><input type="text" id="blockTopic" placeholder="Thema (z.B. Allg. Chemie â€“ SÃ¤ure-Base)"></div>
          <div><input type="number" id="blockMinutes" placeholder="Minuten (z.B. 45)" min="5"></div>
          <div style="flex:0 0 auto;"><button id="startBlockBtn">â±ï¸ Fokus starten</button></div>
        </div>
        <div id="focusStatus" style="margin-top:6px; font-size:13px;"></div>
      </div>
    </div>

    <!-- FORMELN-TAB -->
    <div id="formulasSection" class="section">
      <div class="card">
        <h3>Formel hinzufÃ¼gen</h3>
        <div class="row">
          <div><input type="text" id="formulaName" placeholder="Name (z.B. ideale Gasgleichung)"></div>
          <div><input type="text" id="formulaExpression" placeholder="Formel (z.B. pÂ·V = nÂ·RÂ·T)"></div>
        </div>
        <div class="row">
          <div><input type="text" id="formulaTopic" placeholder="Thema (z.B. Allgemeine Chemie / Thermodynamik)"></div>
          <div><input type="text" id="formulaVariables" placeholder="Variablen & Einheiten (p=..., V=..., ...)"></div>
        </div>
        <div class="row">
          <div><textarea id="formulaNotes" placeholder="Hinweise, typische Fehler, etc."></textarea></div>
          <div style="flex:0 0 auto; align-self:flex-end; display:flex; flex-direction:column; gap:6px;">
            <button id="addFormulaBtn">ï¼‹ Formel speichern</button>
            <button id="loadBiotechFormulasBtn" type="button">ğŸ“¥ Biotech-Basisformeln laden</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Formelsammlung</h3>
        <input type="text" id="formulaFilter" placeholder="Suche nach Name / Thema..." style="margin-bottom:6px;">
        <div id="formulaList"></div>
      </div>
    </div>

    <!-- TOOLS-TAB (Rechentool) -->
    <div id="toolsSection" class="section">
      <div class="card">
        <h3>Chemie-Rechentool</h3>
        <div class="row">
          <div>
            <select id="toolFormulaSelect">
              <option value="dilution">VerdÃ¼nnung (câ‚Â·Vâ‚ = câ‚‚Â·Vâ‚‚)</option>
              <option value="lambert">Lambert-Beer-Gesetz (A = ÎµÂ·cÂ·l)</option>
            </select>
          </div>
        </div>
        <div id="toolInputs" style="margin-top:8px;"></div>
        <div style="margin-top:6px;">
          <button id="toolCalcBtn">Berechnen</button>
          <span id="toolResult" style="font-size:13px; margin-left:8px;"></span>
        </div>
      </div>
    </div>

    <!-- LERNEN-TAB -->
    <div id="learnSection" class="section">
      <div id="learnLayout">
        <div id="learnSidebar">
          <div>
            <div style="font-size:11px; letter-spacing:0.12em; text-transform:uppercase; opacity:0.7;">FÃ¤cher</div>
            <ul id="learnSubjects"></ul>
          </div>
          <div>
            <div style="font-size:11px; letter-spacing:0.12em; text-transform:uppercase; opacity:0.7; margin-top:6px;">Themen</div>
            <ul id="learnTopics"></ul>
          </div>
        </div>
        <div id="learnContent">
          <!-- wird per JS gefÃ¼llt -->
        </div>
      </div>
    </div>

    <!-- AUFGABEN-TAB -->
    <div id="tasksSection" class="section">
      <div class="card">
        <h3>Rechenaufgabe / VerstÃ¤ndnisaufgabe hinzufÃ¼gen</h3>
        <div class="row">
          <div><input type="text" id="taskTitle" placeholder="Kurzbeschreibung (z.B. pV=nRT umstellen)"></div>
          <div><input type="text" id="taskTopic" placeholder="Thema / Modul (z.B. Allg. Chemie)"></div>
        </div>
        <div class="row">
          <div><textarea id="taskText" placeholder="Aufgabe (Text oder kopierter Inhalt)"></textarea></div>
          <div><textarea id="taskNotes" placeholder="Dein LÃ¶sungsweg / Notizen (optional)"></textarea></div>
        </div>
        <div class="row">
          <div style="flex:0 0 auto;"><button id="addTaskBtn">ï¼‹ Aufgabe speichern</button></div>
        </div>
      </div>

      <div class="card">
        <h3>Aufgaben-Liste</h3>
        <div id="taskList"></div>
      </div>
    </div>

    <!-- BRAIN-DUMP-TAB -->
    <div id="brainSection" class="section">
      <div class="card">
        <h3>Brain-Dump (Gedanken, Sorgen, Ideen)</h3>
        <textarea id="brainText" placeholder="Alles, was im Kopf rumschwirrt..."></textarea>
        <div style="margin-top:6px;">
          <button id="saveBrainBtn">Speichern</button>
          <span id="brainStatus" style="font-size:11px; opacity:0.7; margin-left:6px;"></span>
        </div>
      </div>

      <div class="card">
        <h3>Vergangene EintrÃ¤ge</h3>
        <div id="brainHistory"></div>
      </div>
    </div>

    <!-- STATS-TAB -->
    <div id="statsSection" class="section">
      <div class="card">
        <h3>Lern-Stats (einfach)</h3>
        <div id="statsContent"></div>
      </div>
    </div>
  </div>

  <script>
// ---------- LERN-DATEN (Allgemeine Chemie, erweitert) ----------
const learnData = {
  subjects: [
    {
      id: "allg-chem",
      name: "Allgemeine Chemie",
      description:
        "Grundlagen des Aufbaus der Materie, chemische Bindungen, StÃ¶chiometrie, SÃ¤ure-Base, Redox, Titrationen & Laborsicherheit â€“ auf Klausur-Niveau.",
      topics: [
        {
          id: "aufbau-materie",
          title: "Aufbau der Materie & Atome",
          tags: ["Atome", "ElektronenhÃ¼lle", "Kern"],
          goals: [
            "Aufbau von Atomen (Protonen, Neutronen, Elektronen) sicher erklÃ¤ren.",
            "Ordnungszahl, Massenzahl und Isotope unterscheiden und Beispiele angeben.",
            "Elektronenkonfiguration fÃ¼r einfache Elemente schreiben (z. B. H, He, C, O, Na, Cl)."
          ],
          summary:
            "Materie besteht aus Atomen. Ein Atom besitzt einen positiv geladenen Kern (Protonen und Neutronen) und eine negativ geladene ElektronenhÃ¼lle. Die Ordnungszahl Z entspricht der Protonenzahl und definiert das Element. Isotope haben dieselbe Protonenzahl, aber unterschiedliche Neutronenzahlen. FÃ¼r die Chemie sind vor allem die Valenzelektronen (AuÃŸenelektronen) entscheidend, da sie an Bindungen beteiligt sind.",
          keyPoints: [
            "Ordnungszahl Z = Anzahl der Protonen = Anzahl der Elektronen im neutralen Atom.",
            "Massenzahl A â‰ˆ Protonen + Neutronen; Neutronenzahl N = A âˆ’ Z.",
            "Isotope: z. B. Â¹Â²C, Â¹Â³C, Â¹â´C â€“ alle Kohlenstoff, aber mit unterschiedlicher Massenzahl.",
            "Elektronenkonfiguration zeigt Verteilung in Schalen/Unterschalen (z. B. 1sÂ² 2sÂ² 2pÂ²).",
            "Valenzelektronen bestimmen ReaktivitÃ¤t (z. B. Edelgase: volle Schale â†’ sehr reaktionstrÃ¤ge)."
          ],
          formulas: ["A = Z + N"],
          visual: `
            <div>Atommodell (vereinfachtes Kugelmodell):</div>
            <svg viewBox="0 0 140 80" width="140" height="80">
              <circle cx="45" cy="40" r="18" fill="rgba(123,140,255,0.35)" stroke="currentColor"/>
              <circle cx="95" cy="40" r="26" fill="none" stroke="currentColor" stroke-dasharray="4 3"/>
              <circle cx="95" cy="16" r="3" fill="currentColor"/>
              <circle cx="116" cy="40" r="3" fill="currentColor"/>
              <circle cx="74" cy="40" r="3" fill="currentColor"/>
            </svg>
            <div style="font-size:11px;opacity:0.8;margin-top:4px;">Innen: Kern (pâº, nâ°) â€“ auÃŸen: Elektronen auf Schale.</div>
          `
        },
        {
          id: "periodensystem",
          title: "Periodensystem der Elemente (PSE)",
          tags: ["PSE", "Trends", "Gruppen"],
          goals: [
            "Perioden und Gruppen im PSE sicher benennen.",
            "Hauptgruppen (Alkalimetalle, Erdalkalimetalle, Halogene, Edelgase) zuordnen.",
            "Trends von Atomradius und ElektronegativitÃ¤t qualitativ beschreiben."
          ],
          summary:
            "Das Periodensystem ordnet alle bekannten Elemente nach steigender Ordnungszahl. In einer Gruppe (Spalte) stehen Elemente mit Ã¤hnlicher Valenzelektronenkonfiguration und Ã¤hnlichen chemischen Eigenschaften. In einer Periode (Zeile) nimmt die Ordnungszahl von links nach rechts zu. Wichtige Trends: der Atomradius nimmt innerhalb einer Periode von links nach rechts ab, innerhalb einer Gruppe von oben nach unten zu. Die ElektronegativitÃ¤t zeigt das umgekehrte Verhalten.",
          keyPoints: [
            "Gruppen: z. B. 1. Hauptgruppe = Alkalimetalle (Li, Na, K, ...); 17. Hauptgruppe = Halogene; 18. Hauptgruppe = Edelgase.",
            "Perioden: horizontale Zeilen â€“ geben an, wie viele Schalen im Atom besetzt sind.",
            "Atomradius â†“ nach rechts kleiner, â†‘ nach unten grÃ¶ÃŸer.",
            "ElektronegativitÃ¤t â†‘ nach rechts grÃ¶ÃŸer (bis F), â†‘ nach oben grÃ¶ÃŸer.",
            "Metalle stehen Ã¼berwiegend links unten, Nichtmetalle rechts oben."
          ],
          formulas: [],
          visual: `
            <div style="font-size:11px;margin-bottom:4px;">Sehr vereinfachtes Mini-PSE (nur Hauptgruppen):</div>
            <pre style="font-size:10px;line-height:1.2;">
H                                                   He
Li Be                                      B  C  N  O  F  Ne
Na Mg                                      Al Si P  S  Cl Ar
K  Ca                                      Ga Ge As Se Br Kr
            </pre>
          `
        },
        {
          id: "orbitale",
          title: "Atomorbitale: s- und p-Orbitale",
          tags: ["Orbitale", "s-Orbital", "p-Orbital"],
          goals: [
            "Begriff Orbital (Wahrscheinlichkeitswolke) formulieren.",
            "s-Orbitale als kugelfÃ¶rmig und p-Orbitale als hantelfÃ¶rmig skizzieren.",
            "FÃ¼r p-Orbitale die drei Raumrichtungen (pâ‚“, páµ§, p_z) angeben."
          ],
          summary:
            "Ein Orbital ist kein 'Planet auf einer Kreisbahn', sondern ein Bereich im Raum, in dem sich ein Elektron mit hoher Wahrscheinlichkeit aufhÃ¤lt. s-Orbitale sind kugelfÃ¶rmig um den Kern verteilt. p-Orbitale sind hantelfÃ¶rmig mit zwei Lobes und besitzen drei rÃ¤umliche Ausrichtungen (pâ‚“, páµ§, p_z). In der Klausur wird oft verlangt, ein 1s-Orbital und drei p-Orbitale zu skizzieren und sinnvoll zu beschriften.",
          keyPoints: [
            "s-Orbitale: kugelfÃ¶rmig, 1s liegt am niedrigsten, dann 2s, 3s ...",
            "p-Orbitale: hantelfÃ¶rmig, jeweils zwei 'Lappen' (Lobes) â€“ drei Ausrichtungen: x-, y- und z-Achse.",
            "Maximal 2 Elektronen pro Orbital (mit entgegengesetztem Spin).",
            "Skizze: s-Orbital = Kreis/Kugel; p-Orbital = zwei Kreise/Ellipsen gegenÃ¼berliegend mit Kern in der Mitte."
          ],
          formulas: [],
          visual: `
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <div>
                <div style="font-size:11px;margin-bottom:2px;">s-Orbital (1s)</div>
                <svg viewBox="0 0 70 70" width="70" height="70">
                  <circle cx="35" cy="35" r="22"
                          fill="rgba(123,140,255,0.30)" stroke="currentColor"/>
                  <circle cx="35" cy="35" r="3" fill="currentColor"/>
                </svg>
              </div>
              <div>
                <div style="font-size:11px;margin-bottom:2px;">p-Orbital (z. B. p<sub>z</sub>)</div>
                <svg viewBox="0 0 90 70" width="90" height="70">
                  <circle cx="45" cy="20" r="14"
                          fill="rgba(123,140,255,0.30)" stroke="currentColor"/>
                  <circle cx="45" cy="50" r="14"
                          fill="rgba(123,140,255,0.30)" stroke="currentColor"/>
                  <circle cx="45" cy="35" r="3" fill="currentColor"/>
                </svg>
              </div>
            </div>
            <div style="font-size:11px;opacity:0.8;margin-top:4px;">FÃ¼r die Klausur: Kugel fÃ¼r s, Hantel fÃ¼r p â€“ sauber beschriften reicht vÃ¶llig.</div>
          `
        },
        {
          id: "mo-n2",
          title: "MolekÃ¼lorbitale (MO) â€“ Beispiel Nâ‚‚",
          tags: ["MO-Theorie", "Nâ‚‚", "Bindungsordnung"],
          goals: [
            "Grundidee der MO-Theorie wiedergeben (Orbitale kombinieren zu bindenden/antibindenden MOs).",
            "Ein einfaches MO-Schema fÃ¼r homonukleare zweiatomige MolekÃ¼le skizzieren (z. B. Nâ‚‚).",
            "Bindungsordnung fÃ¼r Nâ‚‚ berechnen und deuten kÃ¶nnen."
          ],
          summary:
            "In der MO-Theorie werden Atomorbitale zu MolekÃ¼lorbitalen kombiniert: bindende (energetisch niedriger) und antibindende (energetisch hÃ¶her). FÃ¼r Nâ‚‚ kombinierst du 2s- und 2p-Orbitale der beiden N-Atome. Wichtig in der Klausur: MO-Schema zeichnen, Energieniveaus sortieren und Elektronen mit Pfeilen eintragen. Danach kannst du die Bindungsordnung bestimmen.",
          keyPoints: [
            "Bindende MOs (Ïƒ, Ï€) liegen energetisch tiefer, antibindende (Ïƒ*, Ï€*) hÃ¶her.",
            "FÃ¼r Nâ‚‚ (14 eâ» pro MolekÃ¼l, also 7 pro Atom): Bindungsordnung = (Bindende eâ» âˆ’ Antibindende eâ»)/2.",
            "Typisch fÃ¼r Nâ‚‚: Bindungsordnung 3 â†’ Dreifachbindung.",
            "MO-Schema sauber mit Pfeilen (â†‘â†“) fÃ¼llen â€“ Hundsche Regel & Pauli-Prinzip beachten."
          ],
          formulas: [
            "Bindungsordnung = (N<sub>bindend</sub> âˆ’ N<sub>antibindend</sub>) / 2"
          ],
          visual: `
            <div style="font-size:11px;margin-bottom:4px;">Sehr vereinfachtes MO-Schema (nur qualitativ):</div>
            <pre style="font-size:10px;line-height:1.2;">
           Ïƒ*2p   (antibindend)
      Ï€2p  Ï€2p
           Ïƒ2p   (bindend)
           Ïƒ*2s
           Ïƒ2s

    Pfeile von unten nach oben eintragen (Energie â†‘).
            </pre>
          `
        },
        {
          id: "stoechiometrie",
          title: "StÃ¶chiometrie & chemisches Rechnen",
          tags: ["Molare Masse", "Stoffmenge", "Gleichungen"],
          goals: [
            "Stoffmenge aus Masse und molarer Masse berechnen.",
            "Reaktionsgleichungen korrekt nach Atomanzahl ausgleichen.",
            "Grobe Ãœberschlagsrechnungen beherrschen (z. B. mg â†’ mmol)."
          ],
          summary:
            "StÃ¶chiometrie beantwortet die Frage: Wie viel von welcher Substanz reagiert miteinander? Grundlage ist die Stoffmenge n in mol. Ãœber die molare Masse M verknÃ¼pfst du Masse und Stoffmenge. In Klausuraufgaben geht es oft darum, Reaktionsgleichungen zu formulieren, auszubalancieren und aus einer gegebenen Masse oder Konzentration die gesuchte Menge zu bestimmen.",
          keyPoints: [
            "Stoffmenge: n = m / M (mit m in g, M in g/mol â†’ n in mol).",
            "Konzentration: c = n / V (mit V in L, c in mol/L).",
            "Reaktionsgleichung zuerst verbal verstehen, dann nach Atomen ausgleichen.",
            "Im Zweifel: zuerst Metalle, dann Nichtmetalle, dann H und O ausgleichen â€“ oder deine bevorzugte Reihenfolge.",
            "Immer Einheiten mitfÃ¼hren (mg â†’ g â†’ mol)."
          ],
          formulas: [
            "n = m / M",
            "c = n / V"
          ]
        },
        {
  id: "saeure-base-ph",
  title: "SÃ¤ure-Base & pH-Wert (inkl. NaOH)",
  tags: ["BrÃ¸nsted", "pH", "starke Basen"],
  goals: [
    "SÃ¤uren und Basen nach BrÃ¸nsted definieren.",
    "pH starker SÃ¤uren und pH starker Basen (z. B. NaOH) sicher berechnen.",
    "Zusammenhang zwischen pH, pOH und [Hâº]/[OHâ»] sowie dem Ionenprodukt des Wassers (K<sub>w</sub>) nutzen.",
    "Zwischen starken und schwachen SÃ¤uren/Basen unterscheiden und die passenden Rechenwege kennen."
  ],
  summary:
    "Nach BrÃ¸nsted ist eine SÃ¤ure ein Protonendonator und eine Base ein Protonenakzeptor. Starke SÃ¤uren/Basen dissoziieren im betrachteten Konzentrationsbereich praktisch vollstÃ¤ndig, schwache nur teilweise. FÃ¼r starke SÃ¤uren/Basen kannst du die Konzentration direkt mit [Hâº] oder [OHâ»] gleichsetzen. Ãœber pH, pOH und das Ionenprodukt des Wassers (Kw) lÃ¤sst sich die jeweils andere GrÃ¶ÃŸe berechnen. In Klausuren geht es hÃ¤ufig um das sichere Anwenden weniger Standardrezepte.",
  keyPoints: [
    "BrÃ¸nsted-SÃ¤ure: Protonendonator; BrÃ¸nsted-Base: Protonenakzeptor.",
    "Starke SÃ¤ure/Base: nahezu vollstÃ¤ndige Dissoziation â†’ [Hâº] â‰ˆ c(SÃ¤ure), [OHâ»] â‰ˆ c(Base).",
    "Wasserautoionisation: Hâ‚‚O â‡Œ Hâº + OHâ»; K<sub>w</sub> = [Hâº]Â·[OHâ»] â‰ˆ 1,0Â·10â»Â¹â´ (25 Â°C).",
    "pH = âˆ’logâ‚â‚€([Hâº]); pOH = âˆ’logâ‚â‚€([OHâ»]); pH + pOH = 14 (bei 25 Â°C).",
    "FÃ¼r NaOH: [OHâ»] = c(NaOH) (starke Base, 1:1-StÃ¶chiometrie).",
    "FÃ¼r starke SÃ¤uren/Basen reicht meist das einfache Rezept â€“ schwache SÃ¤uren/Basen brauchen Gleichgewichtsbetrachtung (K<sub>a</sub> oder K<sub>b</sub>) oder NÃ¤herungen."
  ],
  formulas: [
    "pH = âˆ’logâ‚â‚€([Hâº])",
    "pOH = âˆ’logâ‚â‚€([OHâ»])",
    "pH + pOH = 14 (bei 25 Â°C)",
    "K<sub>w</sub> = [Hâº]Â·[OHâ»] â‰ˆ 1,0Â·10â»Â¹â´"
  ],
  visual: `
    <div style="font-size:11px;margin-bottom:4px;">Rechenwege auf einen Blick:</div>
    <pre style="font-size:10px;line-height:1.3;">
Starke SÃ¤ure (z. B. HCl):
    c(HCl) = 0,010 mol/L
    â†’ [Hâº] â‰ˆ 0,010 mol/L
    â†’ pH = âˆ’log(0,010) = 2

Starke Base (z. B. NaOH):
    c(NaOH) = 0,010 mol/L
    â†’ [OHâ»] â‰ˆ 0,010 mol/L
    â†’ pOH = 2
    â†’ pH = 14 âˆ’ 2 = 12
    </pre>
  `,
  detailBlocks: [
    {
      title: "Definitionen & Grundbegriffe",
      content: `
        <ul style="padding-left:18px; margin:0;">
          <li><b>BrÃ¸nsted-SÃ¤ure:</b> Teilchen, das ein Proton (Hâº) abgeben kann. Beispiel: HCl, HNOâ‚ƒ, CHâ‚ƒCOOH.</li>
          <li><b>BrÃ¸nsted-Base:</b> Teilchen, das ein Proton aufnehmen kann. Beispiel: OHâ», NHâ‚ƒ, CHâ‚ƒCOOâ».</li>
          <li><b>Konjugiertes SÃ¤ure-Base-Paar:</b> SÃ¤ure und Base, die sich nur um ein Proton unterscheiden (z. B. HCl/Clâ»).</li>
          <li><b>Starke SÃ¤ure/Base:</b> Dissoziiert in Wasser praktisch vollstÃ¤ndig (im betrachteten Konzentrationsbereich).</li>
          <li><b>Schwache SÃ¤ure/Base:</b> Nur teilweise dissoziiert; es stellt sich ein Gleichgewicht ein (K<sub>a</sub> oder K<sub>b</sub> beschreibt die StÃ¤rke).</li>
          <li><b>pH-Skala:</b> MaÃŸ fÃ¼r die Wasserstoffionenkonzentration; pH &lt; 7 sauer, pH = 7 neutral, pH &gt; 7 basisch (bei 25 Â°C).</li>
        </ul>
      `
    },
    {
      title: "Rezept: pH starker SÃ¤uren",
      content: `
        <ol style="padding-left:18px; margin:0;">
          <li><b>PrÃ¼fen:</b> Ist es eine starke SÃ¤ure? (z. B. HCl, HBr, HI, HNOâ‚ƒ, Hâ‚‚SOâ‚„ (1. Proton), HClOâ‚„)</li>
          <li><b>Spezies bestimmen:</b> Wie viele Hâº pro MolekÃ¼l? (z. B. HCl â†’ 1 Hâº, Hâ‚‚SOâ‚„ â†’ 2 Hâº)</li>
          <li><b>[Hâº] berechnen:</b> [Hâº] â‰ˆ <i>n<sub>Hâº</sub></i> Â· c(SÃ¤ure).</li>
          <li><b>pH berechnen:</b> pH = âˆ’logâ‚â‚€([Hâº]).</li>
        </ol>
        <div style="margin-top:6px; font-size:11px;">
          Beispiel: c(HCl) = 0,050 mol/L â†’ starke einprotonige SÃ¤ure â‡’ [Hâº] â‰ˆ 0,050 mol/L â‡’ pH = âˆ’log(0,050) â‰ˆ 1,30.
        </div>
      `
    },
    {
      title: "Rezept: pH starker Basen (z. B. NaOH)",
      content: `
        <ol style="padding-left:18px; margin:0;">
          <li><b>PrÃ¼fen:</b> Ist es eine starke Base? (z. B. NaOH, KOH, Ba(OH)â‚‚).</li>
          <li><b>Spezies bestimmen:</b> Wie viele OHâ» pro Formeleinheit? (NaOH â†’ 1, Ba(OH)â‚‚ â†’ 2).</li>
          <li><b>[OHâ»] berechnen:</b> [OHâ»] â‰ˆ <i>n<sub>OHâ»</sub></i> Â· c(Base).</li>
          <li><b>pOH berechnen:</b> pOH = âˆ’logâ‚â‚€([OHâ»]).</li>
          <li><b>pH berechnen:</b> pH = 14 âˆ’ pOH (bei 25 Â°C).</li>
        </ol>
        <div style="margin-top:6px; font-size:11px;">
          Beispiel: c(NaOH) = 0,020 mol/L â†’ [OHâ»] â‰ˆ 0,020 mol/L â†’ pOH = âˆ’log(0,020) â‰ˆ 1,70 â†’ pH â‰ˆ 12,30.
        </div>
      `
    },
    {
      title: "Beispielaufgabe (klassischer Klausurstil)",
      content: `
        <div style="font-size:12px; margin-bottom:4px;">
          <b>Aufgabe:</b> Berechne den pH-Wert einer 0,010 mol/L Natronlauge (NaOH). Gehe von vollstÃ¤ndiger Dissoziation aus.
        </div>
        <ol style="padding-left:18px; margin:0;">
          <li><b>Schritt 1:</b> NaOH ist eine starke Base, 1:1-StÃ¶chiometrie: NaOH â†’ Naâº + OHâ».</li>
          <li><b>Schritt 2:</b> [OHâ»] â‰ˆ c(NaOH) = 0,010 mol/L.</li>
          <li><b>Schritt 3:</b> pOH = âˆ’log(0,010) = 2.</li>
          <li><b>Schritt 4:</b> pH = 14 âˆ’ pOH = 14 âˆ’ 2 = 12.</li>
        </ol>
        <div style="margin-top:6px; font-size:11px;">
          <b>Antwort:</b> pH â‰ˆ 12, die LÃ¶sung ist deutlich basisch.
        </div>
      `
    },
    {
      title: "Typische Klausurfallen & MerksÃ¤tze",
      content: `
        <ul style="padding-left:18px; margin:0;">
          <li><b>Falle 1:</b> pH direkt aus c(Base) berechnen (statt Ã¼ber pOH) â‡’ immer erst [OHâ»] â†’ pOH â†’ pH.</li>
          <li><b>Falle 2:</b> Mehrprotonige SÃ¤uren/Basen ignorieren:
              z. B. Hâ‚‚SOâ‚„ â€“ im ersten Schritt gibt es 2 Hâº pro MolekÃ¼l â†’ [Hâº] â‰ˆ 2Â·c(Hâ‚‚SOâ‚„).</li>
          <li><b>Falle 3:</b> Falsche Einheiten: Konzentrationen mÃ¼ssen in mol/L eingesetzt werden, nicht in g/L.</li>
          <li><b>Falle 4:</b> K<sub>w</sub> vergessen: Bei sehr verdÃ¼nnten LÃ¶sungen oder wenn nur [OHâ»] gegeben ist, hilft K<sub>w</sub> = [Hâº][OHâ»].</li>
          <li><b>Merksatz:</b> "Stark" heiÃŸt: ich darf [Hâº] bzw. [OHâ»] (fast) gleich der Anfangskonzentration setzen.</li>
        </ul>
      `
    }
  ]
}
,
{
  id: "titrationen",
  title: "Titrationen (SÃ¤ure-Base, FÃ¤llung, Komplexometrie, Redox)",
  tags: ["Titration", "Ã„quivalenzpunkt", "Titrationskurve", "Gehaltsbestimmung"],
  goals: [
    "Das Grundprinzip einer Titration erklÃ¤ren kÃ¶nnen.",
    "Ã„quivalenzpunkt, Umschlagpunkt und Endpunkt sicher unterscheiden.",
    "Gehaltsbestimmung aus câ‚Â·Vâ‚ = câ‚‚Â·Vâ‚‚ in einfachen FÃ¤llen durchfÃ¼hren.",
    "Den Unterschied zwischen SÃ¤ure-Base-, FÃ¤llungs-, komplexometrischen und Redoxtitrationen kennen."
  ],
  summary:
    "Bei einer Titration wird eine MaÃŸlÃ¶sung definierter Konzentration zu einer Probe gegeben, bis die stÃ¶chiometrische Menge erreicht ist (Ã„quivalenzpunkt). Ãœber das verbrauchte Volumen und die bekannte Konzentration der MaÃŸlÃ¶sung kann man die Konzentration der Probe berechnen. In der Klausur sind typische Themen: SÃ¤ure-Base-Titrationen, Ã„quivalenzpunkt-Bestimmung, Indikatorwahl, einfache Gehaltsberechnung.",
  keyPoints: [
    "MaÃŸlÃ¶sung: LÃ¶sung bekannter Konzentration (c bekannt).",
    "ProbelÃ¶sung: zu untersuchende LÃ¶sung (c gesucht).",
    "Ã„quivalenzpunkt: stÃ¶chiometrisch genaues MengenverhÃ¤ltnis erreicht.",
    "Umschlagpunkt/Endpunkt: der tatsÃ¤chlich beobachtete Farbumschlag des Indikators (liegt nahe am Ã„quivalenzpunkt).",
    "Titrationskurve: grafische Darstellung von pH (oder Potential) gegen zugegebenes Volumen.",
    "Standardrezept Gehaltsbestimmung: câ‚Â·Vâ‚ = câ‚‚Â·Vâ‚‚ (nach Stoffmenge n = cÂ·V)."
  ],
  formulas: [
    "n = c Â· V",
    "c(ProbelÃ¶sung) = (c(MaÃŸlÃ¶sung) Â· V(MaÃŸlÃ¶sung)) / V(ProbelÃ¶sung) (bei einfacher 1:1-StÃ¶chiometrie)",
    "fÃ¼r andere VerhÃ¤ltnisse: Î½â‚Â·câ‚Â·Vâ‚ = Î½â‚‚Â·câ‚‚Â·Vâ‚‚ (Î½ = stÃ¶chiometrischer Koeffizient)"
  ],
  visual: `
    <div style="font-size:11px;margin-bottom:4px;">Idealisierte SÃ¤ure-Base-Titrationskurve (starke SÃ¤ure mit starker Base):</div>
    <pre style="font-size:10px;line-height:1.2;">
pH
14 |                           ______
   |                        __/
   |                     __/
   |                  __/
   |               __/
   |            __/
   |         __/
   |      __/
   |   __/
   |__/
   +--------------------------------- V
          &uarr;
     Ã„quivalenzpunkt (starker Anstieg)
    </pre>
  `,
  detailBlocks: [
    {
      title: "Grundprinzip der Titration",
      content: `
        <ul style="padding-left:18px;margin:0;">
          <li>Man gibt eine <b>MaÃŸlÃ¶sung</b> definierter Konzentration tropfenweise zu einer <b>ProbelÃ¶sung</b> unbekannter Konzentration.</li>
          <li>Die reagierenden Stoffe stehen in einer <b>stÃ¶chiometrischen Reaktionsgleichung</b> (z. B. 1:1 oder 1:2).</li>
          <li>Am <b>Ã„quivalenzpunkt</b> sind die Stoffmengen im stÃ¶chiometrisch richtigen VerhÃ¤ltnis umgesetzt.</li>
          <li>Ãœber das verbrauchte Volumen der MaÃŸlÃ¶sung und ihre Konzentration kann man die Stoffmenge berechnen und daraus die Konzentration der Probe.</li>
          <li>Ein <b>Indikator</b> (oder pH-Meter/LeitfÃ¤higkeit) zeigt an, wann der Endpunkt (nahe beim Ã„quivalenzpunkt) erreicht ist.</li>
        </ul>
      `
    },
    {
      title: "SÃ¤ure-Base-Titrationen (stark/stark)",
      content: `
        <ul style="padding-left:18px;margin:0;">
          <li><b>Beispiel:</b> HCl (starke SÃ¤ure) mit NaOH (starke Base).</li>
          <li>Reaktionsgleichung: HCl + NaOH â†’ NaCl + Hâ‚‚O (1:1-VerhÃ¤ltnis).</li>
          <li><b>Vor dem Ã„P:</b> LÃ¶sung ist sauer, pH wird durch Ãœberschuss an HCl bestimmt.</li>
          <li><b>Am Ã„P:</b> StÃ¶chiometrisch gleiche Stoffmenge HCl und NaOH umgesetzt, pH â‰ˆ 7 (bei starken SÃ¤uren/Basen in Wasser).</li>
          <li><b>Nach dem Ã„P:</b> LÃ¶sung ist basisch, pH wird durch Ãœberschuss an NaOH bestimmt.</li>
        </ul>
        <div style="font-size:11px;margin-top:6px;">
          <b>Gehaltsberechnung (1:1):</b> c(HCl) = c(NaOH) Â· V(NaOH) / V(HCl) 
        </div>
      `
    },
    {
      title: "Titrationen mit anderen StÃ¶chiometrien",
      content: `
        <ul style="padding-left:18px;margin:0;">
          <li>Reaktionsgleichung muss immer <b>zuerst</b> aufgestellt und ausgeglichen werden.</li>
          <li>Beispiel: 2 HCl + Naâ‚‚COâ‚ƒ â†’ 2 NaCl + Hâ‚‚O + COâ‚‚ â†’ VerhÃ¤ltnis 2:1.</li>
          <li>Dann gilt: 2 Â· n(Naâ‚‚COâ‚ƒ) = n(HCl) oder allgemein: Î½â‚Â·nâ‚ = Î½â‚‚Â·nâ‚‚.</li>
          <li>Ãœbertragen auf Konzentration und Volumen: Î½â‚Â·câ‚Â·Vâ‚ = Î½â‚‚Â·câ‚‚Â·Vâ‚‚.</li>
          <li>Das ist die <b>allgemeine Gehaltsgleichung</b> fÃ¼r Titrationen.</li>
        </ul>
      `
    },
    {
      title: "Beispielaufgabe (Gehaltsbestimmung)",
      content: `
        <div style="font-size:12px;margin-bottom:4px;">
          <b>Aufgabe:</b> 25,0 mL SalzsÃ¤ure werden mit 0,100 mol/L NaOH titriert. Der Ã„quivalenzpunkt liegt bei 18,6 mL NaOH. Berechne c(HCl).
        </div>
        <ol style="padding-left:18px;margin:0;">
          <li>Reaktionsgleichung: HCl + NaOH â†’ NaCl + Hâ‚‚O (1:1).</li>
          <li>Formel: c(HCl) Â· V(HCl) = c(NaOH) Â· V(NaOH).</li>
          <li>Einsetzen: c(HCl) Â· 25,0 mL = 0,100 mol/L Â· 18,6 mL.</li>
          <li>Volumina in L umrechnen oder kÃ¼rzen, da beide in mL: c(HCl) = 0,100 Â· 18,6 / 25,0 mol/L.</li>
          <li>c(HCl) â‰ˆ 0,0744 mol/L.</li>
        </ol>
        <div style="font-size:11px;margin-top:6px;">
          <b>Antwort:</b> Die SalzsÃ¤ure hat eine Konzentration von ca. 0,074 mol/L.
        </div>
      `
    },
    {
      title: "Andere Titrationsarten (Ãœberblick)",
      content: `
        <ul style="padding-left:18px;margin:0;">
          <li><b>FÃ¤llungstitration:</b> Bildung eines schwerlÃ¶slichen Niederschlags (z. B. Agâº + Clâ» â†’ AgClâ†“) â€“ Ã„P Ã¼ber LeitfÃ¤higkeit oder Indikator.</li>
          <li><b>Komplexometrische Titration:</b> Bildung von Komplexen (z. B. EDTA-Titration von CaÂ²âº/MgÂ²âº) â€“ Indikatoren sind oft Metallindikatoren.</li>
          <li><b>Redoxtitration:</b> Redoxreaktion zwischen MaÃŸ- und ProbelÃ¶sung (z. B. Permanganattitration) â€“ Ã„P Ã¼ber Potentialsprung oder EigenfÃ¤rbung.</li>
        </ul>
      `
    },
    {
      title: "Typische Klausurfallen & MerksÃ¤tze",
      content: `
        <ul style="padding-left:18px;margin:0;">
          <li><b>Falle 1:</b> StoÃŸzahlen ignorieren â†’ immer zuerst Reaktionsgleichung sauber ausgleichen.</li>
          <li><b>Falle 2:</b> Volumen in mL einsetzen, obwohl in der Formel L gebraucht werden â†’ Einheit checken!</li>
          <li><b>Falle 3:</b> Ã„quivalenzpunkt und Umschlagpunkt verwechseln.</li>
          <li><b>Falle 4:</b> câ‚Â·Vâ‚ = câ‚‚Â·Vâ‚‚ anwenden, obwohl VerhÃ¤ltnis â‰  1:1 â†’ dann braucht man Î½â‚Â·câ‚Â·Vâ‚ = Î½â‚‚Â·câ‚‚Â·Vâ‚‚.</li>
          <li><b>Merksatz:</b> <i>â€Erst Reaktionsgleichung, dann rechnen.â€œ</i></li>
        </ul>
      `
    }
  ]
},

{
 id: "redox",
 title: "Redoxreaktionen & elektrochemische Spannungsreihe",
 tags: ["Oxidation", "Reduktion", "Redox", "Elektrochemie"],
 goals: [
   "Oxidation und Reduktion sicher definieren (Elektronenabgabe/-aufnahme).",
   "Oxidationszahlen zuweisen und einfache Redoxgleichungen interpretieren kÃ¶nnen.",
   "Die elektrochemische Spannungsreihe zur Vorhersage der Reaktionsrichtung nutzen.",
   "Grundidee von galvanischer Zelle, Standardpotential und Nernst-Gleichung verstehen (auf Klausur-Niveau)."
 ],
 summary:
   "Redoxreaktionen sind Elektronentransferprozesse: Oxidation bedeutet Elektronenabgabe, Reduktion Elektronenaufnahme. Die elektrochemische Spannungsreihe ordnet Halbzellen nach ihren Standardelektrodenpotenzialen. Elemente mit sehr negativem Potential geben leicht Elektronen ab (starke Reduktionsmittel), solche mit hohem Potential wirken als Oxidationsmittel. In galvanischen Zellen wird die freie Reaktionsenergie in elektrische Energie umgewandelt.",
 keyPoints: [
   "Oxidation: Elektronenabgabe (Oxidationszahl wird grÃ¶ÃŸer).",
   "Reduktion: Elektronenaufnahme (Oxidationszahl wird kleiner).",
   "Oxidationsmittel wird selbst reduziert, Reduktionsmittel selbst oxidiert.",
   "Spannungsreihe: Metalle mit negativeren EÂ°-Werten sind stÃ¤rkere Reduktionsmittel.",
   "Zellspannung EÂ°(Zelle) = EÂ°(Kathode) âˆ’ EÂ°(Anode).",
   "Nernst-Gleichung beschreibt KonzentrationsabhÃ¤ngigkeit des Potentials."
 ],
 formulas: [
   "EÂ°(Zelle) = EÂ°(Kathode) âˆ’ EÂ°(Anode)",
   "Nernst (vereinfacht, 25 Â°C): E = EÂ° âˆ’ (0,059 V / z) Â· log(Q)"
 ],
 visual: `
   <div style="font-size:11px;margin-bottom:4px;">Beispiel: Daniell-Element (Zn/Cu-Zelle)</div>
   <pre style="font-size:10px;line-height:1.3;">
Anode (Oxidation):   Zn â†’ ZnÂ²âº + 2 eâ»     (EÂ° â‰ˆ âˆ’0,76 V)
Kathode (Reduktion): CuÂ²âº + 2 eâ» â†’ Cu     (EÂ° â‰ˆ +0,34 V)

Zellreaktion:        Zn + CuÂ²âº â†’ ZnÂ²âº + Cu

EÂ°(Zelle) = EÂ°(Kathode) âˆ’ EÂ°(Anode)
       = (+0,34 V) âˆ’ (âˆ’0,76 V)
       = +1,10 V
   </pre>
 `,
 detailBlocks: [
   {
     title: "Oxidation, Reduktion & Oxidationszahlen",
     content: `
       <ul style="padding-left:18px;margin:0;">
         <li><b>Oxidation:</b> Abgabe von Elektronen (eâ»). Oxidationszahl wird <b>hÃ¶her</b>.</li>
         <li><b>Reduktion:</b> Aufnahme von Elektronen. Oxidationszahl wird <b>niedriger</b>.</li>
         <li><b>Oxidationsmittel:</b> Stoff, der andere oxidiert (nimmt Elektronen auf) â†’ wird selbst <b>reduziert</b>.</li>
         <li><b>Reduktionsmittel:</b> Stoff, der andere reduziert (gibt Elektronen ab) â†’ wird selbst <b>oxidiert</b>.</li>
         <li>Oxidationszahlen helfen, Elektronenzahl bei Redoxreaktionen nachzuvollziehen (Klausurklassiker).</li>
       </ul>
     `
   },
   {
     title: "Elektrochemische Spannungsreihe (Prinzip)",
     content: `
       <ul style="padding-left:18px;margin:0;">
         <li>Liste von Halbzellen mit ihren <b>Standardelektrodenpotenzialen EÂ°</b> (in V gegen Standard-Wasserstoffelektrode).</li>
         <li>Je <b>negativer</b> EÂ°, desto leichter gibt die Spezies Elektronen ab â†’ gutes Reduktionsmittel.</li>
         <li>Je <b>positiver</b> EÂ°, desto leichter nimmt die Spezies Elektronen auf â†’ gutes Oxidationsmittel.</li>
         <li><b>Regel:</b> Halbzelle mit grÃ¶ÃŸerem EÂ° wirkt als <b>Kathode</b>, die mit kleinerem EÂ° als <b>Anode</b>.</li>
       </ul>
     `
   },
   {
     title: "Galvanische Zelle (am Beispiel Zn/Cu)",
     content: `
       <ol style="padding-left:18px;margin:0;">
         <li><b>Anode:</b> Zn-Elektrode in ZnÂ²âº-LÃ¶sung, hier lÃ¤uft die Oxidation: Zn â†’ ZnÂ²âº + 2 eâ».</li>
         <li><b>Kathode:</b> Cu-Elektrode in CuÂ²âº-LÃ¶sung, hier lÃ¤uft die Reduktion: CuÂ²âº + 2 eâ» â†’ Cu.</li>
         <li>Elektronen flieÃŸen Ã¼ber den Ã¤uÃŸeren Leiter von der Anode zur Kathode.</li>
         <li>Die <b>SalzbrÃ¼cke</b> sorgt fÃ¼r Ladungsausgleich (Ionentransport), damit der Strom nicht abreiÃŸt.</li>
         <li>Die gemessene Spannung entspricht E(Zelle).</li>
       </ol>
     `
   },
   {
     title: "Nernst-Gleichung (auf Klausurniveau)",
     content: `
       <div style="font-size:12px;margin-bottom:4px;">
         Die Nernst-Gleichung beschreibt, wie sich das Elektrodenpotential mit der Konzentration der beteiligten Ionen Ã¤ndert.
       </div>
       <div style="padding-left:18px;font-size:12px;">
         <b>Allgemein (25 Â°C):</b><br/>
         E = EÂ° âˆ’ (0,059 V / z) Â· log(Q)
       </div>
       <ul style="padding-left:18px;margin-top:4px;">
         <li>E: aktuelles Elektrodenpotential.</li>
         <li>EÂ°: Standardelektrodenpotential (bei 1 mol/L).</li>
         <li>z: Zahl der Ã¼bertragenen Elektronen.</li>
         <li>Q: Reaktionsquotient (VerhÃ¤ltnis Produkte/Edukte).</li>
       </ul>
       <div style="font-size:11px;margin-top:6px;">
         In vielen Klausuren reicht es zu wissen, dass hÃ¶here Produktkonzentration das Potential verschiebt
         und dass aus Konzentrationsunterschieden eine messbare Spannung entsteht.
       </div>
     `
   },
   {
     title: "Typische Klausuraufgaben & Fallen",
        content: `
          <ul style="padding-left:18px;margin:0;">
            <li>Halbreaktionen identifizieren (was wird oxidiert, was reduziert?).</li>
            <li>EÂ°(Zelle) berechnen aus Tabellenwerten â†’ Kathode minus Anode.</li>
            <li>Vorhersagen, ob eine Redoxreaktion freiwillig ablÃ¤uft (EÂ°(Zelle) > 0 â‡’ tendenziell freiwillig).</li>
            <li><b>Falle 1:</b> Anode/Kathode verwechseln (Merksatz: â€Anode = Oxidationâ€œ).</li>
            <li><b>Falle 2:</b> Falsche Vorzeichen bei Potentialen (EÂ° nicht einfach addieren, sondern Kathode âˆ’ Anode).</li>
            <li><b>Falle 3:</b> z in der Nernst-Gleichung vergessen.</li>
          </ul>
        `
      }
    ]            // schlieÃŸt detailBlocks
  }              // schlieÃŸt Topic "redox"
  ]              // schlieÃŸt topics-Array
}                // schlieÃŸt Subject "Allgemeine Chemie"
  ]
};               // schlieÃŸt learnData



    // ---------- DATENMODELL ----------
    let data = {
      theme: "dark",
      notebooks: [],
      activeNotebookId: null,
      activePageId: null,
      cards: { decks: [] },
      planner: { exams: [], focusSessions: [] },
      formulas: [],
      tasks: [],
      brain: { entries: [] }
    };

    const STORAGE_KEY = "uniHyperNotes_v3";

    // ---------- COMMON DOM ----------
    const tabButtons = document.querySelectorAll(".tab-btn");
    const sections = {
      notes: document.getElementById("notesLayout"),
      cards: document.getElementById("cardsSection"),
      planner: document.getElementById("plannerSection"),
      formulas: document.getElementById("formulasSection"),
      tools: document.getElementById("toolsSection"),
      learn: document.getElementById("learnSection"),
      tasks: document.getElementById("tasksSection"),
      brain: document.getElementById("brainSection"),
      stats: document.getElementById("statsSection")
    };

    const darkModeBtn = document.getElementById("darkModeBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");

    // ---------- NOTIZEN / CANVAS ----------
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const notebookSelect = document.getElementById("notebookSelect");
    const addNotebookBtn = document.getElementById("addNotebookBtn");

    const addPageBtn = document.getElementById("addPageBtn");
    const pageList = document.getElementById("pageList");
    const templateSelect = document.getElementById("templateSelect");

    const colorPicker = document.getElementById("colorPicker");
    const toolButtons = document.querySelectorAll(".tool-btn");
    const strokeButtons = document.querySelectorAll(".stroke-btn");
    const undoBtn = document.getElementById("undoBtn");
    const redoBtn = document.getElementById("redoBtn");
    const clearBtn = document.getElementById("clearBtn");
    const exportPageBtn = document.getElementById("exportPageBtn");

    let currentTool = "pen"; // pen | highlighter | eraser | line | rect | circle
    let currentColor = colorPicker.value;
    let currentWidth = 2;
    let drawing = false;
    let currentStroke = null;
    let lastPos = { x: 0, y: 0 };
    let undoStack = [];
    let redoStack = [];
    let shapeStartPos = null;

    function getActiveNotebook() {
      return data.notebooks.find(nb => nb.id === data.activeNotebookId);
    }

    function getActivePage() {
      const nb = getActiveNotebook();
      if (!nb) return null;
      return nb.pages.find(p => p.id === data.activePageId);
    }

    // ---------- Storage & Theme ----------
    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error("Speichern fehlgeschlagen", e);
      }
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const defaultNotebook = {
          id: "nb-" + Date.now(),
          name: "Standard",
          pages: [
            { id: "p-" + Date.now(), name: "Seite 1", template: "blank", strokes: [] }
          ]
        };
        data.notebooks = [defaultNotebook];
        data.activeNotebookId = defaultNotebook.id;
        data.activePageId = defaultNotebook.pages[0].id;
        data.theme = "dark";
        data.cards = { decks: [] };
        data.planner = { exams: [], focusSessions: [] };
        data.formulas = [];
        data.tasks = [];
        data.brain = { entries: [] };
        return;
      }
      try {
        data = JSON.parse(raw);
      } catch (e) {
        console.error("Fehler beim Laden, initialisiere neu", e);
        localStorage.removeItem(STORAGE_KEY);
        loadData();
      }
    }

    function applyTheme() {
      if (data.theme === "light") {
        document.body.classList.add("light");
      } else {
        document.body.classList.remove("light");
      }
    }

    function toggleTheme() {
      data.theme = data.theme === "dark" ? "light" : "dark";
      applyTheme();
      saveData();
    }

    darkModeBtn.addEventListener("click", toggleTheme);

    // ---------- Tabs ----------
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.getAttribute("data-tab");
        Object.keys(sections).forEach(k => {
          if (k === "notes") {
            sections[k].classList.toggle("active", tab === "notes");
            sections[k].style.display = tab === "notes" ? "flex" : "none";
          } else {
            sections[k].classList.toggle("active", k === tab);
          }
        });
        if (tab === "stats") renderStats();
      });
    });

    // ---------- Notebooks & Seiten ----------
    function renderNotebookSelect() {
      notebookSelect.innerHTML = "";
      data.notebooks.forEach(nb => {
        const opt = document.createElement("option");
        opt.value = nb.id;
        opt.textContent = nb.name;
        if (nb.id === data.activeNotebookId) opt.selected = true;
        notebookSelect.appendChild(opt);
      });
    }

    function switchNotebook(id) {
      if (id === data.activeNotebookId) return;
      data.activeNotebookId = id;
      const nb = getActiveNotebook();
      if (!nb) return;
      data.activePageId = nb.pages[0]?.id || null;
      undoStack = [];
      redoStack = [];
      renderNotebookSelect();
      renderPageList();
      redrawActivePage();
      saveData();
    }

    function addNotebook() {
      const name = prompt("Name fÃ¼r das neue Notizbuch:", "Neues Notizbuch");
      if (!name) return;
      const nb = {
        id: "nb-" + Date.now(),
        name,
        pages: [{ id: "p-" + Date.now(), name: "Seite 1", template: "blank", strokes: [] }]
      };
      data.notebooks.push(nb);
      data.activeNotebookId = nb.id;
      data.activePageId = nb.pages[0].id;
      undoStack = [];
      redoStack = [];
      renderNotebookSelect();
      renderPageList();
      redrawActivePage();
      saveData();
    }

    function renderPageList() {
      const nb = getActiveNotebook();
      pageList.innerHTML = "";
      if (!nb) return;
      nb.pages.forEach((page, index) => {
        const div = document.createElement("div");
        div.className = "page-thumb" + (page.id === data.activePageId ? " active" : "");
        div.textContent = page.name;
        const idx = document.createElement("span");
        idx.className = "index";
        idx.textContent = index + 1;
        div.appendChild(idx);
        div.addEventListener("click", () => {
          if (page.id === data.activePageId) return;
          data.activePageId = page.id;
          undoStack = [];
          redoStack = [];
          renderPageList();
          redrawActivePage();
          saveData();
        });
        pageList.appendChild(div);
      });
      const activePage = getActivePage();
      if (activePage) templateSelect.value = activePage.template || "blank";
    }

    function addPage() {
      const nb = getActiveNotebook();
      if (!nb) return;
      const page = {
        id: "p-" + Date.now(),
        name: "Seite " + (nb.pages.length + 1),
        template: templateSelect.value || "blank",
        strokes: []
      };
      nb.pages.push(page);
      data.activePageId = page.id;
      undoStack = [];
      redoStack = [];
      renderPageList();
      redrawActivePage();
      saveData();
    }

    function setPageTemplate(template) {
      const page = getActivePage();
      if (!page) return;
      page.template = template;
      redrawActivePage();
      saveData();
    }

    function resizeCanvas() {
      const margin = 20;
      const wrapper = document.getElementById("canvasWrapper");
      const w = wrapper.clientWidth - margin * 2;
      const h = wrapper.clientHeight - margin * 2 - 40;

      const aspect = 1 / 1.414; // A4
      let cw = w, ch = w / aspect;
      if (ch > h) {
        ch = h;
        cw = h * aspect;
      }

      const page = getActivePage();
      const oldStrokes = page ? JSON.parse(JSON.stringify(page.strokes)) : null;
      const tmpl = page ? page.template : "blank";

      canvas.width = cw;
      canvas.height = ch;

      if (page && oldStrokes) {
        page.strokes = oldStrokes;
        page.template = tmpl;
      }
      redrawActivePage();
    }

    window.addEventListener("resize", resizeCanvas);

    function drawTemplate(template) {
      const w = canvas.width, h = canvas.height;
      ctx.save();
      ctx.globalAlpha = 0.15;
      ctx.strokeStyle = "#7a7a7a";
      ctx.lineWidth = 1;
      if (template === "lined") {
        const lineSpacing = 32;
        for (let y = lineSpacing; y < h; y += lineSpacing) {
          ctx.beginPath(); ctx.moveTo(0, y + 0.5); ctx.lineTo(w, y + 0.5); ctx.stroke();
        }
      } else if (template === "dotted") {
        const spacing = 32;
        for (let y = spacing; y < h; y += spacing) {
          for (let x = spacing; x < w; x += spacing) {
            ctx.beginPath();
            ctx.arc(x, y, 1, 0, Math.PI * 2);
            ctx.fillStyle = "#7a7a7a";
            ctx.fill();
          }
        }
      } else if (template === "grid") {
        const spacing = 32;
        for (let y = spacing; y < h; y += spacing) {
          ctx.beginPath(); ctx.moveTo(0, y + 0.5); ctx.lineTo(w, y + 0.5); ctx.stroke();
        }
        for (let x = spacing; x < w; x += spacing) {
          ctx.beginPath(); ctx.moveTo(x + 0.5, 0); ctx.lineTo(x + 0.5, h); ctx.stroke();
        }
      }
      ctx.restore();
    }

    function redrawActivePage() {
      const page = getActivePage();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!page) return;
      drawTemplate(page.template || "blank");
      page.strokes.forEach(stroke => {
        ctx.save();
        if (stroke.tool === "eraser") {
          ctx.globalCompositeOperation = "destination-out";
          ctx.strokeStyle = "rgba(0,0,0,1)";
          ctx.lineWidth = stroke.width;
          ctx.globalAlpha = 1;
        } else if (stroke.tool === "highlighter") {
          ctx.globalCompositeOperation = "source-over";
          ctx.strokeStyle = stroke.color;
          ctx.lineWidth = stroke.width;
          ctx.globalAlpha = stroke.alpha ?? 0.35;
        } else {
          ctx.globalCompositeOperation = "source-over";
          ctx.strokeStyle = stroke.color;
          ctx.lineWidth = stroke.width;
          ctx.globalAlpha = 1;
        }
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        const pts = stroke.points;
        if (pts.length > 1) {
          ctx.beginPath();
          ctx.moveTo(pts[0].x * canvas.width, pts[0].y * canvas.height);
          for (let i = 1; i < pts.length; i++) {
            ctx.lineTo(pts[i].x * canvas.width, pts[i].y * canvas.height);
          }
          ctx.stroke();
        }
        ctx.restore();
      });
      ctx.globalAlpha = 1;
      ctx.globalCompositeOperation = "source-over";
    }

    function normPos(evt) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (evt.touches && evt.touches.length > 0) {
        clientX = evt.touches[0].clientX;
        clientY = evt.touches[0].clientY;
      } else {
        clientX = evt.clientX;
        clientY = evt.clientY;
      }
      const x = (clientX - rect.left) / rect.width;
      const y = (clientY - rect.top) / rect.height;
      return { x: Math.max(0, Math.min(1, x)), y: Math.max(0, Math.min(1, y)) };
    }

    function startDrawing(evt) {
      evt.preventDefault();
      const page = getActivePage();
      if (!page) return;

      drawing = true;
      redoStack = [];

      const p = normPos(evt);
      lastPos = p;

      if (["line", "rect", "circle"].includes(currentTool)) {
        shapeStartPos = p;
        currentStroke = {
          tool: "pen",
          color: currentColor,
          width: currentWidth,
          alpha: 1,
          points: [p]
        };
      } else {
        const stroke = {
          tool: currentTool,
          color: currentColor,
          width: currentTool === "highlighter" ? currentWidth * 2 : currentWidth,
          alpha: currentTool === "highlighter" ? 0.35 : 1,
          points: [p]
        };
        if (currentTool === "eraser") {
          stroke.color = "#000000";
          stroke.alpha = 1;
        }
        currentStroke = stroke;
        drawStrokeSegment(lastPos, p, stroke);
      }
    }

    function drawStrokeSegment(from, to, stroke) {
      ctx.save();
      if (stroke.tool === "eraser") {
        ctx.globalCompositeOperation = "destination-out";
        ctx.strokeStyle = "rgba(0,0,0,1)";
        ctx.lineWidth = stroke.width;
        ctx.globalAlpha = 1;
      } else if (stroke.tool === "highlighter") {
        ctx.globalCompositeOperation = "source-over";
        ctx.strokeStyle = stroke.color;
        ctx.lineWidth = stroke.width;
        ctx.globalAlpha = stroke.alpha ?? 0.35;
      } else {
        ctx.globalCompositeOperation = "source-over";
        ctx.strokeStyle = stroke.color;
        ctx.lineWidth = stroke.width;
        ctx.globalAlpha = 1;
      }
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.beginPath();
      ctx.moveTo(from.x * canvas.width, from.y * canvas.height);
      ctx.lineTo(to.x * canvas.width, to.y * canvas.height);
      ctx.stroke();
      ctx.restore();
      ctx.globalAlpha = 1;
      ctx.globalCompositeOperation = "source-over";
    }

    function previewShape(currentPos) {
      if (!shapeStartPos || !currentStroke) return;
      redrawActivePage();
      ctx.save();
      ctx.globalCompositeOperation = "source-over";
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = currentWidth;
      ctx.globalAlpha = 1;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";

      const x0 = shapeStartPos.x * canvas.width;
      const y0 = shapeStartPos.y * canvas.height;
      const x1 = currentPos.x * canvas.width;
      const y1 = currentPos.y * canvas.height;

      if (currentTool === "line") {
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.stroke();
      } else if (currentTool === "rect") {
        const left = Math.min(x0, x1);
        const top = Math.min(y0, y1);
        const w = Math.abs(x1 - x0);
        const h = Math.abs(y1 - y0);
        ctx.strokeRect(left, top, w, h);
      } else if (currentTool === "circle") {
        const centerX = (x0 + x1) / 2;
        const centerY = (y0 + y1) / 2;
        const rx = Math.abs(x1 - x0) / 2;
        const ry = Math.abs(y1 - y0) / 2;
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, rx, ry, 0, 0, Math.PI * 2);
        ctx.stroke();
      }

      ctx.restore();
    }

    function moveDrawing(evt) {
      if (!drawing || !currentStroke) return;
      evt.preventDefault();
      const p = normPos(evt);

      if (["line", "rect", "circle"].includes(currentTool)) {
        previewShape(p);
      } else {
        drawStrokeSegment(lastPos, p, currentStroke);
        currentStroke.points.push(p);
      }

      lastPos = p;
    }

    function stopDrawing(evt) {
      if (!drawing) return;
      drawing = false;

      const page = getActivePage();
      if (!page || !currentStroke) return;

      if (["line", "rect", "circle"].includes(currentTool)) {
        // finale Form als Punkte approximieren
        const start = shapeStartPos;
        const end = lastPos;
        let points = [];
        if (currentTool === "line") {
          points = [start, end];
        } else if (currentTool === "rect") {
          const xs = [start.x, end.x].sort((a,b)=>a-b);
          const ys = [start.y, end.y].sort((a,b)=>a-b);
          const xL = xs[0], xR = xs[1], yT = ys[0], yB = ys[1];
          points = [
            {x:xL, y:yT},
            {x:xR, y:yT},
            {x:xR, y:yB},
            {x:xL, y:yB},
            {x:xL, y:yT}
          ];
        } else if (currentTool === "circle") {
          const steps = 40;
          const cx = (start.x + end.x)/2;
          const cy = (start.y + end.y)/2;
          const rx = Math.abs(end.x - start.x)/2;
          const ry = Math.abs(end.y - start.y)/2;
          for (let i=0;i<=steps;i++) {
            const t = i/steps * 2*Math.PI;
            points.push({x: cx + rx*Math.cos(t), y: cy + ry*Math.sin(t)});
          }
        }
        currentStroke.points = points;
        page.strokes.push(currentStroke);
        undoStack.push(currentStroke);
        shapeStartPos = null;
        redrawActivePage();
      } else {
        if (currentStroke.points.length < 2) {
          currentStroke.points.push({ ...currentStroke.points[0] });
        }
        page.strokes.push(currentStroke);
        undoStack.push(currentStroke);
      }

      currentStroke = null;
      saveData();
    }

    function doUndo() {
      const page = getActivePage();
      if (!page || page.strokes.length === 0) return;
      const stroke = page.strokes.pop();
      redoStack.push(stroke);
      undoStack.pop();
      redrawActivePage();
      saveData();
    }

    function doRedo() {
      const page = getActivePage();
      if (!page || redoStack.length === 0) return;
      const stroke = redoStack.pop();
      page.strokes.push(stroke);
      undoStack.push(stroke);
      redrawActivePage();
      saveData();
    }

    function clearPage() {
      const page = getActivePage();
      if (!page) return;
      if (!confirm("Diese Seite wirklich komplett leeren?")) return;
      page.strokes = [];
      undoStack = [];
      redoStack = [];
      redrawActivePage();
      saveData();
    }

    function exportPageAsPNG() {
      const page = getActivePage();
      if (!page) return;
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = (page.name || "Seite") + ".png";
      link.click();
    }

    // Canvas Events
    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", moveDrawing);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseleave", stopDrawing);
    canvas.addEventListener("touchstart", startDrawing, { passive: false });
    canvas.addEventListener("touchmove", moveDrawing, { passive: false });
    canvas.addEventListener("touchend", stopDrawing, { passive: false });
    canvas.addEventListener("touchcancel", stopDrawing, { passive: false });

    toolButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        toolButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentTool = btn.getAttribute("data-tool");
      });
    });

    colorPicker.addEventListener("input", () => {
      currentColor = colorPicker.value;
    });

    strokeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        strokeButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentWidth = parseInt(btn.getAttribute("data-width"), 10);
      });
    });

    undoBtn.addEventListener("click", doUndo);
    redoBtn.addEventListener("click", doRedo);
    clearBtn.addEventListener("click", clearPage);
    addNotebookBtn.addEventListener("click", addNotebook);
    notebookSelect.addEventListener("change", e => switchNotebook(e.target.value));
    addPageBtn.addEventListener("click", addPage);
    templateSelect.addEventListener("change", e => setPageTemplate(e.target.value));
    exportPageBtn.addEventListener("click", exportPageAsPNG);

    // Backup
    exportJsonBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "uni-hyper-notes-backup.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // ---------- KARTEIKARTEN ----------
    const deckNameInput = document.getElementById("cardDeckName");
    const addDeckBtn = document.getElementById("addDeckBtn");
    const deckListDiv = document.getElementById("deckList");
    const cardQuestion = document.getElementById("cardQuestion");
    const cardAnswer = document.getElementById("cardAnswer");
    const cardTags = document.getElementById("cardTags");
    const addCardBtn = document.getElementById("addCardBtn");
    const cardListDiv = document.getElementById("cardList");
    const studyDeckSelect = document.getElementById("studyDeckSelect");
    const startStudyBtn = document.getElementById("startStudyBtn");
    const studyArea = document.getElementById("studyArea");
    const studyQuestionDiv = document.getElementById("studyQuestion");
    const studyAnswerDiv = document.getElementById("studyAnswer");
    const revealAnswerBtn = document.getElementById("revealAnswerBtn");
    const studyFeedback = document.getElementById("studyFeedback");
    const studyGradeBtns = document.querySelectorAll(".studyGradeBtn");
    let currentStudyDeckId = null;
    let currentStudyCardId = null;

    function renderDecks() {
      deckListDiv.innerHTML = "";
      studyDeckSelect.innerHTML = "";
      data.cards.decks.forEach(deck => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<strong>${deck.name}</strong> <span class="badge">${deck.cards.length} Karten</span>`;
        card.addEventListener("click", () => selectDeck(deck.id));
        deckListDiv.appendChild(card);

        const opt = document.createElement("option");
        opt.value = deck.id;
        opt.textContent = deck.name;
        studyDeckSelect.appendChild(opt);
      });
      if (!currentStudyDeckId && data.cards.decks[0]) currentStudyDeckId = data.cards.decks[0].id;
      if (currentStudyDeckId) studyDeckSelect.value = currentStudyDeckId;
      renderCards();
    }

    function selectDeck(id) {
      currentStudyDeckId = id;
      renderCards();
    }

    function renderCards() {
      const deck = data.cards.decks.find(d => d.id === currentStudyDeckId);
      cardListDiv.innerHTML = "";
      if (!deck) return;
      deck.cards.forEach(c => {
        const div = document.createElement("div");
        div.className = "card";
        const due = c.nextDue ? new Date(c.nextDue) : null;
        const daysLeft = due ? Math.round((due - Date.now()) / (1000 * 60 * 60 * 24)) : null;
        div.innerHTML = `
          <div style="font-weight:600;">${c.q}</div>
          <div style="font-size:13px; margin-top:4px; opacity:0.8;">${c.a}</div>
          <div style="margin-top:4px;">
            ${(c.tags || []).map(t => `<span class="pill">${t}</span>`).join("")}
          </div>
          <div style="margin-top:4px; font-size:11px; opacity:0.7;">
            NÃ¤chste Wiederholung: ${
              due
                ? due.toLocaleDateString() +
                  (daysLeft >= 0 ? ` (in ${daysLeft} Tagen)` : ` (Ã¼berfÃ¤llig)`)
                : "noch nie"
            }
          </div>`;
        cardListDiv.appendChild(div);
      });
    }

    function addDeck() {
      const name = deckNameInput.value.trim();
      if (!name) return;
      data.cards.decks.push({ id: "deck-" + Date.now(), name, cards: [] });
      deckNameInput.value = "";
      saveData();
      renderDecks();
    }

    function addCard() {
      const deck = data.cards.decks.find(d => d.id === currentStudyDeckId);
      if (!deck) return;
      const q = cardQuestion.value.trim();
      const a = cardAnswer.value.trim();
      if (!q || !a) return;
      const tags = cardTags.value
        ? cardTags.value.split(",").map(t => t.trim()).filter(Boolean)
        : [];
      deck.cards.push({
        id: "card-" + Date.now(),
        q, a, tags,
        nextDue: null,
        easiness: 2.5,
        interval: 1,
        repetitions: 0
      });
      cardQuestion.value = "";
      cardAnswer.value = "";
      cardTags.value = "";
      saveData();
      renderCards();
    }

    function startStudy() {
      const deckId = studyDeckSelect.value;
      currentStudyDeckId = deckId;
      const deck = data.cards.decks.find(d => d.id === deckId);
      if (!deck || deck.cards.length === 0) return;
      pickNextStudyCard();
      studyArea.style.display = "block";
    }

    function pickNextStudyCard() {
      const deck = data.cards.decks.find(d => d.id === currentStudyDeckId);
      if (!deck) return;
      const now = Date.now();
      const dueCards = deck.cards.filter(c => !c.nextDue || c.nextDue <= now);
      const pool = dueCards.length > 0 ? dueCards : deck.cards;
      const card = pool[Math.floor(Math.random() * pool.length)];
      currentStudyCardId = card.id;
      studyQuestionDiv.textContent = card.q;
      studyAnswerDiv.textContent = card.a;
      studyAnswerDiv.style.display = "none";
      studyFeedback.style.display = "none";
      revealAnswerBtn.style.display = "inline-block";
    }

    function revealAnswer() {
      studyAnswerDiv.style.display = "block";
      studyFeedback.style.display = "block";
      revealAnswerBtn.style.display = "none";
    }

    function gradeStudy(evt) {
      const grade = parseInt(evt.target.getAttribute("data-grade"), 10);
      const deck = data.cards.decks.find(d => d.id === currentStudyDeckId);
      if (!deck) return;
      const card = deck.cards.find(c => c.id === currentStudyCardId);
      if (!card) return;
      let e = card.easiness || 2.5;
      e = e + (0.1 - (3 - grade) * (0.08 + (3 - grade) * 0.02));
      if (e < 1.3) e = 1.3;
      card.easiness = e;
      if (grade < 2) {
        card.repetitions = 0;
        card.interval = 1;
      } else {
        card.repetitions = (card.repetitions || 0) + 1;
        if (card.repetitions === 1) card.interval = 1;
        else if (card.repetitions === 2) card.interval = 6;
        else card.interval = Math.round((card.interval || 1) * e);
      }
      const now = Date.now();
      card.nextDue = now + card.interval * 24 * 60 * 60 * 1000;
      saveData();
      renderCards();
      pickNextStudyCard();
    }

    addDeckBtn.addEventListener("click", addDeck);
    addCardBtn.addEventListener("click", addCard);
    startStudyBtn.addEventListener("click", startStudy);
    revealAnswerBtn.addEventListener("click", revealAnswer);
    studyGradeBtns.forEach(b => b.addEventListener("click", gradeStudy));

    // ---------- PLANER ----------
    const examName = document.getElementById("examName");
    const examDate = document.getElementById("examDate");
    const examWeight = document.getElementById("examWeight");
    const addExamBtn = document.getElementById("addExamBtn");
    const examListDiv = document.getElementById("examList");
    const blockTopic = document.getElementById("blockTopic");
    const blockMinutes = document.getElementById("blockMinutes");
    const startBlockBtn = document.getElementById("startBlockBtn");
    const focusStatus = document.getElementById("focusStatus");
    let blockTimer = null;
    let blockEndTime = null;

    function renderExams() {
      examListDiv.innerHTML = "";
      const exams = data.planner.exams.slice().sort((a, b) => (a.date || "") < (b.date || "") ? -1 : 1);
      exams.forEach(ex => {
        const div = document.createElement("div");
        div.className = "card";
        const d = ex.date ? new Date(ex.date) : null;
        let daysText = "â€“";
        if (d) {
          const diff = Math.round((d.getTime() - Date.now()) / (1000 * 60 * 60 * 24));
          daysText = diff >= 0 ? `in ${diff} Tagen` : `${-diff} Tage her`;
        }
        div.innerHTML = `
          <div style="font-weight:600;">${ex.name}</div>
          <div style="font-size:13px; margin-top:4px;">Datum: ${d ? d.toLocaleDateString() : "kein Datum"} | Wichtigkeit: ${ex.weight || "-"}</div>
          <div style="font-size:12px; margin-top:4px; opacity:0.8;">${daysText}</div>`;
        examListDiv.appendChild(div);
      });
    }

    function addExam() {
      const name = examName.value.trim();
      const date = examDate.value || null;
      const weight = examWeight.value ? parseInt(examWeight.value, 10) : null;
      if (!name) return;
      data.planner.exams.push({ id: "exam-" + Date.now(), name, date, weight });
      examName.value = "";
      examDate.value = "";
      examWeight.value = "";
      saveData();
      renderExams();
    }

    function startFocusBlock() {
      const topic = blockTopic.value.trim();
      let minutes = parseInt(blockMinutes.value, 10);
      if (!topic || !minutes || minutes < 5) return;
      const session = {
        id: "fs-" + Date.now(),
        topic,
        minutes,
        timestamp: Date.now()
      };
      data.planner.focusSessions.push(session);
      saveData();
      blockEndTime = Date.now() + minutes * 60 * 1000;
      updateFocusStatus();
      if (blockTimer) clearInterval(blockTimer);
      blockTimer = setInterval(updateFocusStatus, 1000);
    }

    function updateFocusStatus() {
      if (!blockEndTime) {
        focusStatus.textContent = "";
        return;
      }
      const diff = blockEndTime - Date.now();
      if (diff <= 0) {
        focusStatus.textContent = "Fokus-Block beendet â€“ nice!";
        clearInterval(blockTimer);
        blockTimer = null;
        blockEndTime = null;
        return;
      }
      const m = Math.floor(diff / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      focusStatus.textContent = `Fokus lÃ¤uft â€“ noch ${m}m ${s}s`;
    }

    addExamBtn.addEventListener("click", addExam);
    startBlockBtn.addEventListener("click", startFocusBlock);

    // ---------- FORMELN ----------
    const formulaName = document.getElementById("formulaName");
    const formulaExpression = document.getElementById("formulaExpression");
    const formulaTopic = document.getElementById("formulaTopic");
    const formulaVariables = document.getElementById("formulaVariables");
    const formulaNotes = document.getElementById("formulaNotes");
    const addFormulaBtn = document.getElementById("addFormulaBtn");
    const loadBiotechFormulasBtn = document.getElementById("loadBiotechFormulasBtn");
    const formulaFilter = document.getElementById("formulaFilter");
    const formulaListDiv = document.getElementById("formulaList");

    function renderFormulas() {
      const q = formulaFilter.value.toLowerCase();
      formulaListDiv.innerHTML = "";
      data.formulas
        .filter(f =>
          !q ||
          f.name.toLowerCase().includes(q) ||
          (f.topic || "").toLowerCase().includes(q)
        )
        .forEach(f => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div style="font-weight:600;">${f.name}</div>
            <div style="margin-top:4px;">${f.expression}</div>
            <div style="margin-top:4px; font-size:12px;">
              Thema: <span class="pill">${f.topic || "-"}</span>
            </div>
            <div style="margin-top:4px; font-size:12px; opacity:0.8;">
              Variablen: ${f.variables || "-"}
            </div>
            <div style="margin-top:4px; font-size:12px;">${f.notes || ""}</div>`;
          formulaListDiv.appendChild(div);
        });
    }

    function addFormula() {
      const name = formulaName.value.trim();
      const expr = formulaExpression.value.trim();
      if (!name || !expr) return;
      data.formulas.push({
        id: "formula-" + Date.now(),
        name,
        expression: expr,
        topic: formulaTopic.value.trim(),
        variables: formulaVariables.value.trim(),
        notes: formulaNotes.value.trim()
      });
      formulaName.value = "";
      formulaExpression.value = "";
      formulaTopic.value = "";
      formulaVariables.value = "";
      formulaNotes.value = "";
      saveData();
      renderFormulas();
    }

    function loadBiotechFormulas() {
      const presets = [
        {
          name: "Ideale Gasgleichung",
          expression: "p Â· V = n Â· R Â· T",
          topic: "Allgemeine Chemie / Gase",
          variables: "p [Pa], V [mÂ³], n [mol], R = 8,314 JÂ·molâ»Â¹Â·Kâ»Â¹, T [K]",
          notes: "Grundformel fÃ¼r ideale Gase. In PC/Allg. Chemie oft umstellen nach p, V, n oder T."
        },
        {
          name: "Arrhenius-Gleichung",
          expression: "k = A Â· e^(âˆ’Eâ‚ / (R Â· T))",
          topic: "Allgemeine Chemie / Kinetik",
          variables: "k [1/s], A: Frequenzfaktor, Eâ‚ [J/mol], R, T [K]",
          notes: "Beschreibt TemperaturabhÃ¤ngigkeit der Reaktionsgeschwindigkeit."
        },
        {
          name: "Lambert-Beer-Gesetz",
          expression: "A = Îµ Â· c Â· l",
          topic: "Analytik / Spektroskopie",
          variables: "A: Absorption, Îµ [LÂ·molâ»Â¹Â·cmâ»Â¹], c [mol/L], l [cm]",
          notes: "Standard zur Konzentrationsbestimmung mit Photometer."
        },
        {
          name: "Henderson-Hasselbalch",
          expression: "pH = pKâ‚ + log10([Aâ»]/[HA])",
          topic: "Allgemeine Chemie / SÃ¤ure-Base",
          variables: "[Aâ»]: konjugierte Base, [HA]: SÃ¤ure",
          notes: "Wichtig zur Berechnung von PufferlÃ¶sungen."
        },
        {
          name: "VerdÃ¼nnungsgleichung",
          expression: "câ‚ Â· Vâ‚ = câ‚‚ Â· Vâ‚‚",
          topic: "Allgemeine Chemie / LÃ¶sungen",
          variables: "c in [mol/L], V in [L]",
          notes: "Basis beim Ansetzen und VerdÃ¼nnen von LÃ¶sungen."
        },
        {
          name: "Stoffmenge",
          expression: "n = m / M",
          topic: "Allgemeine Chemie / Grundlagen",
          variables: "n [mol], m [g], M [g/mol]",
          notes: "Elementare Umrechnung zwischen Masse und Stoffmenge."
        }
      ];

      presets.forEach(f => {
        const exists = data.formulas.some(ex => ex.name === f.name);
        if (!exists) {
          data.formulas.push({
            id: "formula-" + Date.now() + "-" + Math.random().toString(36).slice(2),
            name: f.name,
            expression: f.expression,
            topic: f.topic,
            variables: f.variables,
            notes: f.notes
          });
        }
      });

      saveData();
      renderFormulas();
      alert("Biotech/Allg.-Chemie-Basisformeln wurden hinzugefÃ¼gt (wo sie noch gefehlt haben).");
    }

    addFormulaBtn.addEventListener("click", addFormula);
    formulaFilter.addEventListener("input", renderFormulas);
    loadBiotechFormulasBtn.addEventListener("click", loadBiotechFormulas);

    // ---------- TOOLS / RECHENTOOL ----------
    const toolFormulaSelect = document.getElementById("toolFormulaSelect");
    const toolInputs = document.getElementById("toolInputs");
    const toolCalcBtn = document.getElementById("toolCalcBtn");
    const toolResult = document.getElementById("toolResult");

    function renderToolInputs() {
      const mode = toolFormulaSelect.value;
      toolResult.textContent = "";
      if (mode === "dilution") {
        toolInputs.innerHTML = `
          <div class="row">
            <div><input type="number" step="any" id="dil_c1" placeholder="câ‚ (leer lassen, wenn gesucht)"></div>
            <div><input type="number" step="any" id="dil_v1" placeholder="Vâ‚"></div>
          </div>
          <div class="row" style="margin-top:4px;">
            <div><input type="number" step="any" id="dil_c2" placeholder="câ‚‚"></div>
            <div><input type="number" step="any" id="dil_v2" placeholder="Vâ‚‚"></div>
          </div>
          <div style="font-size:11px; opacity:0.8; margin-top:4px;">Hinweis: Eine der GrÃ¶ÃŸen (câ‚, Vâ‚, câ‚‚ oder Vâ‚‚) leer lassen, dann wird sie berechnet. Einheiten mÃ¼ssen zueinander passen.</div>
        `;
      } else if (mode === "lambert") {
        toolInputs.innerHTML = `
          <div class="row">
            <div><input type="number" step="any" id="lam_A" placeholder="A (Absorption)"></div>
            <div><input type="number" step="any" id="lam_eps" placeholder="Îµ (z.B. LÂ·molâ»Â¹Â·cmâ»Â¹)"></div>
          </div>
          <div class="row" style="margin-top:4px;">
            <div><input type="number" step="any" id="lam_c" placeholder="c [mol/L] (leer lassen, wenn gesucht)"></div>
            <div><input type="number" step="any" id="lam_l" placeholder="l [cm]"></div>
          </div>
          <div style="font-size:11px; opacity:0.8; margin-top:4px;">Lambert-Beer: A = Îµ Â· c Â· l. Eine der GrÃ¶ÃŸen (meist c) leer lassen, dann wird sie berechnet.</div>
        `;
      }
    }

    function calcTool() {
      const mode = toolFormulaSelect.value;
      toolResult.textContent = "";
      if (mode === "dilution") {
        const c1 = parseFloat(document.getElementById("dil_c1").value);
        const v1 = parseFloat(document.getElementById("dil_v1").value);
        const c2 = parseFloat(document.getElementById("dil_c2").value);
        const v2 = parseFloat(document.getElementById("dil_v2").value);

        const vals = { c1, v1, c2, v2 };
        const empty = Object.entries(vals).filter(([k,v]) => isNaN(v));
        if (empty.length !== 1) {
          toolResult.textContent = "Bitte genau EINE GrÃ¶ÃŸe leer lassen.";
          return;
        }
        const missing = empty[0][0];
        let result;
        try {
          if (missing === "c1") result = c2 * v2 / v1;
          else if (missing === "v1") result = c2 * v2 / c1;
          else if (missing === "c2") result = c1 * v1 / v2;
          else if (missing === "v2") result = c1 * v1 / c2;
        } catch {
          toolResult.textContent = "Rechenfehler â€“ bitte Eingaben prÃ¼fen.";
          return;
        }
        toolResult.textContent = `Ergebnis: ${missing} = ${result}`;
      } else if (mode === "lambert") {
        const A = parseFloat(document.getElementById("lam_A").value);
        const eps = parseFloat(document.getElementById("lam_eps").value);
        const c = parseFloat(document.getElementById("lam_c").value);
        const l = parseFloat(document.getElementById("lam_l").value);

        const vals = { A, eps, c, l };
        const empty = Object.entries(vals).filter(([k,v]) => isNaN(v));
        if (empty.length !== 1) {
          toolResult.textContent = "Bitte genau EINE GrÃ¶ÃŸe leer lassen.";
          return;
        }
        const missing = empty[0][0];
        let result;
        try {
          if (missing === "A") result = eps * c * l;
          else if (missing === "eps") result = A / (c * l);
          else if (missing === "c") result = A / (eps * l);
          else if (missing === "l") result = A / (eps * c);
        } catch {
          toolResult.textContent = "Rechenfehler â€“ bitte Eingaben prÃ¼fen.";
          return;
        }
        toolResult.textContent = `Ergebnis: ${missing} = ${result}`;
      }
    }

    toolFormulaSelect.addEventListener("change", renderToolInputs);
    toolCalcBtn.addEventListener("click", calcTool);

    // ---------- AUFGABEN ----------
    const taskTitle = document.getElementById("taskTitle");
    const taskTopic = document.getElementById("taskTopic");
    const taskText = document.getElementById("taskText");
    const taskNotes = document.getElementById("taskNotes");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const taskListDiv = document.getElementById("taskList");

    function renderTasks() {
      taskListDiv.innerHTML = "";
      data.tasks.forEach(t => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>${t.title}</strong></div>
            <div>
              <span class="pill">${t.topic || "-"}</span>
              <select data-id="${t.id}" class="taskStatusSel">
                <option value="open" ${t.status === "open" ? "selected" : ""}>unsicher</option>
                <option value="ok" ${t.status === "ok" ? "selected" : ""}>geht so</option>
                <option value="done" ${t.status === "done" ? "selected" : ""}>sicher</option>
              </select>
            </div>
          </div>
          <div style="margin-top:4px; font-size:13px; white-space:pre-wrap;">${t.text}</div>
          <div style="margin-top:4px; font-size:12px; opacity:0.8; white-space:pre-wrap;">${t.notes || ""}</div>`;
        taskListDiv.appendChild(div);
      });
      document.querySelectorAll(".taskStatusSel").forEach(sel => {
        sel.addEventListener("change", evt => {
          const id = evt.target.getAttribute("data-id");
          const task = data.tasks.find(tt => tt.id === id);
          if (!task) return;
          task.status = evt.target.value;
          saveData();
        });
      });
    }

    function addTask() {
      const title = taskTitle.value.trim();
      const text = taskText.value.trim();
      if (!title || !text) return;
      data.tasks.push({
        id: "task-" + Date.now(),
        title,
        topic: taskTopic.value.trim(),
        text,
        notes: taskNotes.value.trim(),
        status: "open"
      });
      taskTitle.value = "";
      taskTopic.value = "";
      taskText.value = "";
      taskNotes.value = "";
      saveData();
      renderTasks();
    }

    addTaskBtn.addEventListener("click", addTask);

    // ---------- BRAIN-DUMP ----------
    const brainText = document.getElementById("brainText");
    const saveBrainBtn = document.getElementById("saveBrainBtn");
    const brainStatus = document.getElementById("brainStatus");
    const brainHistory = document.getElementById("brainHistory");

    function renderBrainHistory() {
      brainHistory.innerHTML = "";
      const entries = data.brain.entries.slice().sort((a, b) => b.date - a.date);
      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "card";
        const d = new Date(e.date);
        div.innerHTML = `
          <div style="font-size:12px; opacity:0.7;">${d.toLocaleString()}</div>
          <div style="margin-top:4px; white-space:pre-wrap;">${e.text}</div>`;
        brainHistory.appendChild(div);
      });
    }

    function saveBrainEntry() {
      const text = brainText.value.trim();
      if (!text) return;
      data.brain.entries.push({ id: "brain-" + Date.now(), text, date: Date.now() });
      brainText.value = "";
      brainStatus.textContent = "Gespeichert.";
      setTimeout(() => (brainStatus.textContent = ""), 2000);
      saveData();
      renderBrainHistory();
    }

    saveBrainBtn.addEventListener("click", saveBrainEntry);

    // ---------- STATS ----------
    const statsContent = document.getElementById("statsContent");

    function renderStats() {
      const sessions = data.planner.focusSessions || [];
      if (sessions.length === 0) {
        statsContent.textContent = "Noch keine Fokus-Sessions gespeichert.";
        return;
      }
      const totalMinutes = sessions.reduce((sum, s) => sum + (s.minutes || 0), 0);
      const byTopic = {};
      sessions.forEach(s => {
        const t = s.topic || "Sonstiges";
        byTopic[t] = (byTopic[t] || 0) + (s.minutes || 0);
      });
      let html = `<div>Gesamt-Lernzeit (nur Fokus-BlÃ¶cke): <strong>${totalMinutes} Minuten</strong></div>`;
      html += `<div style="margin-top:6px;">Verteilung nach Themen:</div>`;
      html += `<ul style="padding-left:16px; margin-top:4px;">`;
      Object.keys(byTopic).forEach(t => {
        html += `<li>${t}: ${byTopic[t]} Min</li>`;
      });
      html += `</ul>`;
      statsContent.innerHTML = html;
    }

    // ---------- LERNEN ----------
    const learnSubjectsUl = document.getElementById("learnSubjects");
    const learnTopicsUl = document.getElementById("learnTopics");
    const learnContentDiv = document.getElementById("learnContent");
    let currentSubjectId = "allg-chem";
    let currentTopicId = "aufbau-materie";

    function renderLearnSubjects() {
      learnSubjectsUl.innerHTML = "";
      learnData.subjects.forEach(sub => {
        const li = document.createElement("li");
        li.className = "learn-item" + (sub.id === currentSubjectId ? " active" : "");
        li.textContent = sub.name;
        li.addEventListener("click", () => {
          currentSubjectId = sub.id;
          const firstTopic = sub.topics[0];
          if (firstTopic) currentTopicId = firstTopic.id;
          renderLearnSubjects();
          renderLearnTopics();
          renderLearnContent();
        });
        learnSubjectsUl.appendChild(li);
      });
    }

    function renderLearnTopics() {
      learnTopicsUl.innerHTML = "";
      const subject = learnData.subjects.find(s => s.id === currentSubjectId);
      if (!subject) return;
      subject.topics.forEach(t => {
        const li = document.createElement("li");
        li.className = "learn-item" + (t.id === currentTopicId ? " active" : "");
        li.textContent = t.title;
        li.addEventListener("click", () => {
          currentTopicId = t.id;
          renderLearnTopics();
          renderLearnContent();
        });
        learnTopicsUl.appendChild(li);
      });
    }

 function renderLearnContent() {
  const subject = learnData.subjects.find(s => s.id === currentSubjectId);
  if (!subject) {
    learnContentDiv.innerHTML = "";
    return;
  }

  const topic = subject.topics.find(t => t.id === currentTopicId) || subject.topics[0];
  if (!topic) {
    learnContentDiv.innerHTML = "";
    return;
  }

  const tagsHtml = (topic.tags || [])
    .map(tag => `<span class="learn-chip">${tag}</span>`)
    .join("");

  const goalsHtml = (topic.goals || [])
    .map(g => `<li>${g}</li>`)
    .join("");

  const keyHtml = (topic.keyPoints || [])
    .map(k => `<li>${k}</li>`)
    .join("");

  const formulasHtml = (topic.formulas || [])
    .map(f => `<li><code>${f}</code></li>`)
    .join("");

  const visualHtml = topic.visual
    ? `<div class="learn-section-title">Visuelle Hilfe</div>
       <div class="learn-visual">${topic.visual}</div>`
    : "";

  const detailBlocksHtml = (topic.detailBlocks || [])
    .map(block => `
      <div class="learn-section-title">${block.title}</div>
      <div style="font-size:12px; line-height:1.5; margin-bottom:6px;">
        ${block.content}
      </div>
    `)
    .join("");

  learnContentDiv.innerHTML = `
    <div class="card learn-card">
      <div class="learn-card-header">
        <div>
          <div class="learn-heading">${topic.title}</div>
          <div class="learn-subheading">${subject.name}</div>
        </div>
        <div class="learn-tagcount">
          ${(topic.tags || []).length} Stichworte
        </div>
      </div>

      <div class="learn-chiprow">${tagsHtml}</div>

      <div class="learn-section-title">Lernziele</div>
      <ul class="learn-list">${goalsHtml}</ul>

      <div class="learn-section-title">Zusammenfassung</div>
      <p style="font-size:13px; line-height:1.5; margin-top:4px;">
        ${topic.summary}
      </p>

      <div class="learn-section-title">Wichtige Punkte</div>
      <ul class="learn-list">${keyHtml}</ul>

      ${formulasHtml
        ? `<div class="learn-section-title">Wichtige Formeln (Ãœberblick)</div>
           <ul class="learn-list">${formulasHtml}</ul>`
        : ""}

      ${visualHtml}

      ${detailBlocksHtml}
    </div>
  `;
}


    // ---------- INIT ----------
    window.addEventListener("load", () => {
      loadData();
      applyTheme();
      renderNotebookSelect();
      resizeCanvas();
      renderPageList();
      redrawActivePage();
      renderDecks();
      renderExams();
      renderFormulas();
      renderTasks();
      renderBrainHistory();
      renderStats();
      renderToolInputs();
      renderLearnSubjects();
      renderLearnTopics();
      renderLearnContent();
    });
  </script>
</body>
</html>
