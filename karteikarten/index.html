<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karteikarten - Uni Hyper Notes (Phase 2)</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0d1a;
            --bg-secondary: #12151f;
            --bg-card: #1a1d2e;
            --bg-elevated: #1f2230;
            --accent: #7b8cff;
            --accent-soft: rgba(123, 140, 255, 0.16);
            --accent-hover: #8b9cff;
            --text: #f7f7ff;
            --text-muted: #a4aac5;
            --border: #2f3445;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
            background: radial-gradient(circle at top, #2a3245 0, #10121a 45%, #05060a 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-left p {
            color: var(--text-muted);
            font-size: 0.95em;
        }

        .streak-badge {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .streak-badge:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .streak-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent);
        }

        .streak-text {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .stat-change {
            font-size: 0.75em;
            color: var(--success);
            margin-top: 5px;
        }

        /* Search Bar - NEW */
        .search-container {
            margin-bottom: 25px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-bar {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 45px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 0.95em;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .filter-dropdown {
            padding: 14px 20px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-dropdown:hover {
            border-color: var(--accent);
        }

        /* View Switcher */
        .view-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 12px 24px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            border-radius: var(--radius);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-btn:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .view-btn.active {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        /* Decks Grid */
        .decks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .deck-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .deck-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .deck-cover {
            height: 120px;
            background: linear-gradient(135deg, var(--accent), #9333ea);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            position: relative;
            overflow: hidden;
        }

        .deck-cover::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent, rgba(0,0,0,0.3));
        }

        .deck-content {
            padding: 20px;
        }

        .deck-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .deck-title {
            font-size: 1.1em;
            font-weight: 600;
            flex: 1;
        }

        .deck-menu-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .deck-menu-btn:hover {
            color: var(--text);
            transform: scale(1.2);
        }

        .deck-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .deck-progress {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .deck-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            transition: width 0.5s ease;
        }

        .deck-actions {
            display: flex;
            gap: 8px;
        }

        .deck-btn {
            flex: 1;
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text);
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .deck-btn:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .deck-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .deck-btn.primary:hover {
            background: var(--accent-hover);
        }

        /* Add Deck Card */
        .add-deck-card {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 260px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-deck-card:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
            transform: translateY(-5px);
        }

        .add-deck-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .add-deck-text {
            font-size: 0.95em;
            color: var(--text-muted);
        }

        /* Deck Detail View - NEW */
        .deck-detail-view {
            display: none;
        }

        .deck-detail-view.active {
            display: block;
        }

        .deck-detail-header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
        }

        .deck-detail-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .deck-detail-title {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .deck-detail-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sort-dropdown {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9em;
            cursor: pointer;
        }

        .cards-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: all 0.2s ease;
        }

        .card-item:hover {
            border-color: var(--accent);
        }

        .card-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .card-item-front {
            flex: 1;
            font-weight: 600;
            font-size: 1.05em;
        }

        .card-item-back {
            color: var(--text-muted);
            font-size: 0.95em;
            margin-bottom: 12px;
        }

        .card-item-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .card-item-actions {
            display: flex;
            gap: 8px;
        }

        .card-item-btn {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .card-item-btn:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        /* Learning View */
        .learning-container {
            max-width: 700px;
            margin: 0 auto;
            display: none;
        }

        .learning-container.active {
            display: block;
        }

        .learning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .learning-progress {
            flex: 1;
            margin: 0 20px;
        }

        .learning-progress-text {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .learning-progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .learning-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            transition: width 0.5s ease;
        }

        .card-display {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 50px 48px;
            min-height: 380px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            transition: all 0.35s ease;
            margin-bottom: 24px;
            box-shadow: 0 2px 30px rgba(0,0,0,0.25);
        }

        .card-display.flipped {
            background: var(--bg-card);
            border-color: var(--accent);
            box-shadow: 0 4px 40px rgba(123,140,255,0.12);
        }

        .card-side {
            font-size: 1.3em;
            line-height: 1.6;
            font-weight: 500;
            text-align: left;
            width: 100%;
        }

        .card-side p { margin: 0 0 0.5em; }
        .card-side p:last-child { margin-bottom: 0; }
        .card-side strong { color: var(--accent); }
        .card-side code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }
        .card-side pre {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.8em;
            text-align: left;
            margin: 8px 0;
        }
        .card-side ul, .card-side ol {
            text-align: left;
            padding-left: 1.5em;
            margin: 6px 0;
        }
        .card-side li { margin-bottom: 4px; }
        .card-side h1, .card-side h2, .card-side h3 {
            color: var(--accent);
            margin: 0.4em 0;
        }

        .card-divider {
            width: 60px;
            height: 3px;
            background: var(--accent);
            margin: 30px auto;
            border-radius: 10px;
        }

        .show-answer-btn {
            padding: 16px 48px;
            background: var(--accent);
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
            letter-spacing: 0.02em;
            box-shadow: 0 4px 16px rgba(123, 140, 255, 0.35);
        }

        .show-answer-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(123, 140, 255, 0.5);
        }

        .show-answer-btn:active {
            transform: translateY(0);
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            display: none;
        }

        .rating-buttons.active {
            display: grid;
        }

        .rating-btn {
            padding: 18px 12px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.18s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }

        .rating-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 0.18s ease;
        }

        .rating-btn:hover::before { opacity: 1; }

        .rating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .rating-btn:active { transform: translateY(0) scale(0.97); }

        .rating-btn.again {
            background: rgba(239, 68, 68, 0.18);
            border: 2px solid rgba(239, 68, 68, 0.6);
            color: #ff8080;
        }
        .rating-btn.again:hover {
            background: rgba(239, 68, 68, 0.32);
            border-color: var(--error);
            color: #fff;
        }

        .rating-btn.hard {
            background: rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.5);
            color: #fbbf24;
        }
        .rating-btn.hard:hover {
            background: rgba(245, 158, 11, 0.28);
            border-color: var(--warning);
            color: #fff;
        }

        .rating-btn.good {
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid rgba(16, 185, 129, 0.5);
            color: #34d399;
        }
        .rating-btn.good:hover {
            background: rgba(16, 185, 129, 0.28);
            border-color: var(--success);
            color: #fff;
        }

        .rating-btn.easy {
            background: rgba(123, 140, 255, 0.15);
            border: 2px solid rgba(123, 140, 255, 0.5);
            color: #a5b4fc;
        }
        .rating-btn.easy:hover {
            background: rgba(123, 140, 255, 0.28);
            border-color: var(--accent);
            color: #fff;
        }

        .rating-label {
            font-size: 1em;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .rating-time {
            font-size: 0.72em;
            opacity: 0.75;
            font-weight: 500;
        }

        .rating-icon {
            font-size: 1.6em;
            line-height: 1;
            margin-bottom: 2px;
        }

        /* Completion Screen */
        .completion-screen {
            text-align: center;
            padding: 60px 40px;
            display: none;
        }

        .completion-screen.active {
            display: block;
        }

        .completion-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .completion-title {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .completion-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .completion-stat {
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .completion-stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .completion-stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(123, 140, 255, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            display: none;
        }

        .empty-state.active {
            display: block;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-text {
            color: var(--text-muted);
            margin-bottom: 30px;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-width: 500px;
            width: 100%;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* Gradient Picker - NEW */
        .gradient-picker {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .gradient-option {
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .gradient-option:hover {
            transform: scale(1.05);
        }

        .gradient-option.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-soft);
        }

        /* Emoji Picker - NEW */
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .emoji-option {
            font-size: 2em;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .emoji-option:hover {
            background: var(--accent-soft);
            transform: scale(1.1);
        }

        .emoji-option.selected {
            background: var(--accent-soft);
            border-color: var(--accent);
        }

        /* Floating Action Button - NEW */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(123, 140, 255, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 25px rgba(123, 140, 255, 0.6);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Toast Notification - NEW */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            transition: transform 0.3s ease;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast-message {
            flex: 1;
            font-size: 0.95em;
        }

        .toast-action {
            padding: 6px 12px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toast-action:hover {
            background: var(--accent-hover);
        }

        /* Deck Context Menu */
        .deck-menu-wrapper {
            position: relative;
        }

        .deck-context-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px;
            min-width: 160px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: none;
        }

        .deck-context-menu.open {
            display: block;
            animation: fadeIn 0.15s ease;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 14px;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.9em;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .context-menu-item:hover {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .context-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* Edit Deck Modal */
        /* (reuses existing modal styles) */


        /* Image in Cards */
        .img-upload-area {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            margin-top: 8px;
        }
        .img-upload-area:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }
        .img-upload-area.has-image {
            border-style: solid;
            border-color: var(--accent);
            padding: 8px;
        }
        .img-preview {
            max-width: 100%;
            max-height: 180px;
            border-radius: 8px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        .img-upload-hint {
            font-size: 0.82em;
            color: var(--text-muted);
            margin-top: 6px;
        }
        .img-remove-btn {
            margin-top: 8px;
            padding: 4px 12px;
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.4);
            border-radius: 6px;
            color: #ff8080;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .img-remove-btn:hover {
            background: rgba(239,68,68,0.28);
        }
        .img-url-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .img-url-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85em;
        }
        .img-url-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .img-url-btn {
            padding: 8px 14px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        /* Image display inside learning card */
        .card-image {
            max-width: 100%;
            max-height: 220px;
            border-radius: 10px;
            object-fit: contain;
            margin: 12px 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        }

        /* ===== STATISTIK VIEW ===== */
        .stats-view { display: none; }
        .stats-view.active { display: block; }

        .stats-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
        }
        .stats-section-title {
            font-size: 1.05em;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 700px) { .stats-grid-2 { grid-template-columns: 1fr; } }

        /* Heatmap */
        .heatmap-wrapper {
            overflow-x: auto;
            padding-bottom: 6px;
        }
        .heatmap {
            display: flex;
            gap: 3px;
            align-items: flex-start;
        }
        .heatmap-col {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .heatmap-cell {
            width: 13px;
            height: 13px;
            border-radius: 3px;
            background: var(--bg-secondary);
            transition: transform 0.1s;
            cursor: default;
            position: relative;
        }
        .heatmap-cell:hover { transform: scale(1.4); z-index: 10; }
        .heatmap-cell[data-level="1"] { background: rgba(123,140,255,0.25); }
        .heatmap-cell[data-level="2"] { background: rgba(123,140,255,0.5); }
        .heatmap-cell[data-level="3"] { background: rgba(123,140,255,0.75); }
        .heatmap-cell[data-level="4"] { background: rgba(123,140,255,1); }
        .heatmap-month-labels {
            display: flex;
            gap: 3px;
            margin-bottom: 4px;
            padding-left: 0;
        }
        .heatmap-month-label {
            font-size: 0.72em;
            color: var(--text-muted);
            min-width: 13px;
        }
        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.75em;
            color: var(--text-muted);
        }
        .heatmap-legend-cell {
            width: 12px; height: 12px;
            border-radius: 2px;
        }

        /* Bar Chart */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 5px;
            height: 120px;
            padding: 0 2px;
        }
        .bar-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            gap: 4px;
        }
        .bar {
            width: 100%;
            border-radius: 4px 4px 0 0;
            min-height: 3px;
            transition: height 0.4s ease;
            position: relative;
        }
        .bar-correct { background: var(--success); }
        .bar-wrong { background: var(--error); opacity: 0.6; }
        .bar-label {
            font-size: 0.65em;
            color: var(--text-muted);
            text-align: center;
            white-space: nowrap;
        }
        .bar-value {
            font-size: 0.68em;
            color: var(--text-muted);
            text-align: center;
        }

        /* Interval Distribution */
        .interval-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .interval-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .interval-label {
            font-size: 0.82em;
            color: var(--text-muted);
            min-width: 80px;
        }
        .interval-bar-track {
            flex: 1;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
        }
        .interval-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .interval-count {
            font-size: 0.82em;
            color: var(--text-muted);
            min-width: 30px;
            text-align: right;
        }

        /* Deck Stats Table */
        .deck-stats-table {
            width: 100%;
            border-collapse: collapse;
        }
        .deck-stats-table th {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-muted);
            text-align: left;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }
        .deck-stats-table td {
            font-size: 0.88em;
            padding: 10px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .deck-stats-table tr:last-child td { border-bottom: none; }
        .deck-stats-table tr:hover td { background: rgba(255,255,255,0.02); }
        .accuracy-pill {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.82em;
            font-weight: 600;
        }
        .acc-high { background: rgba(16,185,129,0.15); color: #34d399; }
        .acc-mid  { background: rgba(245,158,11,0.15); color: #fbbf24; }
        .acc-low  { background: rgba(239,68,68,0.15);  color: #ff8080; }

        /* Summary Numbers */
        .stats-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stats-summary-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        .stats-summary-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent);
            line-height: 1.1;
        }
        .stats-summary-label {
            font-size: 0.78em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Accuracy Donut (CSS only) */
        .donut-wrap {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .donut-svg { flex-shrink: 0; }
        .donut-legend { flex: 1; }
        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.88em;
        }
        .donut-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .decks-grid {
                grid-template-columns: 1fr;
            }

            .rating-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .card-display {
                padding: 30px 20px;
                min-height: 300px;
            }

            .card-side {
                font-size: 1.2em;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 1.6em;
            }

            .emoji-picker {
                grid-template-columns: repeat(5, 1fr);
            }

            .gradient-picker {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-in {
            animation: slideIn 0.4s ease;
        }

        .celebrate {
            animation: celebrate 0.5s ease;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Focus States */
        *:focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        button {
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Skeleton - NEW */
        .skeleton {
            background: linear-gradient(90deg, 
                var(--bg-card) 0%, 
                var(--bg-elevated) 50%, 
                var(--bg-card) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-deck {
            height: 260px;
            border-radius: var(--radius);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Main View -->
        <div id="mainView">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <h1>üÉè Karteikarten</h1>
                    <p>Dein Weg zum Lernerfolg ‚Äì jeden Tag ein St√ºck besser</p>
                </div>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button class="btn btn-secondary" onclick="openBulkImport()" title="Mehrere Karten auf einmal erstellen" style="padding:10px 16px; font-size:0.9em;">
                        üì• Bulk-Import
                    </button>
                    <button class="btn btn-secondary" onclick="openSettings()" title="Einstellungen" style="padding:10px 16px; font-size:0.9em;">
                        ‚öôÔ∏è
                    </button>
                    <div class="streak-badge">
                        <div>
                            <div class="streak-number" id="streakNumber">0</div>
                        </div>
                        <div class="streak-text">
                            <div>üî• Tage</div>
                            <div style="font-weight: 600;">Streak</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value" id="statDueToday">0</div>
                    <div class="stat-label">Heute f√§llig</div>
                    <div class="stat-change">‚Üó +2 vs. gestern</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statLearned">0</div>
                    <div class="stat-label">Diese Woche gelernt</div>
                    <div class="stat-change">‚ú® Stark!</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statMastered">0</div>
                    <div class="stat-label">Gemeistert</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTotalCards">0</div>
                    <div class="stat-label">Karten gesamt</div>
                </div>
            </div>

            <!-- Search Bar - NEW -->
            <div class="search-container">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input 
                        type="text" 
                        class="search-input" 
                        id="searchInput"
                        placeholder="Karten oder Decks durchsuchen..."
                        oninput="handleSearch(this.value)"
                    >
                </div>
                <select class="filter-dropdown" id="filterDropdown" onchange="handleFilter(this.value)">
                    <option value="all">Alle Karten</option>
                    <option value="due">Nur f√§llige</option>
                    <option value="new">Nur neue</option>
                    <option value="mastered">Gemeistert</option>
                </select>
            </div>

            <!-- View Switcher -->
            <div class="view-switcher">
                <button class="view-btn active" data-view="decks">
                    üìö Meine Decks
                </button>
                <button class="view-btn" data-view="due-today">
                    ‚è∞ Heute lernen
                </button>
                <button class="view-btn" data-view="browse">
                    üîç Durchsuchen
                </button>
                <button class="view-btn" data-view="stats" onclick="openStatsView()">
                    üìä Statistiken
                </button>
            </div>

            <!-- Stats View -->
            <div id="statsView" class="stats-view">

                <!-- Summary -->
                <div class="stats-summary-grid" id="statsSummaryGrid"></div>

                <!-- Heatmap + Bar Chart -->
                <div class="stats-grid-2">
                    <div class="stats-section">
                        <div class="stats-section-title">üî• Lernaktivit√§t</div>
                        <div class="heatmap-month-labels" id="heatmapMonths"></div>
                        <div class="heatmap-wrapper">
                            <div class="heatmap" id="heatmapGrid"></div>
                        </div>
                        <div class="heatmap-legend">
                            <span>Weniger</span>
                            <div class="heatmap-legend-cell" style="background:var(--bg-secondary)"></div>
                            <div class="heatmap-legend-cell" data-level="1" style="background:rgba(123,140,255,0.25)"></div>
                            <div class="heatmap-legend-cell" data-level="2" style="background:rgba(123,140,255,0.5)"></div>
                            <div class="heatmap-legend-cell" data-level="3" style="background:rgba(123,140,255,0.75)"></div>
                            <div class="heatmap-legend-cell" data-level="4" style="background:rgba(123,140,255,1)"></div>
                            <span>Mehr</span>
                        </div>
                    </div>

                    <div class="stats-section">
                        <div class="stats-section-title">üìÖ Karten letzte 14 Tage</div>
                        <div class="bar-chart" id="barChart"></div>
                    </div>
                </div>

                <!-- Interval Distribution + Accuracy Donut -->
                <div class="stats-grid-2">
                    <div class="stats-section">
                        <div class="stats-section-title">‚è±Ô∏è Intervall-Verteilung</div>
                        <div class="interval-bars" id="intervalBars"></div>
                    </div>
                    <div class="stats-section">
                        <div class="stats-section-title">üéØ Bewertungen gesamt</div>
                        <div class="donut-wrap">
                            <svg class="donut-svg" width="100" height="100" viewBox="0 0 100 100" id="donutSvg"></svg>
                            <div class="donut-legend" id="donutLegend"></div>
                        </div>
                    </div>
                </div>

                <!-- Per-Deck Table -->
                <div class="stats-section">
                    <div class="stats-section-title">üìö Statistiken pro Deck</div>
                    <div style="overflow-x:auto;">
                        <table class="deck-stats-table" id="deckStatsTable">
                            <thead>
                                <tr>
                                    <th>Deck</th>
                                    <th>Karten</th>
                                    <th>Gemeistert</th>
                                    <th>F√§llig</th>
                                    <th>Wiederholungen</th>
                                    <th>Genauigkeit</th>
                                </tr>
                            </thead>
                            <tbody id="deckStatsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Decks Grid -->
            <div class="decks-grid" id="decksGrid">
                <!-- Add Deck Card -->
                <div class="add-deck-card" onclick="openNewDeckModal()">
                    <div class="add-deck-icon">‚ûï</div>
                    <div class="add-deck-text">Neues Deck erstellen</div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">üì¶</div>
                <div class="empty-title">Noch keine Karteikarten</div>
                <div class="empty-text">Erstelle dein erstes Deck und starte mit dem Lernen!</div>
                <button class="btn btn-primary" onclick="openNewDeckModal()">
                    ‚ûï Deck erstellen
                </button>
            </div>
        </div>

        <!-- Deck Detail View - NEW -->
        <div id="deckDetailView" class="deck-detail-view">
            <div class="deck-detail-header">
                <div class="deck-detail-top">
                    <button class="back-btn" onclick="closeDeckDetail()">
                        ‚Üê Zur√ºck
                    </button>
                </div>
                <h2 class="deck-detail-title" id="detailDeckName">Deck Name</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;" id="detailDeckDescription"></p>
                
                <div class="deck-detail-actions">
                    <button class="btn btn-primary" onclick="startLearningFromDetail()">
                        üéØ Lernen (<span id="detailDueCount">0</span>)
                    </button>
                    <button class="btn btn-secondary" onclick="startReviewAllFromDetail()" title="Alle Karten nochmal durchgehen, egal ob schon heute gemacht">
                        üîÑ Alle wiederholen
                    </button>
                    <button class="btn btn-secondary" onclick="openNewCardModal(currentDetailDeckId)">
                        ‚ûï Karte hinzuf√ºgen
                    </button>
                    <select class="sort-dropdown" onchange="sortCards(this.value)">
                        <option value="created">Sortieren: Erstellung</option>
                        <option value="due">Sortieren: F√§lligkeit</option>
                        <option value="difficulty">Sortieren: Schwierigkeit</option>
                    </select>
                </div>
            </div>

            <div class="cards-list" id="cardsList">
                <!-- Cards will be rendered here -->
            </div>
        </div>

        <!-- Learning View -->
        <div id="learningView" class="learning-container">
            <div class="learning-header">
                <button class="btn btn-secondary" onclick="exitLearning()">
                    ‚Üê Zur√ºck
                </button>
                <div class="learning-progress">
                    <div class="learning-progress-text">
                        <span id="progressText">0 von 0 Karten</span>
                    </div>
                    <div class="learning-progress-bar">
                        <div class="learning-progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="card-display" id="cardDisplay">
                <div class="card-side" id="cardFront"></div>
                <div class="card-divider" id="cardDivider" style="display: none;"></div>
                <div class="card-side" id="cardBack" style="display: none;"></div>
            </div>

            <button class="show-answer-btn" id="showAnswerBtn" onclick="showAnswer()">
                Antwort anzeigen
            </button>

            <p id="keyHint" style="display:none; text-align:center; font-size:0.78em; color:var(--text-muted); margin-bottom:10px;">
                Tastatur: <kbd style="background:var(--bg-elevated);border:1px solid var(--border);padding:2px 6px;border-radius:4px;">1</kbd> Nochmal &nbsp;
                <kbd style="background:var(--bg-elevated);border:1px solid var(--border);padding:2px 6px;border-radius:4px;">2</kbd> Schwer &nbsp;
                <kbd style="background:var(--bg-elevated);border:1px solid var(--border);padding:2px 6px;border-radius:4px;">3</kbd> Gut &nbsp;
                <kbd style="background:var(--bg-elevated);border:1px solid var(--border);padding:2px 6px;border-radius:4px;">4</kbd> Leicht
            </p>
            <div class="rating-buttons" id="ratingButtons">
                <button class="rating-btn again" onclick="rateCard(1)">
                    <div class="rating-icon">‚úï</div>
                    <div class="rating-label">Nochmal</div>
                    <div class="rating-time">&lt; 1 Min.</div>
                </button>
                <button class="rating-btn hard" onclick="rateCard(2)">
                    <div class="rating-icon">„Äú</div>
                    <div class="rating-label">Schwer</div>
                    <div class="rating-time">10 Min.</div>
                </button>
                <button class="rating-btn good" onclick="rateCard(3)">
                    <div class="rating-icon">‚úì</div>
                    <div class="rating-label">Gut</div>
                    <div class="rating-time">1 Tag</div>
                </button>
                <button class="rating-btn easy" onclick="rateCard(4)">
                    <div class="rating-icon">‚ö°</div>
                    <div class="rating-label">Leicht</div>
                    <div class="rating-time">4 Tage</div>
                </button>
            </div>

            <!-- Completion Screen -->
            <div class="completion-screen" id="completionScreen">
                <div class="completion-icon">üéâ</div>
                <div class="completion-title">Gro√üartig gemacht!</div>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Du hast alle f√§lligen Karten geschafft
                </p>
                <div class="completion-stats">
                    <div class="completion-stat">
                        <div class="completion-stat-value" id="completionCards">0</div>
                        <div class="completion-stat-label">Karten</div>
                    </div>
                    <div class="completion-stat">
                        <div class="completion-stat-value" id="completionTime">0m</div>
                        <div class="completion-stat-label">Dauer</div>
                    </div>
                    <div class="completion-stat">
                        <div class="completion-stat-value" id="completionAccuracy">0%</div>
                        <div class="completion-stat-label">Genauigkeit</div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="startLearning(currentDeckId, true)" style="margin-right: 10px;">
                    üîÑ Nochmal
                </button>
                <button class="btn btn-primary" onclick="exitLearning()">
                    ‚Üê Zur√ºck zur √úbersicht
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button - NEW -->
    <button class="fab" onclick="openQuickAdd()" title="Schnell Karte erstellen (Ctrl+N)">
        ‚ûï
    </button>

    <!-- Toast Notification - NEW -->
    <div class="toast" id="toast">
        <div class="toast-message" id="toastMessage"></div>
        <button class="toast-action" id="toastAction" style="display: none;"></button>
    </div>

    <!-- New Deck Modal -->
    <div class="modal" id="newDeckModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Neues Deck erstellen</h2>
                <button class="modal-close" onclick="closeModal('newDeckModal')">√ó</button>
            </div>
            <form onsubmit="createDeck(event)">
                <div class="form-group">
                    <label class="form-label">Deck-Name *</label>
                    <input type="text" class="form-input" id="deckName" placeholder="z.B. Biochemie Klausur" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" id="deckDescription" placeholder="Optionale Beschreibung..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Icon w√§hlen</label>
                    <div class="emoji-picker" id="emojiPicker">
                        <div class="emoji-option" onclick="selectEmoji('üìö')">üìö</div>
                        <div class="emoji-option" onclick="selectEmoji('üß¨')">üß¨</div>
                        <div class="emoji-option" onclick="selectEmoji('üî¨')">üî¨</div>
                        <div class="emoji-option" onclick="selectEmoji('‚öóÔ∏è')">‚öóÔ∏è</div>
                        <div class="emoji-option" onclick="selectEmoji('üéì')">üéì</div>
                        <div class="emoji-option" onclick="selectEmoji('üí°')">üí°</div>
                        <div class="emoji-option" onclick="selectEmoji('üéØ')">üéØ</div>
                        <div class="emoji-option" onclick="selectEmoji('üöÄ')">üöÄ</div>
                        <div class="emoji-option" onclick="selectEmoji('‚≠ê')">‚≠ê</div>
                        <div class="emoji-option" onclick="selectEmoji('üèÜ')">üèÜ</div>
                        <div class="emoji-option" onclick="selectEmoji('üí™')">üí™</div>
                        <div class="emoji-option" onclick="selectEmoji('üî•')">üî•</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Farbe w√§hlen</label>
                    <div class="gradient-picker" id="gradientPicker">
                        <div class="gradient-option" style="background: linear-gradient(135deg, #7b8cff, #9333ea)" onclick="selectGradient('linear-gradient(135deg, #7b8cff, #9333ea)')"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #06b6d4, #3b82f6)" onclick="selectGradient('linear-gradient(135deg, #06b6d4, #3b82f6)')"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #10b981, #059669)" onclick="selectGradient('linear-gradient(135deg, #10b981, #059669)')"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #f59e0b, #dc2626)" onclick="selectGradient('linear-gradient(135deg, #f59e0b, #dc2626)')"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #ec4899, #8b5cf6)" onclick="selectGradient('linear-gradient(135deg, #ec4899, #8b5cf6)')"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #6366f1, #8b5cf6)" onclick="selectGradient('linear-gradient(135deg, #6366f1, #8b5cf6)')"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newDeckModal')">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Deck erstellen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Card Modal -->
    <div class="modal" id="newCardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Neue Karte hinzuf√ºgen</h2>
                <button class="modal-close" onclick="closeModal('newCardModal')">√ó</button>
            </div>
            <form onsubmit="createCard(event)">
                <div class="form-group" id="deckSelectGroup" style="display: none;">
                    <label class="form-label">Deck *</label>
                    <select class="form-select" id="cardDeckSelect">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Vorderseite (Frage) *</label>
                    <textarea class="form-textarea" id="cardFrontInput" placeholder="Was m√∂chtest du lernen?" required></textarea>
                    <div class="img-upload-area" id="frontImgArea" onclick="document.getElementById('frontImgFile').click()">
                        <div id="frontImgPlaceholder">üñºÔ∏è Bild hinzuf√ºgen (optional)<br><span class="img-upload-hint">Klicken oder URL eingeben</span></div>
                        <img id="frontImgPreview" class="img-preview" style="display:none">
                        <button type="button" class="img-remove-btn" id="frontImgRemove" style="display:none" onclick="removeCardImage('front', event)">‚úï Bild entfernen</button>
                    </div>
                    <div class="img-url-row">
                        <input type="url" class="img-url-input" id="frontImgUrl" placeholder="Oder Bild-URL einf√ºgen...">
                        <button type="button" class="img-url-btn" onclick="loadImageFromUrl('front')">‚Üµ</button>
                    </div>
                    <input type="file" id="frontImgFile" accept="image/*" style="display:none" onchange="handleImageUpload('front', event)">
                </div>
                <div class="form-group">
                    <label class="form-label">R√ºckseite (Antwort) *</label>
                    <textarea class="form-textarea" id="cardBackInput" placeholder="Die Antwort..." required></textarea>
                    <div class="img-upload-area" id="backImgArea" onclick="document.getElementById('backImgFile').click()">
                        <div id="backImgPlaceholder">üñºÔ∏è Bild hinzuf√ºgen (optional)<br><span class="img-upload-hint">Klicken oder URL eingeben</span></div>
                        <img id="backImgPreview" class="img-preview" style="display:none">
                        <button type="button" class="img-remove-btn" id="backImgRemove" style="display:none" onclick="removeCardImage('back', event)">‚úï Bild entfernen</button>
                    </div>
                    <div class="img-url-row">
                        <input type="url" class="img-url-input" id="backImgUrl" placeholder="Oder Bild-URL einf√ºgen...">
                        <button type="button" class="img-url-btn" onclick="loadImageFromUrl('back')">‚Üµ</button>
                    </div>
                    <input type="file" id="backImgFile" accept="image/*" style="display:none" onchange="handleImageUpload('back', event)">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newCardModal')">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Karte erstellen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Card Modal - NEW -->
    <div class="modal" id="editCardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Karte bearbeiten</h2>
                <button class="modal-close" onclick="closeModal('editCardModal')">√ó</button>
            </div>
            <form onsubmit="updateCard(event)">
                <div class="form-group">
                    <label class="form-label">Vorderseite (Frage) *</label>
                    <textarea class="form-textarea" id="editCardFront" required></textarea>
                    <div class="img-upload-area" id="editFrontImgArea" onclick="document.getElementById('editFrontImgFile').click()">
                        <div id="editFrontImgPlaceholder">üñºÔ∏è Bild hinzuf√ºgen (optional)</div>
                        <img id="editFrontImgPreview" class="img-preview" style="display:none">
                        <button type="button" class="img-remove-btn" id="editFrontImgRemove" style="display:none" onclick="removeCardImage('editFront', event)">‚úï Bild entfernen</button>
                    </div>
                    <div class="img-url-row">
                        <input type="url" class="img-url-input" id="editFrontImgUrl" placeholder="Oder Bild-URL einf√ºgen...">
                        <button type="button" class="img-url-btn" onclick="loadImageFromUrl('editFront')">‚Üµ</button>
                    </div>
                    <input type="file" id="editFrontImgFile" accept="image/*" style="display:none" onchange="handleImageUpload('editFront', event)">
                </div>
                <div class="form-group">
                    <label class="form-label">R√ºckseite (Antwort) *</label>
                    <textarea class="form-textarea" id="editCardBack" required></textarea>
                    <div class="img-upload-area" id="editBackImgArea" onclick="document.getElementById('editBackImgFile').click()">
                        <div id="editBackImgPlaceholder">üñºÔ∏è Bild hinzuf√ºgen (optional)</div>
                        <img id="editBackImgPreview" class="img-preview" style="display:none">
                        <button type="button" class="img-remove-btn" id="editBackImgRemove" style="display:none" onclick="removeCardImage('editBack', event)">‚úï Bild entfernen</button>
                    </div>
                    <div class="img-url-row">
                        <input type="url" class="img-url-input" id="editBackImgUrl" placeholder="Oder Bild-URL einf√ºgen...">
                        <button type="button" class="img-url-btn" onclick="loadImageFromUrl('editBack')">‚Üµ</button>
                    </div>
                    <input type="file" id="editBackImgFile" accept="image/*" style="display:none" onchange="handleImageUpload('editBack', event)">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCardModal')">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Deck Modal -->
    <div class="modal" id="editDeckModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Deck bearbeiten</h2>
                <button class="modal-close" onclick="closeModal('editDeckModal')">√ó</button>
            </div>
            <form onsubmit="updateDeck(event)">
                <div class="form-group">
                    <label class="form-label">Deck-Name *</label>
                    <input type="text" class="form-input" id="editDeckName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <input type="text" class="form-input" id="editDeckDescription" placeholder="Optional...">
                </div>
                <div class="form-group">
                    <label class="form-label">Emoji</label>
                    <div class="emoji-picker" id="editEmojiPicker">
                        <div class="emoji-option" onclick="selectEditEmoji('üìö', event)">üìö</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üî¨', event)">üî¨</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üß™', event)">üß™</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üß†', event)">üß†</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üìê', event)">üìê</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üåç', event)">üåç</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üíä', event)">üíä</div>
                        <div class="emoji-option" onclick="selectEditEmoji('‚ö°', event)">‚ö°</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üéØ', event)">üéØ</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üíª', event)">üíª</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üèõÔ∏è', event)">üèõÔ∏è</div>
                        <div class="emoji-option" onclick="selectEditEmoji('üéµ', event)">üéµ</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Farbe</label>
                    <div class="gradient-picker" id="editGradientPicker">
                        <div class="gradient-option" style="background: linear-gradient(135deg, #7b8cff, #9333ea)" onclick="selectEditGradient('linear-gradient(135deg, #7b8cff, #9333ea)', event)"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #10b981, #0891b2)" onclick="selectEditGradient('linear-gradient(135deg, #10b981, #0891b2)', event)"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #f59e0b, #ef4444)" onclick="selectEditGradient('linear-gradient(135deg, #f59e0b, #ef4444)', event)"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #ec4899, #8b5cf6)" onclick="selectEditGradient('linear-gradient(135deg, #ec4899, #8b5cf6)', event)"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #06b6d4, #3b82f6)" onclick="selectEditGradient('linear-gradient(135deg, #06b6d4, #3b82f6)', event)"></div>
                        <div class="gradient-option" style="background: linear-gradient(135deg, #84cc16, #10b981)" onclick="selectEditGradient('linear-gradient(135deg, #84cc16, #10b981)', event)"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editDeckModal')">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Bulk Import Modal -->
    <div class="modal" id="bulkImportModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üì• Bulk-Import</h2>
                <button class="modal-close" onclick="closeModal('bulkImportModal')">√ó</button>
            </div>
            <div class="form-group" id="bulkDeckSelectGroup">
                <label class="form-label">Deck *</label>
                <select class="form-select" id="bulkDeckSelect">
                    <option value="">Deck w√§hlen...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Karten eingeben</label>
                <p style="font-size:0.82em; color: var(--text-muted); margin-bottom: 8px;">
                    Ein Paar pro Zeile: <code style="background:var(--bg-card); padding:2px 6px; border-radius:4px;">Frage | Antwort</code> &nbsp;oder&nbsp; <code style="background:var(--bg-card); padding:2px 6px; border-radius:4px;">Frage ; Antwort</code>
                </p>
                <textarea class="form-textarea" id="bulkInput" placeholder="Was ist Photosynthese? | Umwandlung von Licht in chemische Energie&#10;Wie viele Planeten? | 8 Planeten im Sonnensystem&#10;Was ist DNA? | Desoxyribonukleins√§ure ‚Äì Tr√§ger der Erbinformation" style="min-height:200px; font-family: monospace; font-size: 0.9em;"></textarea>
            </div>
            <div id="bulkPreview" style="display:none; margin-bottom:16px;">
                <div style="font-size:0.85em; color:var(--text-muted); margin-bottom:8px;" id="bulkPreviewCount"></div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('bulkImportModal')">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkImport()">üì• Importieren</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Einstellungen</h2>
                <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Neue Karten pro Session</label>
                <input type="number" class="form-input" id="settingNewCards" min="1" max="100" value="20">
                <p style="font-size:0.8em; color:var(--text-muted); margin-top:4px;">Wie viele neue (noch nie gelernte) Karten pro Lernsession angezeigt werden</p>
            </div>
            <div class="form-group">
                <label class="form-label">Max. Wiederholungen pro Session</label>
                <input type="number" class="form-input" id="settingMaxReviews" min="1" max="500" value="100">
                <p style="font-size:0.8em; color:var(--text-muted); margin-top:4px;">Maximale Gesamtzahl an Karten pro Lernsession</p>
            </div>
            <div class="form-group">
                <label class="form-label">Markdown-Rendering</label>
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-top:6px;">
                    <input type="checkbox" id="settingMarkdown" style="width:18px; height:18px; cursor:pointer;" checked>
                    <span style="font-size:0.95em;">Markdown in Karten rendern (Fett, Kursiv, Code, Listen...)</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label" style="margin-bottom:12px;">Daten</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button type="button" class="btn btn-secondary" onclick="exportData()">‚¨áÔ∏è JSON-Export</button>
                    <button type="button" class="btn btn-secondary" onclick="importDataFromFile()">‚¨ÜÔ∏è JSON-Import</button>
                    <button type="button" class="btn btn-secondary" onclick="exportCSV()">üìä CSV-Export</button>
                    <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('settingsModal')">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // Data Structure
        let appData = {
            decks: [],
            settings: {
                streak: 0,
                lastLearned: null
            }
        };

        let currentDeckId = null;
        let currentCardIndex = 0;
        let currentDetailDeckId = null;
        let currentEditCardId = null;
        let selectedEmoji = 'üìö';
        let selectedGradient = 'linear-gradient(135deg, #7b8cff, #9333ea)';
        let currentSession = {
            cards: [],
            startTime: null,
            correct: 0,
            total: 0
        };

        // Undo Stack - NEW
        let undoStack = [];

        // Initialize
        function init() {
            loadData();
            ensureSettings();
            renderDecks();
            updateStats();
            updateStreak();
        }

        // Data Management
        function loadData() {
            let saved = null;
            try { saved = localStorage.getItem('uniHyperNotesCardsPhase2'); } catch(e) {}
            if (saved) {
                try { appData = JSON.parse(saved); } catch(e) { saved = null; }
            } else {
                // Demo Data
                appData = {
                    decks: [
                        {
                            id: Date.now().toString(),
                            name: 'Demo-Deck',
                            description: 'Probiere das Lernsystem aus!',
                            icon: 'üéØ',
                            color: 'linear-gradient(135deg, #7b8cff, #9333ea)',
                            cards: [
                                {
                                    id: 1,
                                    front: 'Was ist Spaced Repetition?',
                                    back: 'Eine Lernmethode, bei der Informationen in zunehmend gr√∂√üeren Zeitabst√§nden wiederholt werden.',
                                    reviews: [],
                                    nextReview: null,
                                    easeFactor: 2.5,
                                    interval: 0
                                },
                                {
                                    id: 2,
                                    front: 'Wie viele Aminos√§uren gibt es?',
                                    back: '20 proteinogene Aminos√§uren',
                                    reviews: [],
                                    nextReview: null,
                                    easeFactor: 2.5,
                                    interval: 0
                                },
                                {
                                    id: 3,
                                    front: 'Was bedeutet "Uni Hyper Notes"?',
                                    back: 'Eine moderne Lern-App f√ºr Studierende mit Fokus auf Effizienz und Motivation!',
                                    reviews: [],
                                    nextReview: null,
                                    easeFactor: 2.5,
                                    interval: 0
                                }
                            ],
                            created: Date.now()
                        }
                    ],
                    settings: {
                        streak: 0,
                        lastLearned: null,
                        newCardsPerSession: 20,
                        maxReviewsPerSession: 100,
                        markdownEnabled: true
                    }
                };
                saveData();
            }
        }

        function ensureSettings() {
            if (!appData.settings.newCardsPerSession) appData.settings.newCardsPerSession = 20;
            if (!appData.settings.maxReviewsPerSession) appData.settings.maxReviewsPerSession = 100;
            if (appData.settings.markdownEnabled === undefined) appData.settings.markdownEnabled = true;
        }

        function saveData() {
            try {
                localStorage.setItem('uniHyperNotesCardsPhase2', JSON.stringify(appData));
            } catch (e) {
                console.warn('localStorage nicht verf√ºgbar ‚Äì Daten werden nicht gespeichert:', e);
                showToast('‚ö†Ô∏è Daten k√∂nnen nicht gespeichert werden (Browser blockiert localStorage)', 'warning');
            }
        }

        // Render Decks
        function renderDecks() {
            const grid = document.getElementById('decksGrid');
            const addCard = grid.querySelector('.add-deck-card');
            
            // Clear except add card
            while (grid.children.length > 1) {
                grid.removeChild(grid.lastChild);
            }

            if (appData.decks.length === 0) {
                document.getElementById('emptyState').classList.add('active');
                return;
            } else {
                document.getElementById('emptyState').classList.remove('active');
            }

            appData.decks.forEach(deck => {
                const dueCards = getDueCards(deck);
                const masteredCards = deck.cards.filter(c => c.interval >= 7).length;
                const progress = deck.cards.length > 0 ? (masteredCards / deck.cards.length) * 100 : 0;

                const deckCard = document.createElement('div');
                deckCard.className = 'deck-card animate-in';
                deckCard.innerHTML = `
                    <div class="deck-cover" style="background: ${deck.color || 'linear-gradient(135deg, var(--accent), #9333ea)'}">
                        <div style="z-index: 1; font-size: 3em;">${deck.icon || 'üìö'}</div>
                    </div>
                    <div class="deck-content">
                        <div class="deck-header">
                            <div class="deck-title" onclick="openDeckDetail('${deck.id}')">${deck.name}</div>
                            <div class="deck-menu-wrapper">
                                <button class="deck-menu-btn" onclick="event.stopPropagation(); toggleDeckMenu('menu-${deck.id}')">‚ãØ</button>
                                <div class="deck-context-menu" id="menu-${deck.id}">
                                    <button class="context-menu-item" onclick="openEditDeckModal('${deck.id}')">‚úèÔ∏è Deck bearbeiten</button>
                                    <button class="context-menu-item" onclick="openDeckDetail('${deck.id}')">üìã Karten anzeigen</button>
                                    <div class="context-menu-separator"></div>
                                    <button class="context-menu-item danger" onclick="deleteDeck('${deck.id}')">üóëÔ∏è Deck l√∂schen</button>
                                </div>
                            </div>
                        </div>
                        <div class="deck-stats">
                            <span>${deck.cards.length} Karten</span>
                            <span>‚Ä¢</span>
                            <span>${dueCards.length} f√§llig</span>
                        </div>
                        <div class="deck-progress">
                            <div class="deck-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div class="deck-actions">
                            <button class="deck-btn primary" onclick="event.stopPropagation(); startLearning('${deck.id}')">
                                ${dueCards.length > 0 ? `üéØ Lernen (${dueCards.length})` : '‚úÖ Alles erledigt'}
                            </button>
                            <button class="deck-btn" onclick="event.stopPropagation(); startLearning('${deck.id}', true)" title="Alle Karten wiederholen">
                                üîÑ
                            </button>
                            <button class="deck-btn" onclick="event.stopPropagation(); openNewCardModal('${deck.id}')">
                                +
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(deckCard);
            });
        }

        // Get Due Cards
        function getDueCards(deck) {
            const now = Date.now();
            return deck.cards.filter(card => {
                if (!card.nextReview) return true;
                return card.nextReview <= now;
            });
        }

        // Update Stats
        function updateStats() {
            const totalCards = appData.decks.reduce((sum, deck) => sum + deck.cards.length, 0);
            const dueToday = appData.decks.reduce((sum, deck) => sum + getDueCards(deck).length, 0);
            const mastered = appData.decks.reduce((sum, deck) =>
                sum + deck.cards.filter(c => c.interval >= 7).length, 0);

            // Week count: all reviews in last 7 days
            const weekAgo = Date.now() - 7 * 86400000;
            const weekCount = appData.decks.reduce((sum, deck) =>
                sum + deck.cards.reduce((s, c) =>
                    s + (c.reviews || []).filter(r => r.date >= weekAgo).length, 0), 0);

            document.getElementById('statTotalCards').textContent = totalCards;
            document.getElementById('statDueToday').textContent = dueToday;
            document.getElementById('statMastered').textContent = mastered;
            document.getElementById('statLearned').textContent = weekCount;
        }

        // Update Streak
        function updateStreak() {
            const today = new Date().toDateString();
            const lastLearned = appData.settings.lastLearned;
            
            if (lastLearned === today) {
                // Already learned today
            } else if (lastLearned) {
                const lastDate = new Date(lastLearned);
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastDate.toDateString() !== yesterday.toDateString()) {
                    appData.settings.streak = 0;
                }
            }
            
            document.getElementById('streakNumber').textContent = appData.settings.streak;
        }

        // Emoji & Gradient Selection - NEW
        function selectEmoji(emoji) {
            selectedEmoji = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function selectGradient(gradient) {
            selectedGradient = gradient;
            document.querySelectorAll('.gradient-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // Modals
        function openNewDeckModal() {
            // Reset selections
            selectedEmoji = 'üìö';
            selectedGradient = 'linear-gradient(135deg, #7b8cff, #9333ea)';
            document.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.gradient-option').forEach(el => el.classList.remove('selected'));
            document.querySelector('.emoji-option').classList.add('selected');
            document.querySelector('.gradient-option').classList.add('selected');
            
            document.getElementById('newDeckModal').classList.add('active');
            document.getElementById('deckName').focus();
        }

        function openNewCardModal(deckId) {
            currentDeckId = deckId;
            
            // If opening from FAB (no deckId), show deck selector
            if (!deckId) {
                const selectGroup = document.getElementById('deckSelectGroup');
                const select = document.getElementById('cardDeckSelect');
                selectGroup.style.display = 'block';
                select.disabled = false;
                select.required = true;
                
                // Populate deck options
                select.innerHTML = '<option value="">Deck w√§hlen...</option>';
                appData.decks.forEach(deck => {
                    const option = document.createElement('option');
                    option.value = deck.id;
                    option.textContent = `${deck.icon} ${deck.name}`;
                    select.appendChild(option);
                });
            } else {
                document.getElementById('deckSelectGroup').style.display = 'none';
            const sel = document.getElementById('cardDeckSelect');
            sel.disabled = true;
            sel.required = false;
            }
            
            document.getElementById('newCardModal').classList.add('active');
            document.getElementById('cardFrontInput').focus();
        }

        function openQuickAdd() {
            openNewCardModal();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.getElementById(modalId).querySelector('form')?.reset();
            // Reset image previews
            if (modalId === 'newCardModal') {
                resetImagePreview('front');
                resetImagePreview('back');
                pendingImages = { front: null, back: null };
            } else if (modalId === 'editCardModal') {
                resetImagePreview('editFront');
                resetImagePreview('editBack');
            }
        }

        // Create Deck
        function createDeck(e) {
            e.preventDefault();
            
            const name = document.getElementById('deckName').value;
            const description = document.getElementById('deckDescription').value;

            const newDeck = {
                id: Date.now().toString(),
                name,
                description,
                icon: selectedEmoji,
                color: selectedGradient,
                cards: [],
                created: Date.now()
            };

            appData.decks.push(newDeck);
            saveData();
            renderDecks();
            updateStats();
            closeModal('newDeckModal');
            
            showToast(`Deck "${name}" erstellt! üéâ`, 'success');
        }

        // Create Card
        function createCard(e) {
            e.preventDefault();
            
            const front = document.getElementById('cardFrontInput').value;
            const back = document.getElementById('cardBackInput').value;
            
            // Get deck ID (either from currentDeckId or from select)
            let deckId = currentDeckId;
            if (!deckId) {
                deckId = document.getElementById('cardDeckSelect').value;
            }
            
            if (!deckId) {
                showToast('Bitte w√§hle ein Deck!', 'error');
                return;
            }
            
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;

            const newCard = {
                id: Date.now(),
                front,
                back,
                frontImage: pendingImages.front || null,
                backImage: pendingImages.back || null,
                reviews: [],
                nextReview: null,
                easeFactor: 2.5,
                interval: 0,
                created: Date.now()
            };
            pendingImages = { front: null, back: null };

            deck.cards.push(newCard);
            saveData();
            renderDecks();
            updateStats();
            
            // If in detail view, refresh it
            if (currentDetailDeckId) {
                renderDeckDetail(currentDetailDeckId);
            }
            
            closeModal('newCardModal');
            showToast('Karte erstellt! ‚ú®', 'success');
        }

        // Delete Deck - NEW with Undo
        function deleteDeck(deckId) {
            if (!confirm('Deck wirklich l√∂schen?')) return;
            
            const deckIndex = appData.decks.findIndex(d => d.id === deckId);
            if (deckIndex === -1) return;
            
            const deletedDeck = appData.decks[deckIndex];
            appData.decks.splice(deckIndex, 1);
            saveData();
            renderDecks();
            updateStats();
            
            // Show toast with undo
            showToast(
                `Deck "${deletedDeck.name}" gel√∂scht`,
                'warning',
                'R√ºckg√§ngig',
                () => {
                    appData.decks.splice(deckIndex, 0, deletedDeck);
                    saveData();
                    renderDecks();
                    updateStats();
                    showToast('Wiederhergestellt! üéâ', 'success');
                }
            );
        }

        // Toast Notification - NEW
        function showToast(message, type = 'success', actionText = null, actionCallback = null) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastAction = document.getElementById('toastAction');
            
            toast.className = 'toast ' + type;
            toastMessage.textContent = message;
            
            if (actionText && actionCallback) {
                toastAction.textContent = actionText;
                toastAction.style.display = 'block';
                toastAction.onclick = () => {
                    actionCallback();
                    toast.classList.remove('show');
                };
            } else {
                toastAction.style.display = 'none';
            }
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Deck Detail View - NEW
        function openDeckDetail(deckId) {
            currentDetailDeckId = deckId;
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('deckDetailView').classList.add('active');
            renderDeckDetail(deckId);
        }

        function closeDeckDetail() {
            currentDetailDeckId = null;
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('deckDetailView').classList.remove('active');
        }

        function renderDeckDetail(deckId) {
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;
            
            const dueCards = getDueCards(deck);
            
            document.getElementById('detailDeckName').textContent = deck.name;
            document.getElementById('detailDeckDescription').textContent = deck.description || '';
            document.getElementById('detailDueCount').textContent = dueCards.length;
            
            renderCardsList(deck.cards, deckId);
        }

        function renderCardsList(cards, deckId) {
            const list = document.getElementById('cardsList');
            list.innerHTML = '';
            
            if (cards.length === 0) {
                list.innerHTML = '<div class="empty-state active"><div class="empty-icon">üìù</div><div class="empty-title">Noch keine Karten</div><div class="empty-text">Erstelle deine erste Karte!</div></div>';
                return;
            }
            
            cards.forEach(card => {
                const isDue = !card.nextReview || card.nextReview <= Date.now();
                const status = card.interval >= 7 ? 'Gemeistert' : (isDue ? 'F√§llig' : 'Geplant');
                
                const cardItem = document.createElement('div');
                cardItem.className = 'card-item fade-in';
                cardItem.innerHTML = `
                    <div class="card-item-header">
                        <div class="card-item-front">${card.front}</div>
                    </div>
                    <div class="card-item-back">${card.back}</div>
                    <div class="card-item-meta">
                        <span>Status: ${status}</span>
                        <span>‚Ä¢</span>
                        <span>Intervall: ${card.interval} Tage</span>
                    </div>
                    <div class="card-item-actions" style="margin-top: 12px;">
                        <button class="card-item-btn" onclick="editCard('${deckId}', ${card.id})">
                            ‚úèÔ∏è Bearbeiten
                        </button>
                        <button class="card-item-btn" onclick="deleteCard('${deckId}', ${card.id})">
                            üóëÔ∏è L√∂schen
                        </button>
                    </div>
                `;
                list.appendChild(cardItem);
            });
        }

        // Edit Card - NEW
        function editCard(deckId, cardId) {
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;
            
            const card = deck.cards.find(c => c.id === cardId);
            if (!card) return;
            
            currentDeckId = deckId;
            currentEditCardId = cardId;
            
            document.getElementById('editCardFront').value = card.front;
            document.getElementById('editCardBack').value = card.back;
            // Load existing images
            pendingEditImages = {};
            if (card.frontImage) setImagePreview('editFront', card.frontImage);
            else resetImagePreview('editFront');
            if (card.backImage) setImagePreview('editBack', card.backImage);
            else resetImagePreview('editBack');
            document.getElementById('editCardModal').classList.add('active');
        }

        function updateCard(e) {
            e.preventDefault();
            
            const deck = appData.decks.find(d => d.id === currentDeckId);
            if (!deck) return;
            
            const card = deck.cards.find(c => c.id === currentEditCardId);
            if (!card) return;
            
            card.front = document.getElementById('editCardFront').value;
            card.back = document.getElementById('editCardBack').value;
            card.modified = Date.now();
            if (pendingEditImages.front !== undefined) card.frontImage = pendingEditImages.front;
            if (pendingEditImages.back !== undefined) card.backImage = pendingEditImages.back;
            pendingEditImages = {};
            
            saveData();
            renderDeckDetail(currentDeckId);
            closeModal('editCardModal');
            showToast('Karte aktualisiert! ‚úÖ', 'success');
        }

        // Delete Card - NEW
        function deleteCard(deckId, cardId) {
            if (!confirm('Karte wirklich l√∂schen?')) return;
            
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;
            
            const cardIndex = deck.cards.findIndex(c => c.id === cardId);
            if (cardIndex === -1) return;
            
            const deletedCard = deck.cards[cardIndex];
            deck.cards.splice(cardIndex, 1);
            saveData();
            renderDeckDetail(deckId);
            updateStats();
            
            showToast(
                'Karte gel√∂scht',
                'warning',
                'R√ºckg√§ngig',
                () => {
                    deck.cards.splice(cardIndex, 0, deletedCard);
                    saveData();
                    renderDeckDetail(deckId);
                    updateStats();
                    showToast('Wiederhergestellt! üéâ', 'success');
                }
            );
        }

        // Sort Cards - NEW
        function sortCards(sortBy) {
            const deck = appData.decks.find(d => d.id === currentDetailDeckId);
            if (!deck) return;
            
            let sorted = [...deck.cards];
            
            switch(sortBy) {
                case 'created':
                    sorted.sort((a, b) => b.created - a.created);
                    break;
                case 'due':
                    sorted.sort((a, b) => {
                        const aDue = a.nextReview || 0;
                        const bDue = b.nextReview || 0;
                        return aDue - bDue;
                    });
                    break;
                case 'difficulty':
                    sorted.sort((a, b) => a.easeFactor - b.easeFactor);
                    break;
            }
            
            renderCardsList(sorted, currentDetailDeckId);
        }

        // Deck Context Menu
        let editDeckId = null;
        let editSelectedEmoji = 'üìö';
        let editSelectedGradient = 'linear-gradient(135deg, #7b8cff, #9333ea)';

        function toggleDeckMenu(menuId) {
            const allMenus = document.querySelectorAll('.deck-context-menu');
            const targetMenu = document.getElementById(menuId);
            const isOpen = targetMenu.classList.contains('open');
            
            // Close all menus first
            allMenus.forEach(m => m.classList.remove('open'));
            
            // Toggle the clicked one
            if (!isOpen) targetMenu.classList.add('open');
        }

        // Close menus when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.deck-context-menu.open').forEach(m => m.classList.remove('open'));
        });

        // Edit Deck
        function openEditDeckModal(deckId) {
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;

            editDeckId = deckId;
            editSelectedEmoji = deck.icon || 'üìö';
            editSelectedGradient = deck.color || 'linear-gradient(135deg, #7b8cff, #9333ea)';

            document.getElementById('editDeckName').value = deck.name;
            document.getElementById('editDeckDescription').value = deck.description || '';

            // Highlight current emoji
            document.querySelectorAll('#editEmojiPicker .emoji-option').forEach(el => {
                el.classList.toggle('selected', el.textContent.trim() === editSelectedEmoji);
            });

            // Highlight current gradient
            document.querySelectorAll('#editGradientPicker .gradient-option').forEach(el => {
                el.classList.toggle('selected', el.style.background === editSelectedGradient);
            });

            document.getElementById('editDeckModal').classList.add('active');
        }

        function selectEditEmoji(emoji, e) {
            e.stopPropagation();
            editSelectedEmoji = emoji;
            document.querySelectorAll('#editEmojiPicker .emoji-option').forEach(el => el.classList.remove('selected'));
            e.target.classList.add('selected');
        }

        function selectEditGradient(gradient, e) {
            e.stopPropagation();
            editSelectedGradient = gradient;
            document.querySelectorAll('#editGradientPicker .gradient-option').forEach(el => el.classList.remove('selected'));
            e.target.classList.add('selected');
        }

        function updateDeck(e) {
            e.preventDefault();
            const deck = appData.decks.find(d => d.id === editDeckId);
            if (!deck) return;

            deck.name = document.getElementById('editDeckName').value;
            deck.description = document.getElementById('editDeckDescription').value;
            deck.icon = editSelectedEmoji;
            deck.color = editSelectedGradient;

            saveData();
            renderDecks();
            closeModal('editDeckModal');
            showToast(`Deck "${deck.name}" aktualisiert! ‚úÖ`, 'success');
        }

        // Search
        let searchTimeout;
        function handleSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (!query.trim()) {
                    renderDecks();
                    return;
                }
                
                const filtered = appData.decks.map(deck => ({
                    ...deck,
                    cards: deck.cards.filter(card => 
                        card.front.toLowerCase().includes(query.toLowerCase()) ||
                        card.back.toLowerCase().includes(query.toLowerCase())
                    )
                })).filter(deck => deck.cards.length > 0 || deck.name.toLowerCase().includes(query.toLowerCase()));
                
                renderFilteredDecks(filtered);
            }, 300);
        }

        function renderFilteredDecks(decks) {
            const grid = document.getElementById('decksGrid');
            const addCard = grid.querySelector('.add-deck-card');
            
            while (grid.children.length > 1) {
                grid.removeChild(grid.lastChild);
            }
            
            if (decks.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state active';
                empty.innerHTML = `
                    <div class="empty-icon">üîç</div>
                    <div class="empty-title">Keine Ergebnisse</div>
                    <div class="empty-text">Probiere einen anderen Suchbegriff</div>
                `;
                grid.appendChild(empty);
                return;
            }
            
            decks.forEach(deck => {
                const dueCards = getDueCards(deck);
                const masteredCards = deck.cards.filter(c => c.interval >= 7).length;
                const progress = deck.cards.length > 0 ? (masteredCards / deck.cards.length) * 100 : 0;

                const deckCard = document.createElement('div');
                deckCard.className = 'deck-card animate-in';
                deckCard.innerHTML = `
                    <div class="deck-cover" style="background: ${deck.color}">
                        <div style="z-index: 1; font-size: 3em;">${deck.icon}</div>
                    </div>
                    <div class="deck-content">
                        <div class="deck-header">
                            <div class="deck-title" onclick="openDeckDetail('${deck.id}')">${deck.name}</div>
                            <div class="deck-menu-wrapper">
                                <button class="deck-menu-btn" onclick="event.stopPropagation(); toggleDeckMenu('menu-${deck.id}')">‚ãØ</button>
                                <div class="deck-context-menu" id="menu-${deck.id}">
                                    <button class="context-menu-item" onclick="openEditDeckModal('${deck.id}')">‚úèÔ∏è Deck bearbeiten</button>
                                    <button class="context-menu-item" onclick="openDeckDetail('${deck.id}')">üìã Karten anzeigen</button>
                                    <div class="context-menu-separator"></div>
                                    <button class="context-menu-item danger" onclick="deleteDeck('${deck.id}')">üóëÔ∏è Deck l√∂schen</button>
                                </div>
                            </div>
                        </div>
                        <div class="deck-stats">
                            <span>${deck.cards.length} Karten</span>
                            <span>‚Ä¢</span>
                            <span>${dueCards.length} f√§llig</span>
                        </div>
                        <div class="deck-progress">
                            <div class="deck-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div class="deck-actions">
                            <button class="deck-btn primary" onclick="event.stopPropagation(); startLearning('${deck.id}')">
                                ${dueCards.length > 0 ? `üéØ Lernen (${dueCards.length})` : '‚úÖ Alles erledigt'}
                            </button>
                            <button class="deck-btn" onclick="event.stopPropagation(); startLearning('${deck.id}', true)" title="Alle Karten wiederholen">
                                üîÑ
                            </button>
                            <button class="deck-btn" onclick="event.stopPropagation(); openNewCardModal('${deck.id}')">
                                +
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(deckCard);
            });
        }

        // Filter
        function handleFilter(filterType) {
            const query = document.getElementById('searchInput').value;
            if (filterType === 'all') {
                query ? handleSearch(query) : renderDecks();
                return;
            }

            const filtered = appData.decks.map(deck => ({
                ...deck,
                cards: deck.cards.filter(card => {
                    const isDue = !card.nextReview || card.nextReview <= Date.now();
                    const isNew = card.interval === 0;
                    const isMastered = card.interval >= 7;
                    if (filterType === 'due') return isDue;
                    if (filterType === 'new') return isNew;
                    if (filterType === 'mastered') return isMastered;
                    return true;
                })
            })).filter(deck => deck.cards.length > 0);

            renderFilteredDecks(filtered);
        }

        // Learning Mode
        function startLearning(deckId, reviewAll = false) {
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;

            currentDeckId = deckId;
            const cards = reviewAll ? deck.cards : getDueCards(deck);
            
            if (cards.length === 0) {
                showToast(reviewAll ? 'Keine Karten in diesem Deck!' : 'Keine Karten f√§llig! Nutze "Alle wiederholen" zum √úben üéâ', 'success');
                return;
            }

            let sessionCards = [...cards].sort(() => Math.random() - 0.5);
            if (!reviewAll) {
                const maxTotal = appData.settings.maxReviewsPerSession || 100;
                const maxNew = appData.settings.newCardsPerSession || 20;
                const newCards = sessionCards.filter(c => c.interval === 0).slice(0, maxNew);
                const reviewCards = sessionCards.filter(c => c.interval > 0).slice(0, maxTotal - newCards.length);
                sessionCards = [...newCards, ...reviewCards].sort(() => Math.random() - 0.5);
            }
            currentSession.cards = sessionCards;
            currentSession.startTime = Date.now();
            currentSession.correct = 0;
            currentSession.total = 0;
            currentSession.reviewAll = reviewAll;
            currentCardIndex = 0;

            document.getElementById('mainView').style.display = 'none';
            document.getElementById('deckDetailView').classList.remove('active');
            document.getElementById('learningView').classList.add('active');
            
            loadCard();
        }

        function startLearningFromDetail() {
            startLearning(currentDetailDeckId);
        }

        function startReviewAllFromDetail() {
            startLearning(currentDetailDeckId, true);
        }

        function loadCard() {
            const card = currentSession.cards[currentCardIndex];
            if (!card) {
                showCompletion();
                return;
            }

            const mdEnabled = appData.settings.markdownEnabled !== false && typeof marked !== 'undefined';
            
            function renderSide(el, text, imgSrc) {
                el.innerHTML = '';
                const textDiv = document.createElement('div');
                if (mdEnabled) textDiv.innerHTML = marked.parse(text);
                else textDiv.textContent = text;
                el.appendChild(textDiv);
                if (imgSrc) {
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.className = 'card-image';
                    img.alt = 'Karten-Bild';
                    el.appendChild(img);
                }
            }
            renderSide(document.getElementById('cardFront'), card.front, card.frontImage);
            renderSide(document.getElementById('cardBack'), card.back, card.backImage);
            document.getElementById('cardBack').style.display = 'none';
            document.getElementById('cardDivider').style.display = 'none';
            document.getElementById('showAnswerBtn').style.display = 'block';
            document.getElementById('ratingButtons').classList.remove('active');
            if (document.getElementById('keyHint')) document.getElementById('keyHint').style.display = 'none';
            document.getElementById('cardDisplay').classList.remove('flipped');

            updateProgress();
        }

        function showAnswer() {
            document.getElementById('cardBack').style.display = 'block';
            document.getElementById('cardDivider').style.display = 'block';
            document.getElementById('showAnswerBtn').style.display = 'none';
            document.getElementById('ratingButtons').classList.add('active');
            document.getElementById('keyHint').style.display = 'block';
            document.getElementById('cardDisplay').classList.add('flipped');
        }

        function rateCard(rating) {
            const card = currentSession.cards[currentCardIndex];
            const deck = appData.decks.find(d => d.id === currentDeckId);
            const deckCard = deck.cards.find(c => c.id === card.id);

            // SM-2 Algorithm
            let interval;
            let easeFactor = deckCard.easeFactor;

            if (rating < 3) {
                interval = 0;
                easeFactor = Math.max(1.3, easeFactor - 0.2);
            } else if (rating === 3) {
                if (deckCard.interval === 0) {
                    interval = 1;
                } else if (deckCard.interval === 1) {
                    interval = 6;
                } else {
                    interval = Math.round(deckCard.interval * easeFactor);
                }
            } else {
                if (deckCard.interval === 0) {
                    interval = 4;
                } else {
                    interval = Math.round(deckCard.interval * easeFactor * 1.3);
                }
                easeFactor = easeFactor + 0.15;
            }

            deckCard.easeFactor = easeFactor;
            deckCard.interval = interval;
            deckCard.nextReview = Date.now() + (interval * 24 * 60 * 60 * 1000);
            deckCard.reviews.push({
                date: Date.now(),
                rating: rating
            });

            currentSession.total++;
            if (rating >= 3) currentSession.correct++;

            const today = new Date().toDateString();
            if (appData.settings.lastLearned !== today) {
                appData.settings.streak++;
                appData.settings.lastLearned = today;
            }

            saveData();

            currentCardIndex++;
            loadCard();
        }

        function updateProgress() {
            const progress = (currentCardIndex / currentSession.cards.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${currentCardIndex + 1} von ${currentSession.cards.length} Karten`;
        }

        function showCompletion() {
            const duration = Math.round((Date.now() - currentSession.startTime) / 60000);
            const accuracy = currentSession.total > 0 
                ? Math.round((currentSession.correct / currentSession.total) * 100) 
                : 0;

            document.getElementById('completionCards').textContent = currentSession.total;
            document.getElementById('completionTime').textContent = duration + 'm';
            document.getElementById('completionAccuracy').textContent = accuracy + '%';
            
            document.getElementById('cardDisplay').style.display = 'none';
            document.getElementById('showAnswerBtn').style.display = 'none';
            document.getElementById('ratingButtons').classList.remove('active');
            document.getElementById('completionScreen').classList.add('active');

            updateStreak();
            updateStats();
        }

        function exitLearning() {
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('learningView').classList.remove('active');
            document.getElementById('cardDisplay').style.display = 'flex';
            document.getElementById('completionScreen').classList.remove('active');
            
            renderDecks();
        }

        // View Switcher
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Hide stats view unless stats tab
                document.getElementById('statsView').classList.remove('active');
                document.getElementById('decksGrid').style.display = '';
                document.getElementById('emptyState') && (document.getElementById('emptyState').style.display = '');

                const view = btn.dataset.view;
                if (view === 'due-today') {
                    const allDue = appData.decks.map(deck => ({
                        ...deck,
                        cards: getDueCards(deck)
                    })).filter(deck => deck.cards.length > 0);
                    renderFilteredDecks(allDue);
                } else if (view === 'browse') {
                    renderDecks();
                } else if (view === 'stats') {
                    // Hide deck grid, show stats
                    document.getElementById('decksGrid').style.display = 'none';
                    if (document.getElementById('emptyState')) document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('statsView').classList.add('active');
                    renderStats();
                } else {
                    renderDecks();
                }
            });
        });


        // ==========================================
        // STATISTIKEN
        // ==========================================

        function openStatsView() {
            // triggered by onclick, view switcher handles the rest
        }

        function renderStats() {
            const allCards = appData.decks.flatMap(d => d.cards);
            const allReviews = allCards.flatMap(c => (c.reviews || []).map(r => ({ ...r, cardId: c.id })));
            const now = Date.now();
            const dayMs = 86400000;

            // ---- Summary Numbers ----
            const totalReviews = allReviews.length;
            const correctReviews = allReviews.filter(r => r.rating >= 3).length;
            const globalAccuracy = totalReviews > 0 ? Math.round(correctReviews / totalReviews * 100) : 0;
            const mastered = allCards.filter(c => c.interval >= 7).length;

            // Reviews today
            const todayStr = new Date().toDateString();
            const reviewsToday = allReviews.filter(r => new Date(r.date).toDateString() === todayStr).length;

            // Reviews this week
            const weekAgo = now - 7 * dayMs;
            const reviewsWeek = allReviews.filter(r => r.date >= weekAgo).length;

            const summaryEl = document.getElementById('statsSummaryGrid');
            summaryEl.innerHTML = [
                { v: totalReviews, l: 'Wiederholungen gesamt' },
                { v: reviewsToday, l: 'Heute gelernt' },
                { v: reviewsWeek, l: 'Diese Woche' },
                { v: globalAccuracy + '%', l: '√ò Genauigkeit' },
                { v: mastered, l: 'Karten gemeistert' },
                { v: appData.settings.streak || 0, l: 'üî• Streak (Tage)' },
            ].map(s => `
                <div class="stats-summary-card">
                    <div class="stats-summary-value">${s.v}</div>
                    <div class="stats-summary-label">${s.l}</div>
                </div>
            `).join('');

            // ---- Heatmap (16 weeks = 112 days) ----
            const WEEKS = 16;
            const DAYS = WEEKS * 7;
            // Build day map
            const dayMap = {};
            allReviews.forEach(r => {
                const d = new Date(r.date);
                const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                dayMap[key] = (dayMap[key] || 0) + 1;
            });

            // Find max for scaling
            const maxDay = Math.max(1, ...Object.values(dayMap));

            // Start from DAYS ago, align to Sunday
            const startDate = new Date();
            startDate.setHours(0,0,0,0);
            startDate.setDate(startDate.getDate() - DAYS + 1);
            // Roll back to Sunday
            startDate.setDate(startDate.getDate() - startDate.getDay());

            const heatmapEl = document.getElementById('heatmapGrid');
            heatmapEl.innerHTML = '';
            const monthsEl = document.getElementById('heatmapMonths');
            monthsEl.innerHTML = '';

            const monthNames = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            let lastMonth = -1;
            let colCount = 0;

            const cur = new Date(startDate);
            while (cur <= new Date()) {
                const col = document.createElement('div');
                col.className = 'heatmap-col';

                // Month label for first col of month
                const monthLabel = document.createElement('div');
                monthLabel.className = 'heatmap-month-label';
                if (cur.getMonth() !== lastMonth) {
                    monthLabel.textContent = monthNames[cur.getMonth()];
                    lastMonth = cur.getMonth();
                }
                monthsEl.appendChild(monthLabel);

                for (let d = 0; d < 7; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    const key = `${cur.getFullYear()}-${cur.getMonth()}-${cur.getDate()}`;
                    const count = dayMap[key] || 0;
                    if (count > 0) {
                        const level = count >= maxDay * 0.75 ? 4 : count >= maxDay * 0.4 ? 3 : count >= maxDay * 0.15 ? 2 : 1;
                        cell.setAttribute('data-level', level);
                        cell.title = `${cur.toLocaleDateString('de')}: ${count} Karten`;
                    } else {
                        cell.title = cur.toLocaleDateString('de') + ': keine';
                    }
                    col.appendChild(cell);
                    cur.setDate(cur.getDate() + 1);
                }
                heatmapEl.appendChild(col);
                colCount++;
            }

            // ---- Bar Chart: last 14 days ----
            const barEl = document.getElementById('barChart');
            barEl.innerHTML = '';
            const dayLabels = ['So','Mo','Di','Mi','Do','Fr','Sa'];
            let maxBarVal = 1;
            const barData = [];
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() - i);
                const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                const correct = allReviews.filter(r => {
                    const rd = new Date(r.date);
                    return rd.getFullYear() === d.getFullYear() && rd.getMonth() === d.getMonth() && rd.getDate() === d.getDate() && r.rating >= 3;
                }).length;
                const wrong = allReviews.filter(r => {
                    const rd = new Date(r.date);
                    return rd.getFullYear() === d.getFullYear() && rd.getMonth() === d.getMonth() && rd.getDate() === d.getDate() && r.rating < 3;
                }).length;
                const total = correct + wrong;
                maxBarVal = Math.max(maxBarVal, total);
                barData.push({ label: dayLabels[d.getDay()], date: d.getDate(), correct, wrong, total });
            }

            barData.forEach(b => {
                const col = document.createElement('div');
                col.className = 'bar-col';
                const correctH = b.total > 0 ? Math.round((b.correct / maxBarVal) * 100) : 0;
                const wrongH = b.total > 0 ? Math.round((b.wrong / maxBarVal) * 100) : 0;
                col.innerHTML = `
                    ${b.total > 0 ? `<div class="bar-value">${b.total}</div>` : '<div class="bar-value" style="opacity:0">0</div>'}
                    <div style="display:flex;flex-direction:column;justify-content:flex-end;flex:1;width:100%;gap:1px;">
                        ${wrongH > 0 ? `<div class="bar bar-wrong" style="height:${wrongH}px"></div>` : ''}
                        ${correctH > 0 ? `<div class="bar bar-correct" style="height:${correctH}px"></div>` : ''}
                    </div>
                    <div class="bar-label">${b.label}<br>${b.date}.</div>
                `;
                barEl.appendChild(col);
            });

            // ---- Interval Distribution ----
            const buckets = [
                { label: 'Neu (0d)',     min: 0,   max: 0,   color: 'rgba(239,68,68,0.7)' },
                { label: '1‚Äì3 Tage',     min: 1,   max: 3,   color: 'rgba(245,158,11,0.7)' },
                { label: '4‚Äì7 Tage',     min: 4,   max: 7,   color: 'rgba(234,179,8,0.7)' },
                { label: '1‚Äì2 Wochen',   min: 8,   max: 14,  color: 'rgba(16,185,129,0.6)' },
                { label: '2‚Äì4 Wochen',   min: 15,  max: 28,  color: 'rgba(16,185,129,0.8)' },
                { label: '> 4 Wochen',   min: 29,  max: 9999, color: 'rgba(123,140,255,0.9)' },
            ];
            const bucketCounts = buckets.map(b => ({
                ...b,
                count: allCards.filter(c => c.interval >= b.min && c.interval <= b.max).length
            }));
            const maxBucket = Math.max(1, ...bucketCounts.map(b => b.count));
            const intervalEl = document.getElementById('intervalBars');
            intervalEl.innerHTML = bucketCounts.map(b => `
                <div class="interval-row">
                    <div class="interval-label">${b.label}</div>
                    <div class="interval-bar-track">
                        <div class="interval-bar-fill" style="width:${Math.round(b.count/maxBucket*100)}%; background:${b.color};"></div>
                    </div>
                    <div class="interval-count">${b.count}</div>
                </div>
            `).join('');

            // ---- Donut Chart: rating distribution ----
            const ratingCounts = [0, 0, 0, 0]; // ratings 1-4
            allReviews.forEach(r => { if (r.rating >= 1 && r.rating <= 4) ratingCounts[r.rating - 1]++; });
            const total = ratingCounts.reduce((a, b) => a + b, 0) || 1;
            const ratingColors = ['#ef4444', '#f59e0b', '#10b981', '#7b8cff'];
            const ratingLabels = ['‚ùå Nochmal', '„Äú Schwer', '‚úì Gut', '‚ö° Leicht'];

            // Draw SVG donut
            const cx = 50, cy = 50, r = 38, strokeW = 14;
            const circumference = 2 * Math.PI * r;
            let offset = 0;
            let svgPaths = '';
            ratingCounts.forEach((count, i) => {
                const pct = count / total;
                const dash = pct * circumference;
                svgPaths += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none"
                    stroke="${ratingColors[i]}" stroke-width="${strokeW}"
                    stroke-dasharray="${dash} ${circumference - dash}"
                    stroke-dashoffset="${-offset}"
                    transform="rotate(-90 ${cx} ${cy})"
                    style="transition:stroke-dasharray 0.5s ease"/>`;
                offset += dash;
            });
            document.getElementById('donutSvg').innerHTML = svgPaths +
                `<text x="${cx}" y="${cy+5}" text-anchor="middle" fill="var(--text)" font-size="13" font-weight="bold">${globalAccuracy}%</text>`;

            const legendEl = document.getElementById('donutLegend');
            legendEl.innerHTML = ratingLabels.map((l, i) => `
                <div class="donut-legend-item">
                    <div class="donut-dot" style="background:${ratingColors[i]}"></div>
                    <span style="color:var(--text-muted)">${l}</span>
                    <span style="margin-left:auto;font-weight:600">${ratingCounts[i]}</span>
                </div>
            `).join('');

            // ---- Per-Deck Table ----
            const tbody = document.getElementById('deckStatsBody');
            tbody.innerHTML = appData.decks.map(deck => {
                const dReviews = deck.cards.flatMap(c => c.reviews || []);
                const dCorrect = dReviews.filter(r => r.rating >= 3).length;
                const dTotal = dReviews.length;
                const acc = dTotal > 0 ? Math.round(dCorrect / dTotal * 100) : null;
                const due = getDueCards(deck).length;
                const masterCount = deck.cards.filter(c => c.interval >= 7).length;
                const accClass = acc === null ? '' : acc >= 75 ? 'acc-high' : acc >= 50 ? 'acc-mid' : 'acc-low';
                const accText = acc === null ? '<span style="color:var(--text-muted)">‚Äì</span>' :
                    `<span class="accuracy-pill ${accClass}">${acc}%</span>`;
                return `<tr>
                    <td><span style="margin-right:6px">${deck.icon || 'üìö'}</span>${deck.name}</td>
                    <td>${deck.cards.length}</td>
                    <td>${masterCount}</td>
                    <td>${due > 0 ? `<span style="color:var(--warning)">${due}</span>` : '0'}</td>
                    <td>${dTotal}</td>
                    <td>${accText}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:20px">Noch keine Decks</td></tr>';
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Learning Mode Shortcuts
            if (document.getElementById('learningView').classList.contains('active')) {
                if (e.key === ' ' && document.getElementById('showAnswerBtn').style.display !== 'none') {
                    e.preventDefault();
                    showAnswer();
                } else if (document.getElementById('ratingButtons').classList.contains('active')) {
                    if (e.key === '1') rateCard(1);
                    if (e.key === '2') rateCard(2);
                    if (e.key === '3') rateCard(3);
                    if (e.key === '4') rateCard(4);
                }
                if (e.key === 'Escape') exitLearning();
            }
            
            // Global Shortcuts
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openQuickAdd();
            }
            
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                openNewDeckModal();
            }
            
            if (e.key === 'Escape') {
                // Close any open modal
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // ==========================================
        // IMAGE UPLOAD / HANDLING
        // ==========================================
        let pendingImages = { front: null, back: null };
        let pendingEditImages = {};

        function handleImageUpload(side, event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                showToast('Bild zu gro√ü (max. 5 MB)', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                setImagePreview(side, dataUrl);
                if (side.startsWith('edit')) pendingEditImages[side === 'editFront' ? 'front' : 'back'] = dataUrl;
                else pendingImages[side] = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        function loadImageFromUrl(side) {
            const inputId = side + 'ImgUrl';
            const url = document.getElementById(inputId).value.trim();
            if (!url) return;
            setImagePreview(side, url);
            if (side.startsWith('edit')) pendingEditImages[side === 'editFront' ? 'front' : 'back'] = url;
            else pendingImages[side.replace('edit', '').toLowerCase()] = url;
            document.getElementById(inputId).value = '';
        }

        function setImagePreview(side, src) {
            const prefix = side; // e.g. 'front', 'back', 'editFront', 'editBack'
            const preview = document.getElementById(prefix + 'ImgPreview');
            const placeholder = document.getElementById(prefix + 'ImgPlaceholder');
            const removeBtn = document.getElementById(prefix + 'ImgRemove');
            const area = document.getElementById(prefix + 'ImgArea');
            if (!preview) return;
            preview.src = src;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
            removeBtn.style.display = 'inline-block';
            area.classList.add('has-image');
            area.onclick = null; // don't re-trigger file dialog when clicking preview
        }

        function resetImagePreview(side) {
            const preview = document.getElementById(side + 'ImgPreview');
            const placeholder = document.getElementById(side + 'ImgPlaceholder');
            const removeBtn = document.getElementById(side + 'ImgRemove');
            const area = document.getElementById(side + 'ImgArea');
            const fileInput = document.getElementById(side + 'ImgFile');
            if (!preview) return;
            preview.src = '';
            preview.style.display = 'none';
            placeholder.style.display = 'block';
            removeBtn.style.display = 'none';
            area.classList.remove('has-image');
            if (fileInput) fileInput.value = '';
            // Restore click handler
            const fileId = side + 'ImgFile';
            area.onclick = () => document.getElementById(fileId).click();
        }

        function removeCardImage(side, event) {
            event.stopPropagation();
            resetImagePreview(side);
            if (side.startsWith('edit')) {
                pendingEditImages[side === 'editFront' ? 'front' : 'back'] = null;
            } else {
                pendingImages[side] = null;
            }
        }

        // ==========================================
        // BULK IMPORT
        // ==========================================
        function openBulkImport() {
            const select = document.getElementById('bulkDeckSelect');
            select.innerHTML = '<option value="">Deck w√§hlen...</option>';
            appData.decks.forEach(deck => {
                const opt = document.createElement('option');
                opt.value = deck.id;
                opt.textContent = `${deck.icon} ${deck.name}`;
                select.appendChild(opt);
            });
            if (currentDeckId) select.value = currentDeckId;
            document.getElementById('bulkInput').value = '';
            document.getElementById('bulkModal') && document.getElementById('bulkModal').classList.remove('active');
            document.getElementById('bulkImportModal').classList.add('active');
            document.getElementById('bulkInput').focus();

            document.getElementById('bulkInput').oninput = () => {
                const lines = parseBulkInput(document.getElementById('bulkInput').value);
                const preview = document.getElementById('bulkPreview');
                const count = document.getElementById('bulkPreviewCount');
                if (lines.length > 0) {
                    preview.style.display = 'block';
                    count.textContent = `‚úÖ ${lines.length} Karte${lines.length !== 1 ? 'n' : ''} erkannt`;
                    count.style.color = 'var(--success)';
                } else {
                    preview.style.display = 'none';
                }
            };
        }

        function parseBulkInput(text) {
            return text.split('\n')
                .map(line => {
                    const sep = line.includes(' | ') ? ' | ' : line.includes('|') ? '|' : line.includes(';') ? ';' : null;
                    if (!sep) return null;
                    const idx = line.indexOf(sep);
                    const front = line.substring(0, idx).trim();
                    const back = line.substring(idx + sep.length).trim();
                    return front && back ? { front, back } : null;
                })
                .filter(Boolean);
        }

        function executeBulkImport() {
            const deckId = document.getElementById('bulkDeckSelect').value;
            if (!deckId) { showToast('Bitte ein Deck w√§hlen!', 'error'); return; }

            const pairs = parseBulkInput(document.getElementById('bulkInput').value);
            if (pairs.length === 0) { showToast('Keine g√ºltigen Karten gefunden. Format: Frage | Antwort', 'error'); return; }

            const deck = appData.decks.find(d => d.id === deckId);
            pairs.forEach(({ front, back }) => {
                deck.cards.push({
                    id: Date.now() + Math.random(),
                    front, back,
                    reviews: [],
                    nextReview: null,
                    easeFactor: 2.5,
                    interval: 0,
                    created: Date.now()
                });
            });

            saveData();
            renderDecks();
            updateStats();
            if (currentDetailDeckId === deckId) renderDeckDetail(deckId);
            closeModal('bulkImportModal');
            showToast(`${pairs.length} Karten importiert! üéâ`, 'success');
        }

        // ==========================================
        // SETTINGS
        // ==========================================
        function openSettings() {
            document.getElementById('settingNewCards').value = appData.settings.newCardsPerSession || 20;
            document.getElementById('settingMaxReviews').value = appData.settings.maxReviewsPerSession || 100;
            document.getElementById('settingMarkdown').checked = appData.settings.markdownEnabled !== false;
            document.getElementById('settingsModal').classList.add('active');
        }

        function saveSettings() {
            appData.settings.newCardsPerSession = parseInt(document.getElementById('settingNewCards').value) || 20;
            appData.settings.maxReviewsPerSession = parseInt(document.getElementById('settingMaxReviews').value) || 100;
            appData.settings.markdownEnabled = document.getElementById('settingMarkdown').checked;
            saveData();
            closeModal('settingsModal');
            showToast('Einstellungen gespeichert! ‚úÖ', 'success');
        }

        // ==========================================
        // EXPORT / IMPORT
        // ==========================================
        function exportData() {
            const json = JSON.stringify(appData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `karteikarten-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('JSON-Export gespeichert! ‚úÖ', 'success');
        }

        function exportCSV() {
            let csv = 'Deck,Vorderseite,R√ºckseite,Intervall,Wiederholungen\n';
            appData.decks.forEach(deck => {
                deck.cards.forEach(card => {
                    const esc = (s) => `"${String(s).replace(/"/g, '""')}"`;
                    csv += `${esc(deck.name)},${esc(card.front)},${esc(card.back)},${card.interval},${card.reviews.length}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `karteikarten-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV-Export gespeichert! ‚úÖ', 'success');
        }

        function importDataFromFile() {
            document.getElementById('importFileInput').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!imported.decks || !Array.isArray(imported.decks)) {
                        showToast('Ung√ºltige Datei ‚Äì kein g√ºltiger Karteikarten-Export', 'error');
                        return;
                    }
                    if (!confirm(`${imported.decks.length} Deck(s) importieren? Deine aktuellen Daten werden √úBERSCHRIEBEN.`)) return;
                    appData = imported;
                    ensureSettings();
                    saveData();
                    renderDecks();
                    updateStats();
                    updateStreak();
                    closeModal('settingsModal');
                    showToast(`Import erfolgreich: ${imported.decks.length} Deck(s) geladen üéâ`, 'success');
                } catch {
                    showToast('Fehler beim Lesen der Datei', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Initialize on load
        init();

        // Welcome Toast
        setTimeout(() => {
            showToast('Bereit zum Lernen! üöÄ Ctrl+N f√ºr neue Karte', 'success');
        }, 1000);
    </script>
</body>
</html>
