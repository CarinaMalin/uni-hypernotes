<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formelsammlung</title>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
  onload="initApp()"></script>

<style>
  /* â”€â”€ Reset & Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:      #161821;
    --surface: #1e2135;
    --border:  rgba(255,255,255,0.09);
    --text:    #f0f0ff;
    --muted:   rgba(240,240,255,0.45);
    --accent:  #7b8cff;
    --accent2: #a78bfa;
    --danger:  #ef4444;
    --radius:  14px;
  }
  body.light {
    --bg:      #eef0fa;
    --surface: #ffffff;
    --border:  rgba(0,0,0,0.09);
    --text:    #1a1a2e;
    --muted:   rgba(0,0,0,0.45);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
  }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .app {
    display: grid;
    grid-template-columns: 340px 1fr;
    grid-template-rows: 56px 1fr;
    height: 100vh;
    overflow: hidden;
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    grid-column: 1 / -1;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 0 20px;
  }
  header h1 { font-size: 16px; font-weight: 700; flex: 1; }
  header .search {
    flex: 1;
    max-width: 320px;
    padding: 7px 13px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
  }
  header .search::placeholder { color: var(--muted); }
  .topic-pills {
    display: flex;
    gap: 6px;
    flex-wrap: nowrap;
    overflow-x: auto;
    max-width: 400px;
  }
  .topic-pills::-webkit-scrollbar { display: none; }
  .pill-btn {
    padding: 4px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: none;
    color: var(--muted);
    font-size: 12px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
  }
  .pill-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  /* â”€â”€ Sidebar (Eingabe) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 18px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .sidebar h2 { font-size: 13px; font-weight: 700; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.08em; }

  /* â”€â”€ Form inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .field { display: flex; flex-direction: column; gap: 5px; }
  .field label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; }
  .field input, .field textarea, .field select {
    padding: 9px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.15s;
  }
  .field input:focus, .field textarea:focus {
    outline: none;
    border-color: var(--accent);
  }
  .field textarea { min-height: 64px; }

  /* LaTeX toggle */
  .latex-toggle {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    user-select: none;
  }
  .latex-toggle input { accent-color: var(--accent); cursor: pointer; }

  /* LaTeX Live-Vorschau */
  .latex-preview {
    min-height: 40px;
    padding: 10px 14px;
    border-radius: 10px;
    background: var(--bg);
    border: 1px dashed var(--border);
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    overflow-x: auto;
  }
  .latex-preview.has-content { color: var(--text); }
  .latex-preview .katex-error { color: #f87171; font-size: 12px; }

  /* Buttons */
  .btn {
    padding: 10px 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: opacity 0.15s, transform 0.1s;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary { background: var(--accent); color: #fff; width: 100%; }
  .btn-primary:hover { opacity: 0.88; }
  .btn-secondary {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 100%;
    font-weight: 400;
    font-size: 12px;
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .divider { border: none; border-top: 1px solid var(--border); }

  /* â”€â”€ Formel-Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .list {
    padding: 18px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-content: start;
  }

  .formula-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 18px;
    position: relative;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .formula-card:hover {
    border-color: rgba(123,140,255,0.35);
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  }

  .fc-name {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 10px;
  }
  .fc-expr {
    font-size: 20px;
    padding: 10px 0 12px;
    overflow-x: auto;
    text-align: center;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  /* Plain-text Formeln */
  .fc-expr.plain {
    font-family: "Georgia", serif;
    font-size: 17px;
    font-style: italic;
    color: var(--text);
  }
  .fc-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    align-items: center;
  }
  .topic-tag {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 999px;
    background: rgba(123,140,255,0.15);
    color: var(--accent);
    font-size: 11px;
    font-weight: 600;
  }
  .fc-vars {
    font-size: 11px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.5;
  }
  .fc-notes {
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    font-style: italic;
    line-height: 1.5;
  }

  /* Card actions */
  .fc-actions {
    position: absolute;
    top: 12px; right: 12px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .formula-card:hover .fc-actions { opacity: 1; }
  .fc-btn {
    width: 28px; height: 28px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--muted);
    font-size: 13px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.12s, color 0.12s;
  }
  .fc-btn:hover { background: var(--surface); color: var(--text); }
  .fc-btn.del:hover { background: rgba(239,68,68,0.15); color: var(--danger); border-color: var(--danger); }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
  .empty p { font-size: 14px; }

  /* Edit modal */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }
  .modal-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 24px;
    width: 100%;
    max-width: 460px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.7);
  }
  .modal-box h3 { font-size: 15px; font-weight: 700; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; }
  .btn-sm { padding: 8px 16px; border-radius: 9px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; }
  .btn-sm.cancel { background: rgba(255,255,255,0.07); color: var(--muted); }
  .btn-sm.save { background: var(--accent); color: #fff; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 99px; }
</style>
</head>
<body>

<div class="app">

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <h1>âˆ‘ Formelsammlung</h1>
    <input class="search" id="searchInput" type="text" placeholder="Name oder Thema suchenâ€¦">
    <div class="topic-pills" id="topicPills"></div>
  </header>

  <!-- â”€â”€ Sidebar: Neue Formel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="sidebar">
    <h2 id="formSidebarTitle">Neue Formel</h2>

    <div class="field">
      <label>Name</label>
      <input id="fName" type="text" placeholder="z.B. Ideale Gasgleichung">
    </div>

    <div class="field">
      <label>Formel</label>
      <input id="fExpr" type="text" placeholder="z.B. p \cdot V = n \cdot R \cdot T">
      <label class="latex-toggle">
        <input type="checkbox" id="fLatex" checked> LaTeX-Modus
      </label>
    </div>

    <!-- Live-Vorschau -->
    <div class="latex-preview" id="fPreview">Vorschau erscheint hierâ€¦</div>

    <div class="field">
      <label>Thema / Kategorie</label>
      <input id="fTopic" type="text" placeholder="z.B. Thermodynamik">
    </div>

    <div class="field">
      <label>Variablen &amp; Einheiten</label>
      <textarea id="fVars" placeholder="p = Druck [Pa], V = Volumen [mÂ³], â€¦"></textarea>
    </div>

    <div class="field">
      <label>Hinweise</label>
      <textarea id="fNotes" placeholder="Typische Fehler, Herleitungen, â€¦"></textarea>
    </div>

    <button class="btn btn-primary" id="fSaveBtn">ï¼‹ Formel speichern</button>
    <button class="btn btn-secondary" id="fCancelBtn" style="display:none">Abbrechen</button>

    <hr class="divider">

    <button class="btn btn-secondary" id="loadPresetsBtn">ğŸ“¥ Biotech-Basisformeln laden</button>
  </aside>

  <!-- â”€â”€ Formel-Liste â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="list" id="formulaList"></main>

</div>

<!-- Edit-Modal (wird per JS befÃ¼llt) -->
<div class="modal-overlay" id="editModal" style="display:none">
  <div class="modal-box">
    <h3>Formel bearbeiten</h3>
    <div class="field"><label>Name</label><input id="eName" type="text"></div>
    <div class="field">
      <label>Formel</label>
      <input id="eExpr" type="text">
      <label class="latex-toggle"><input type="checkbox" id="eLatex" checked> LaTeX-Modus</label>
    </div>
    <div class="latex-preview" id="ePreview">Vorschau</div>
    <div class="field"><label>Thema</label><input id="eTopic" type="text"></div>
    <div class="field"><label>Variablen</label><textarea id="eVars"></textarea></div>
    <div class="field"><label>Hinweise</label><textarea id="eNotes"></textarea></div>
    <div class="modal-actions">
      <button class="btn-sm cancel" id="eCancelBtn">Abbrechen</button>
      <button class="btn-sm save" id="eSaveBtn">Speichern âœ“</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY = "uniHyperNotes_v3";

function loadData() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
  catch { return {}; }
}
function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function getFormulas() {
  const d = loadData();
  if (!d.formulas) d.formulas = [];
  return d;
}

// â”€â”€ KaTeX render helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLatex(expr, el) {
  try {
    katex.render(expr, el, { throwOnError: false, displayMode: false });
    el.classList.add("has-content");
  } catch(e) {
    el.innerHTML = `<span class="katex-error">Fehler: ${e.message}</span>`;
  }
}

// Versucht LaTeX zu rendern; fÃ¤llt auf plain zurÃ¼ck wenn kein \ vorhanden
function isLatex(expr) {
  return expr && (expr.includes("\\") || expr.includes("^") || expr.includes("_") || expr.includes("{"));
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let filterQuery  = "";
let filterTopic  = "";
let editId       = null;

// â”€â”€ Live-Vorschau â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePreview(exprInput, latexCb, previewEl) {
  const expr = exprInput.value.trim();
  if (!expr) { previewEl.textContent = "Vorschau erscheint hierâ€¦"; previewEl.classList.remove("has-content"); return; }
  if (latexCb.checked) {
    renderLatex(expr, previewEl);
  } else {
    previewEl.textContent = expr;
    previewEl.classList.add("has-content");
  }
}

// â”€â”€ Render list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const data = getFormulas();
  const list = document.getElementById("formulaList");
  const q    = filterQuery.toLowerCase();

  const filtered = data.formulas.filter(f => {
    const matchQ = !q || f.name.toLowerCase().includes(q) || (f.topic || "").toLowerCase().includes(q)
                      || (f.expression || "").toLowerCase().includes(q);
    const matchT = !filterTopic || (f.topic || "").toLowerCase().includes(filterTopic.toLowerCase());
    return matchQ && matchT;
  });

  list.innerHTML = "";

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">âˆ‘</div><p>${
      data.formulas.length === 0
        ? 'Noch keine Formeln gespeichert.<br>FÃ¼ge deine erste Formel links hinzu.'
        : 'Keine Treffer fÃ¼r diese Suche.'
    }</p></div>`;
    return;
  }

  filtered.forEach(f => {
    const card = document.createElement("div");
    card.className = "formula-card";

    // Ausdruck: LaTeX oder plain
    let exprHTML;
    if (isLatex(f.expression)) {
      const exprEl = document.createElement("div");
      exprEl.className = "fc-expr";
      renderLatex(f.expression, exprEl);
      exprHTML = exprEl.outerHTML;
    } else {
      exprHTML = `<div class="fc-expr plain">${escapeHtml(f.expression)}</div>`;
    }

    card.innerHTML = `
      <div class="fc-name">${escapeHtml(f.name)}</div>
      ${exprHTML}
      <div class="fc-meta">
        ${f.topic ? `<span class="topic-tag">${escapeHtml(f.topic)}</span>` : ""}
      </div>
      ${f.variables ? `<div class="fc-vars">ğŸ“ ${escapeHtml(f.variables)}</div>` : ""}
      ${f.notes    ? `<div class="fc-notes">ğŸ’¡ ${escapeHtml(f.notes)}</div>`    : ""}
      <div class="fc-actions">
        <button class="fc-btn" data-edit="${f.id}" title="Bearbeiten">âœï¸</button>
        <button class="fc-btn del" data-del="${f.id}" title="LÃ¶schen">ğŸ—‘</button>
      </div>`;
    list.appendChild(card);
  });

  // Edit / Delete listeners
  list.querySelectorAll("[data-edit]").forEach(btn =>
    btn.addEventListener("click", () => openEditModal(btn.dataset.edit)));
  list.querySelectorAll("[data-del]").forEach(btn =>
    btn.addEventListener("click", () => deleteFormula(btn.dataset.del)));

  renderTopicPills();
}

// â”€â”€ Topic-Pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTopicPills() {
  const data = getFormulas();
  const topics = [...new Set(data.formulas.map(f => f.topic).filter(Boolean))].sort();
  const container = document.getElementById("topicPills");
  container.innerHTML = "";

  const all = document.createElement("button");
  all.className = "pill-btn" + (!filterTopic ? " active" : "");
  all.textContent = "Alle";
  all.addEventListener("click", () => { filterTopic = ""; renderList(); });
  container.appendChild(all);

  topics.forEach(t => {
    const btn = document.createElement("button");
    btn.className = "pill-btn" + (filterTopic === t ? " active" : "");
    btn.textContent = t;
    btn.addEventListener("click", () => { filterTopic = t; renderList(); });
    container.appendChild(btn);
  });
}

// â”€â”€ Add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addFormula() {
  const name  = document.getElementById("fName").value.trim();
  const expr  = document.getElementById("fExpr").value.trim();
  const topic = document.getElementById("fTopic").value.trim();
  const vars  = document.getElementById("fVars").value.trim();
  const notes = document.getElementById("fNotes").value.trim();
  if (!name || !expr) { document.getElementById("fName").focus(); return; }

  const data = getFormulas();
  data.formulas.push({ id: "f-" + Date.now(), name, expression: expr, topic, variables: vars, notes });
  saveData(data);

  // Clear form
  ["fName","fExpr","fTopic","fVars","fNotes"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("fPreview").textContent = "Vorschau erscheint hierâ€¦";
  document.getElementById("fPreview").classList.remove("has-content");

  renderList();
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteFormula(id) {
  if (!confirm("Formel wirklich lÃ¶schen?")) return;
  const data = getFormulas();
  data.formulas = data.formulas.filter(f => f.id !== id);
  saveData(data);
  renderList();
}

// â”€â”€ Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditModal(id) {
  const data = getFormulas();
  const f = data.formulas.find(f => f.id === id);
  if (!f) return;
  editId = id;

  document.getElementById("eName").value  = f.name;
  document.getElementById("eExpr").value  = f.expression;
  document.getElementById("eTopic").value = f.topic || "";
  document.getElementById("eVars").value  = f.variables || "";
  document.getElementById("eNotes").value = f.notes || "";

  const isLtx = isLatex(f.expression);
  document.getElementById("eLatex").checked = isLtx;

  const ePreview = document.getElementById("ePreview");
  if (isLtx) { renderLatex(f.expression, ePreview); }
  else { ePreview.textContent = f.expression; ePreview.classList.add("has-content"); }

  document.getElementById("editModal").style.display = "flex";
}

function saveEdit() {
  const data = getFormulas();
  const f = data.formulas.find(f => f.id === editId);
  if (!f) return;
  f.name       = document.getElementById("eName").value.trim()  || f.name;
  f.expression = document.getElementById("eExpr").value.trim()  || f.expression;
  f.topic      = document.getElementById("eTopic").value.trim();
  f.variables  = document.getElementById("eVars").value.trim();
  f.notes      = document.getElementById("eNotes").value.trim();
  saveData(data);
  closeEditModal();
  renderList();
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
  editId = null;
}

// â”€â”€ Presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRESETS = [
  { name: "Ideale Gasgleichung",      expression: "p \\cdot V = n \\cdot R \\cdot T",              topic: "Allg. Chemie / Gase",        variables: "p = Druck [Pa], V = Volumen [mÂ³], n = Stoffmenge [mol], R = 8{,}314\\,\\text{JÂ·mol}^{-1}\\text{K}^{-1}, T = Temperatur [K]", notes: "Grundformel fÃ¼r ideale Gase. Oft nach p, V, n oder T umstellen." },
  { name: "Arrhenius-Gleichung",       expression: "k = A \\cdot e^{-E_a / (R \\cdot T)}",          topic: "Allg. Chemie / Kinetik",     variables: "k = Geschwindigkeitskonstante, A = Frequenzfaktor, E_a = Aktivierungsenergie [JÂ·molâ»Â¹]", notes: "Beschreibt TemperaturabhÃ¤ngigkeit der Reaktionsgeschwindigkeit." },
  { name: "Lambert-Beer-Gesetz",       expression: "A = \\varepsilon \\cdot c \\cdot l",             topic: "Analytik / Spektroskopie",   variables: "A = Absorption (dimensionslos), Îµ = molarer Extinktionskoeffizient [LÂ·molâ»Â¹Â·cmâ»Â¹], c = Konzentration [mol/L], l = Schichtdicke [cm]", notes: "Standard zur photometrischen Konzentrationsbestimmung." },
  { name: "Henderson-Hasselbalch",     expression: "\\text{pH} = \\text{pK}_a + \\log_{10}\\!\\left(\\frac{[A^-]}{[HA]}\\right)", topic: "Allg. Chemie / SÃ¤ure-Base", variables: "[Aâ»] = konjugierte Base, [HA] = SÃ¤ure", notes: "Wichtig zur Berechnung von PufferlÃ¶sungen." },
  { name: "VerdÃ¼nnungsgleichung",      expression: "c_1 \\cdot V_1 = c_2 \\cdot V_2",              topic: "Allg. Chemie / LÃ¶sungen",    variables: "c [mol/L], V [L]", notes: "Basis beim Ansetzen und VerdÃ¼nnen von LÃ¶sungen." },
  { name: "Stoffmenge",               expression: "n = \\frac{m}{M}",                               topic: "Allg. Chemie / Grundlagen",  variables: "n [mol], m = Masse [g], M = Molare Masse [g/mol]", notes: "Elementare Umrechnung zwischen Masse und Stoffmenge." },
  { name: "Michaelis-Menten",         expression: "v = \\frac{V_{\\max} \\cdot [S]}{K_M + [S]}",   topic: "Biochemie / Enzymkinetik",   variables: "v = Reaktionsgeschwindigkeit, V_max = Maximalgeschwindigkeit, [S] = Substratkonzentration, K_M = Michaelis-Konstante", notes: "K_M entspricht [S] bei v = V_max/2. Lineweaver-Burk-Plot zur grafischen Auswertung." },
  { name: "Nernst-Gleichung",         expression: "E = E^0 - \\frac{RT}{zF} \\ln Q",               topic: "Biochemie / Elektrochemie",  variables: "E = Zellpotential [V], Eâ° = Standardpotential, R = 8,314 JÂ·molâ»Â¹Â·Kâ»Â¹, T [K], z = Anzahl Elektronen, F = 96485 CÂ·molâ»Â¹", notes: "Beschreibt Gleichgewichtspotential bei gegebener Ionenverteilung." },
  { name: "Î”G = Î”H âˆ’ TÂ·Î”S",         expression: "\\Delta G = \\Delta H - T \\cdot \\Delta S",      topic: "Biochemie / Thermodynamik",  variables: "Î”G = freie Enthalpie [kJ/mol], Î”H = Enthalpie [kJ/mol], T [K], Î”S = Entropie [kJÂ·molâ»Â¹Â·Kâ»Â¹]", notes: "Î”G < 0 â†’ spontan. Î”G > 0 â†’ nicht spontan." },
  { name: "Konzentration aus ODâ‚†â‚€â‚€",  expression: "c = \\frac{\\text{OD}_{600}}{\\varepsilon \\cdot l}", topic: "Mikrobiologie / Analytik", variables: "ODâ‚†â‚€â‚€ = optische Dichte bei 600 nm, Îµ = Extinktionskoeffizient, l = Schichtdicke [cm]", notes: "Zur Bestimmung der Bakterienkonzentration (NÃ¤herung)." },

  // â”€â”€ SÃ¤ure-Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "pH-Definition",
    expression: "\\text{pH} = -\\log_{10}[\\text{H}^+]",
    topic: "Allg. Chemie / SÃ¤ure-Base",
    variables: "[Hâº] = Protonenkonzentration [mol/L]",
    notes: "pOH = -log[OHâ»]; pH + pOH = 14 (bei 25 Â°C)." },

  { name: "Ionenprodukt des Wassers",
    expression: "K_w = [\\text{H}^+][\\text{OH}^-] = 10^{-14}",
    topic: "Allg. Chemie / SÃ¤ure-Base",
    variables: "K_w = Ionenprodukt (25 Â°C)",
    notes: "Basis fÃ¼r pH/pOH-Berechnungen. TemperaturabhÃ¤ngig." },

  // â”€â”€ Thermodynamik â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "Î”GÂ° und Gleichgewichtskonstante",
    expression: "\\Delta G^\\circ = -R \\cdot T \\cdot \\ln K",
    topic: "Biochemie / Thermodynamik",
    variables: "Î”GÂ° [J/mol], R = 8,314 JÂ·molâ»Â¹Â·Kâ»Â¹, T [K], K = Gleichgewichtskonstante",
    notes: "K > 1 â†’ Î”GÂ° < 0 â†’ Reaktion lÃ¤uft spontan ab." },

  { name: "Î”G unter Nicht-Standardbedingungen",
    expression: "\\Delta G = \\Delta G^\\circ + R \\cdot T \\cdot \\ln Q",
    topic: "Biochemie / Thermodynamik",
    variables: "Q = Reaktionsquotient (aktueller Zustand), K = Gleichgewichtskonstante",
    notes: "Im Gleichgewicht: Q = K â†’ Î”G = 0." },

  // â”€â”€ Osmose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "Osmotischer Druck (van't Hoff)",
    expression: "\\pi = i \\cdot c \\cdot R \\cdot T",
    topic: "Allg. Chemie / LÃ¶sungen",
    variables: "Ï€ = osmotischer Druck [Pa], i = van't-Hoff-Faktor, c [mol/L], R, T [K]",
    notes: "i = 1 fÃ¼r Nicht-Elektrolyte; i = 2 fÃ¼r vollstÃ¤ndig dissoziierte 1:1-Salze (z.B. NaCl)." },

  // â”€â”€ Enzymkinetik â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "Lineweaver-Burk (Doppelreziproke)",
    expression: "\\frac{1}{v} = \\frac{K_M}{V_{\\max}} \\cdot \\frac{1}{[S]} + \\frac{1}{V_{\\max}}",
    topic: "Biochemie / Enzymkinetik",
    variables: "y-Achsenabschnitt = 1/V_max, Steigung = K_M/V_max, x-Achsenabschnitt = -1/K_M",
    notes: "Linearisierung der Michaelis-Menten-Kurve. AnfÃ¤llig fÃ¼r Messfehler bei kleinen [S]." },

  { name: "Hill-Gleichung (kooperative Bindung)",
    expression: "\\theta = \\frac{[L]^n}{K_d^n + [L]^n}",
    topic: "Biochemie / Enzymkinetik",
    variables: "Î¸ = SÃ¤ttigungsgrad (0â€“1), [L] = Ligandenkonzentration, K_d = Dissoziationskonstante, n = Hill-Koeffizient",
    notes: "n > 1: positiv kooperativ (z.B. HÃ¤moglobin). n = 1: entspricht Michaelis-Menten." },

  // â”€â”€ Mikrobiologie / Wachstum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "Exponentielles Bakterienwachstum",
    expression: "N(t) = N_0 \\cdot e^{\\mu \\cdot t}",
    topic: "Mikrobiologie / Wachstum",
    variables: "N(t) = Zellzahl zum Zeitpunkt t, Nâ‚€ = Startzellzahl, Î¼ = spezifische Wachstumsrate [hâ»Â¹]",
    notes: "Gilt nur in der exponentiellen Phase. Î¼ = ln(2) / t_d." },

  { name: "Verdopplungszeit",
    expression: "t_d = \\frac{\\ln 2}{\\mu} = \\frac{0{,}693}{\\mu}",
    topic: "Mikrobiologie / Wachstum",
    variables: "t_d = Verdopplungszeit [h], Î¼ = spezifische Wachstumsrate [hâ»Â¹]",
    notes: "Aus OD-Messungen: Î¼ = (ln ODâ‚‚ âˆ’ ln ODâ‚) / (tâ‚‚ âˆ’ tâ‚)." },

  // â”€â”€ Analytik / NukleinsÃ¤uren â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "DNA-Konzentration aus Aâ‚‚â‚†â‚€",
    expression: "c_{\\text{dsDNA}} = A_{260} \\times 50\\;\\mu\\text{g/mL}",
    topic: "Analytik / NukleinsÃ¤uren",
    variables: "Aâ‚‚â‚†â‚€ = Absorption bei 260 nm (Schichtdicke 1 cm), Faktor: 50 Î¼g/mL fÃ¼r dsDNA, 33 fÃ¼r ssDNA, 40 fÃ¼r RNA",
    notes: "Aâ‚‚â‚†â‚€/Aâ‚‚â‚ˆâ‚€ â‰ˆ 1,8 fÃ¼r reine DNA; â‰ˆ 2,0 fÃ¼r reine RNA. Niedrigere Werte â†’ Proteinkontamination." },

  { name: "DNA-Schmelztemperatur (NÃ¤herung)",
    expression: "T_m \\approx 81{,}5 + 16{,}6\\,\\log[\\text{Na}^+] + 0{,}41\\cdot(\\%GC) - \\frac{675}{n}",
    topic: "Analytik / NukleinsÃ¤uren",
    variables: "[Naâº] = Salzkonzentration [mol/L], %GC = GC-Gehalt, n = LÃ¤nge des Oligonukleotids [bp]",
    notes: "Einfache NÃ¤herung fÃ¼r kurze Oligos: Tm â‰ˆ 4Â·(G+C) + 2Â·(A+T) Â°C." },

  // â”€â”€ Statistik â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "Standardabweichung (Stichprobe)",
    expression: "s = \\sqrt{\\frac{\\sum_{i=1}^{n}(x_i - \\bar{x})^2}{n-1}}",
    topic: "Statistik / Fehlerrechnung",
    variables: "xáµ¢ = Einzelmesswert, xÌ„ = Mittelwert, n = Anzahl Messungen",
    notes: "Nenner (nâˆ’1): Bessel-Korrektur fÃ¼r Stichproben. FÃ¼r Grundgesamtheit: n im Nenner." },

  { name: "Standardfehler des Mittelwerts",
    expression: "\\text{SE} = \\frac{s}{\\sqrt{n}}",
    topic: "Statistik / Fehlerrechnung",
    variables: "s = Standardabweichung, n = StichprobengrÃ¶ÃŸe",
    notes: "Gibt an, wie genau der Stichprobenmittelwert den wahren Mittelwert schÃ¤tzt." },

  { name: "Variationskoeffizient (CV)",
    expression: "CV = \\frac{s}{\\bar{x}} \\times 100\\,\\%",
    topic: "Statistik / Fehlerrechnung",
    variables: "s = Standardabweichung, xÌ„ = Mittelwert",
    notes: "Relative Streuung. CV < 5 % gilt oft als akzeptabel fÃ¼r Assays." },

  // â”€â”€ RÃ¶ntgenkristallographie â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "Bragg'sche Gleichung",
    expression: "n \\lambda = 2 d \\sin\\theta",
    topic: "Strukturbiologie / Kristallographie",
    variables: "n = Beugungsordnung (ganzzahlig), Î» = WellenlÃ¤nge [m], d = Netzebenenabstand [m], Î¸ = Glanzwinkel",
    notes: "Grundlage der RÃ¶ntgenkristallographie zur StrukturaufklÃ¤rung von Proteinen und DNA." },

  // â”€â”€ Massenwirkungsgesetz â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name: "Massenwirkungsgesetz",
    expression: "K_c = \\frac{[C]^c [D]^d}{[A]^a [B]^b}",
    topic: "Allg. Chemie / Gleichgewicht",
    variables: "FÃ¼r die Reaktion: aA + bB â‡Œ cC + dD; Konzentrationen in [mol/L]",
    notes: "Gilt nur im Gleichgewicht. Feststoffe und reine FlÃ¼ssigkeiten werden nicht berÃ¼cksichtigt." },
];

function loadPresets() {
  const data = getFormulas();
  let added = 0;
  PRESETS.forEach(f => {
    if (!data.formulas.some(ex => ex.name === f.name)) {
      data.formulas.push({ id: "f-" + Date.now() + "-" + Math.random().toString(36).slice(2), ...f });
      added++;
    }
  });
  saveData(data);
  renderList();
  if (added > 0) alert(`${added} Formel(n) hinzugefÃ¼gt âœ“`);
  else alert("Alle Basisformeln sind bereits vorhanden.");
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escapeHtml(s) {
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// â”€â”€ Theme sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncTheme() {
  try {
    const d = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    document.body.classList.toggle("light", d.theme === "light");
  } catch {}
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp() {
  syncTheme();

  // Suche
  document.getElementById("searchInput").addEventListener("input", e => {
    filterQuery = e.target.value;
    renderList();
  });

  // Neue Formel: Live-Vorschau
  const fExpr  = document.getElementById("fExpr");
  const fLatex = document.getElementById("fLatex");
  const fPrev  = document.getElementById("fPreview");
  fExpr.addEventListener("input",  () => updatePreview(fExpr, fLatex, fPrev));
  fLatex.addEventListener("change",() => updatePreview(fExpr, fLatex, fPrev));

  // Speichern
  document.getElementById("fSaveBtn").addEventListener("click", addFormula);
  document.getElementById("fExpr").addEventListener("keydown", e => { if (e.key === "Enter") addFormula(); });

  // Presets
  document.getElementById("loadPresetsBtn").addEventListener("click", loadPresets);

  // Edit-Modal Live-Vorschau
  const eExpr  = document.getElementById("eExpr");
  const eLatex = document.getElementById("eLatex");
  const ePrev  = document.getElementById("ePreview");
  eExpr.addEventListener("input",  () => updatePreview(eExpr, eLatex, ePrev));
  eLatex.addEventListener("change",() => updatePreview(eExpr, eLatex, ePrev));
  document.getElementById("eSaveBtn").addEventListener("click", saveEdit);
  document.getElementById("eCancelBtn").addEventListener("click", closeEditModal);
  document.getElementById("editModal").addEventListener("click", e => {
    if (e.target === document.getElementById("editModal")) closeEditModal();
  });

  // Enter im Edit-Modal speichern
  document.getElementById("editModal").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey && e.target.tagName !== "TEXTAREA") saveEdit();
    if (e.key === "Escape") closeEditModal();
  });

  // Theme-Ã„nderung vom Parent abhÃ¶ren
  window.addEventListener("storage", e => {
    if (e.key === STORAGE_KEY) syncTheme();
  });

  renderList();
}
</script>
</body>
</html>
